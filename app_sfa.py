# è¦‹ç©æ›¸ä½œæˆã‚¢ãƒ—ãƒª
import streamlit as st
import pandas as pd
import datetime
import os
import json
import openpyxl
import traceback
from estimate_excel_writer import write_estimate_to_excel

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="è¦‹ç©æ›¸ä½œæˆã‚¢ãƒ—ãƒª", layout="wide")
st.title("è¦‹ç©æ›¸ä½œæˆã‚¢ãƒ—ãƒª")

# --- ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ ---
USER_CREDENTIALS = {
    "admin": "admin123",
    "guest": "guest456",
}

def login():
    st.subheader("ãƒ­ã‚°ã‚¤ãƒ³")
    username = st.text_input("ãƒ¦ãƒ¼ã‚¶ãƒ¼å")
    password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
    if st.button("ãƒ­ã‚°ã‚¤ãƒ³"):
        if username in USER_CREDENTIALS and USER_CREDENTIALS[username] == password:
            st.session_state["logged_in"] = True
            st.session_state["username"] = username
            st.experimental_rerun()
        else:
            st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™")

# --- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ– ---
if "logged_in" not in st.session_state:
    st.session_state["logged_in"] = False

# å®šæ•°å®šç¾©
ISSUER_LIST = ["é ˆè—¤ ç«œå¹³", "æœ¬é–“ æ¸…æ˜­", "ç‰‡å²¡ å•“æ˜", "é’å±± æ³°", "ä¸­è§’ æ˜å­"]
EXCEL_FILENAME = "è¦‹ç©ç®¡ç†ãƒ‡ãƒ¼ã‚¿.xlsx"
DATA_FOLDER = "data"

# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
def init_session_state():
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’åˆæœŸåŒ–"""
    defaults = {
        "æ˜ç´°ãƒªã‚¹ãƒˆ": [],
        "ç·¨é›†å¯¾è±¡": None,
        "ç™ºè¡Œæ—¥": None,
        "è¦‹ç©No": "",
        "æ¡ˆä»¶å": "",
        "é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å": "",
        "é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…": "",
        "é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å": "",
        "å£²ä¸Šé¡è‡ªå‹•æ›´æ–°": True,
        "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–": "â‘  æ¡ˆä»¶ä¸€è¦§",
        "ç™ºè¡Œè€…å": ISSUER_LIST[0],
        "å‚™è€ƒ": "",
        "ãƒ¡ãƒ¢": "",
        "çŠ¶æ³": "è¦‹ç©ä¸­",
        "å—æ³¨æ—¥": None,
        "ç´å“æ—¥": None,
        "å£²ä¸Šé¡": 0,
        "ä»•å…¥é¡": 0,
        "ç²—åˆ©": 0,
        "ç²—åˆ©ç‡": 0,
        "ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨": False  # ä¿‚æ•°æ©Ÿèƒ½ã®ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
    }
    
    for key, default in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = default

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
@st.cache_resource
def load_data():
    """JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€"""
    try:
        # é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        é¡§å®¢ä¸€è¦§ = load_customers_json()
        é¡§å®¢ä¸€è¦§_df = pd.DataFrame(é¡§å®¢ä¸€è¦§) if é¡§å®¢ä¸€è¦§ else pd.DataFrame(columns=["é¡§å®¢No", "é¡§å®¢ä¼šç¤¾å", "é¡§å®¢éƒ¨ç½²å", "é¡§å®¢æ‹…å½“è€…", "é¡§å®¢ä½æ‰€"])
        
        # æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        æ¡ˆä»¶ä¸€è¦§ = load_all_projects()
        æ¡ˆä»¶ä¸€è¦§_df = pd.DataFrame(æ¡ˆä»¶ä¸€è¦§) if æ¡ˆä»¶ä¸€è¦§ else pd.DataFrame(columns=["è¦‹ç©No", "æ¡ˆä»¶å", "é¡§å®¢ä¼šç¤¾å", "é¡§å®¢éƒ¨ç½²å", "é¡§å®¢æ‹…å½“è€…", "ç™ºè¡Œæ—¥", "å—æ³¨æ—¥", "ç´å“æ—¥", "å£²ä¸Šé¡", "ä»•å…¥é¡", "ç²—åˆ©", "ç²—åˆ©ç‡", "çŠ¶æ³", "ç™ºè¡Œè€…å", "ãƒ¡ãƒ¢"])
        
        # å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        å“åä¸€è¦§ = load_products_json()
        å“åä¸€è¦§_df = pd.DataFrame(å“åä¸€è¦§) if å“åä¸€è¦§ else pd.DataFrame(columns=["å“å", "å˜ä½", "å˜ä¾¡", "å‚™è€ƒ"])
        
        return é¡§å®¢ä¸€è¦§_df, æ¡ˆä»¶ä¸€è¦§_df, å“åä¸€è¦§_df
        
    except Exception as e:
        st.error(f"ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
        return create_empty_dataframes()

def create_empty_dataframes():
    """ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ"""
    é¡§å®¢ä¸€è¦§ = pd.DataFrame(columns=["é¡§å®¢No", "é¡§å®¢ä¼šç¤¾å", "é¡§å®¢éƒ¨ç½²å", "é¡§å®¢æ‹…å½“è€…", "é¡§å®¢ä½æ‰€"])
    æ¡ˆä»¶ä¸€è¦§ = pd.DataFrame(columns=["è¦‹ç©No", "æ¡ˆä»¶å", "é¡§å®¢ä¼šç¤¾å", "é¡§å®¢éƒ¨ç½²å", "é¡§å®¢æ‹…å½“è€…", "ç™ºè¡Œæ—¥", "å—æ³¨æ—¥", "ç´å“æ—¥", "å£²ä¸Šé¡", "ä»•å…¥é¡", "ç²—åˆ©", "ç²—åˆ©ç‡", "çŠ¶æ³", "ç™ºè¡Œè€…å", "ãƒ¡ãƒ¢"])
    å“åä¸€è¦§ = pd.DataFrame(columns=["å“å", "å˜ä½", "å˜ä¾¡", "å‚™è€ƒ"])
    return é¡§å®¢ä¸€è¦§, æ¡ˆä»¶ä¸€è¦§, å“åä¸€è¦§

# JSONé–¢é€£ã®é–¢æ•°
def save_meisai_as_json(è¦‹ç©No, data):
    """æ˜ç´°ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¿®æ­£ç‰ˆï¼‰"""
    try:
        os.makedirs(DATA_FOLDER, exist_ok=True)
        ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, f"{è¦‹ç©No}.json")
        
        # é¡§å®¢æ‹…å½“è€…åã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ­£è¦åŒ–ï¼ˆåŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã«çµ±ä¸€ï¼‰
        é¡§å®¢æ‹…å½“è€… = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…", "")
        æ­£è¦åŒ–é¡§å®¢æ‹…å½“è€… = é¡§å®¢æ‹…å½“è€….replace("ã€€", " ").strip()
        
        # é¡§å®¢ä½æ‰€ã‚’å–å¾—ï¼ˆé¡§å®¢ä¸€è¦§ã‹ã‚‰æ¤œç´¢ï¼‰
        é¡§å®¢ä½æ‰€ = ""
        try:
            é¡§å®¢ä¸€è¦§, _, _ = load_excel_data(EXCEL_FILENAME)
            é¡§å®¢ä¼šç¤¾å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "")
            if é¡§å®¢ä¼šç¤¾å and not é¡§å®¢ä¸€è¦§.empty:
                è©²å½“é¡§å®¢ = é¡§å®¢ä¸€è¦§[é¡§å®¢ä¸€è¦§["é¡§å®¢ä¼šç¤¾å"] == é¡§å®¢ä¼šç¤¾å]
                if not è©²å½“é¡§å®¢.empty:
                    é¡§å®¢ä½æ‰€ = è©²å½“é¡§å®¢.iloc[0].get("é¡§å®¢ä½æ‰€", "")
        except:
            pass
        
        # æ˜ç´°ã‹ã‚‰åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ï¼ˆåˆ†é¡é …ç›®é™¤å¤–ãƒ»æ•°å€¤ãƒã‚§ãƒƒã‚¯å¼·åŒ–ï¼‰
        æ˜ç´°ãƒªã‚¹ãƒˆ = data.get("æ˜ç´°ãƒªã‚¹ãƒˆ", st.session_state.get("æ˜ç´°ãƒªã‚¹ãƒˆ", []))
        æ˜ç´°åˆè¨ˆ = 0
        
        # æ˜ç´°ãƒªã‚¹ãƒˆã®æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ­£è¦åŒ–
        æ­£è¦åŒ–æ˜ç´°ãƒªã‚¹ãƒˆ = []
        for item in æ˜ç´°ãƒªã‚¹ãƒˆ:
            æ­£è¦åŒ–item = item.copy()
            
            # åˆ†é¡é …ç›®ã®å ´åˆã¯æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’0ã«çµ±ä¸€
            if item.get("åˆ†é¡", False):
                æ­£è¦åŒ–item["æ•°é‡"] = 0
                æ­£è¦åŒ–item["å˜ä¾¡"] = 0
                æ­£è¦åŒ–item["é‡‘é¡"] = 0
            else:
                # å•†å“é …ç›®ã®å ´åˆã¯æ•°å€¤ã¨ã—ã¦ç¢ºå®Ÿã«ä¿å­˜
                try:
                    æ­£è¦åŒ–item["æ•°é‡"] = int(item.get("æ•°é‡", 0)) if item.get("æ•°é‡") not in ["", None] else 0
                except (ValueError, TypeError):
                    æ­£è¦åŒ–item["æ•°é‡"] = 0
                
                try:
                    æ­£è¦åŒ–item["å˜ä¾¡"] = float(item.get("å˜ä¾¡", 0)) if item.get("å˜ä¾¡") not in ["", None] else 0
                except (ValueError, TypeError):
                    æ­£è¦åŒ–item["å˜ä¾¡"] = 0
                
                try:
                    æ­£è¦åŒ–item["é‡‘é¡"] = float(item.get("é‡‘é¡", 0)) if item.get("é‡‘é¡") not in ["", None] else 0
                except (ValueError, TypeError):
                    æ­£è¦åŒ–item["é‡‘é¡"] = 0
                
                # æ˜ç´°åˆè¨ˆã«åŠ ç®—ï¼ˆåˆ†é¡é …ç›®ã¯é™¤å¤–ï¼‰
                æ˜ç´°åˆè¨ˆ += æ­£è¦åŒ–item["é‡‘é¡"]
            
            # ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ–‡å­—åˆ—ã¨ã—ã¦ç¢ºå®Ÿã«ä¿å­˜
            æ­£è¦åŒ–item["å“å"] = str(item.get("å“å", ""))
            æ­£è¦åŒ–item["å˜ä½"] = str(item.get("å˜ä½", ""))
            æ­£è¦åŒ–item["å‚™è€ƒ"] = str(item.get("å‚™è€ƒ", ""))
            æ­£è¦åŒ–item["å£²ä¸Šå…ˆéƒ¨ç½²"] = str(item.get("å£²ä¸Šå…ˆéƒ¨ç½²", ""))
            æ­£è¦åŒ–item["åˆ†é¡"] = bool(item.get("åˆ†é¡", False))
            
            æ­£è¦åŒ–æ˜ç´°ãƒªã‚¹ãƒˆ.append(æ­£è¦åŒ–item)
        
        # å£²ä¸Šé¡è‡ªå‹•æ›´æ–°ãŒæœ‰åŠ¹ãªå ´åˆã¯æ˜ç´°åˆè¨ˆã‚’ä½¿ç”¨
        if st.session_state.get("å£²ä¸Šé¡è‡ªå‹•æ›´æ–°", True):
            å£²ä¸Šé¡ = æ˜ç´°åˆè¨ˆ
        else:
            å£²ä¸Šé¡ = st.session_state.get("å£²ä¸Šé¡", æ˜ç´°åˆè¨ˆ)
        
        # ç²—åˆ©ã®å†è¨ˆç®—
        ä»•å…¥é¡ = int(st.session_state.get("ä»•å…¥é¡", 0))
        ç²—åˆ© = å£²ä¸Šé¡ - ä»•å…¥é¡
        ç²—åˆ©ç‡ = (ç²—åˆ© / å£²ä¸Šé¡ * 100) if å£²ä¸Šé¡ > 0 else 0
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚‚æ›´æ–°
        st.session_state["å£²ä¸Šé¡"] = å£²ä¸Šé¡
        st.session_state["ç²—åˆ©"] = ç²—åˆ©
        st.session_state["ç²—åˆ©ç‡"] = ç²—åˆ©ç‡
        
        # è¦‹ç©ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’ä¿å­˜ï¼ˆæ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ­£è¦åŒ–æ¸ˆã¿ï¼‰
        ä¿å­˜ãƒ‡ãƒ¼ã‚¿ = {
            "è¦‹ç©No": str(st.session_state.get("è¦‹ç©No", "")),
            "æ¡ˆä»¶å": str(st.session_state.get("æ¡ˆä»¶å", "")),
            "ç™ºè¡Œæ—¥": str(st.session_state.get("ç™ºè¡Œæ—¥", datetime.date.today())),
            "é¡§å®¢ä¼šç¤¾å": str(st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "")),
            "é¡§å®¢éƒ¨ç½²å": str(st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å", "")),
            "é¡§å®¢æ‹…å½“è€…": æ­£è¦åŒ–é¡§å®¢æ‹…å½“è€…,
            "é¡§å®¢ä½æ‰€": str(é¡§å®¢ä½æ‰€),
            "ç™ºè¡Œè€…å": str(st.session_state.get("ç™ºè¡Œè€…å", "")),
            "æ‹…å½“éƒ¨ç½²": str(st.session_state.get("æ‹…å½“éƒ¨ç½²", "")),
            "å‚™è€ƒ": str(data.get("å‚™è€ƒ", st.session_state.get("å‚™è€ƒ", ""))),
            "æ˜ç´°ãƒªã‚¹ãƒˆ": æ­£è¦åŒ–æ˜ç´°ãƒªã‚¹ãƒˆ,  # æ­£è¦åŒ–æ¸ˆã¿ã®æ˜ç´°ãƒªã‚¹ãƒˆ
            "çŠ¶æ³": str(st.session_state.get("çŠ¶æ³", "è¦‹ç©ä¸­")),
            "å—æ³¨æ—¥": str(st.session_state.get("å—æ³¨æ—¥", "") or ""),
            "ç´å“æ—¥": str(st.session_state.get("ç´å“æ—¥", "") or ""),
            "å£²ä¸Šé¡": int(å£²ä¸Šé¡),
            "ä»•å…¥é¡": int(ä»•å…¥é¡),
            "ç²—åˆ©": int(ç²—åˆ©),
            "ç²—åˆ©ç‡": float(ç²—åˆ©ç‡),
            "ãƒ¡ãƒ¢": str(st.session_state.get("ãƒ¡ãƒ¢", ""))
        }
        
        # ä¸Šæ›¸ãå‡¦ç†ãŒã‚ã‚Œã°å…ˆã«å®Ÿè¡Œ
        ä¸Šæ›¸ãå‡¦ç† = st.session_state.get("ä¸Šæ›¸ãå‡¦ç†")
        if ä¸Šæ›¸ãå‡¦ç† and ä¸Šæ›¸ãå‡¦ç†.get("å®Ÿè¡Œäºˆå®š"):
            æ—§è¦‹ç©No = ä¸Šæ›¸ãå‡¦ç†["æ—§è¦‹ç©No"]
            æ–°è¦‹ç©No = ä¸Šæ›¸ãå‡¦ç†["æ–°è¦‹ç©No"]
            
            if æ—§è¦‹ç©No != æ–°è¦‹ç©No:
                # æ—§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, f"{æ—§è¦‹ç©No}.json")
                try:
                    if os.path.exists(æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹):
                        os.remove(æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹)
                        st.success(f"æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆ{æ—§è¦‹ç©No}ï¼‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                    
                    # ä¸Šæ›¸ãå‡¦ç†ã‚’ã‚¯ãƒªã‚¢
                    del st.session_state["ä¸Šæ›¸ãå‡¦ç†"]
                    
                except Exception as e:
                    st.error(f"æ—§ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼: {e}")
        
        # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
        with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "w", encoding="utf-8") as f:
            json.dump(ä¿å­˜ãƒ‡ãƒ¼ã‚¿, f, ensure_ascii=False, indent=2, default=str)  # default=strã‚’è¿½åŠ 
        
        return True
        
    except Exception as e:
        st.error(f"JSONãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        return False

def safe_date(data, key):
    """æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«å¤‰æ›ã™ã‚‹"""
    try:
        return pd.to_datetime(data[key]).date() if key in data and data[key] else None
    except:
        return None

def auto_load_json_by_estimate_no(è¦‹ç©No, auto_rerun=True): 
    """è¦‹ç©ç•ªå·ã«å¯¾å¿œã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ï¼ˆæ•°å€¤å¤‰æ›å¼·åŒ–ç‰ˆï¼‰"""
    try:
        ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, f"{è¦‹ç©No}.json")
        
        if not os.path.exists(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹):
            st.error(f"JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹}")
            return False

        with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "r", encoding="utf-8") as f:
            data = json.load(f)
        
        if not isinstance(data, dict):
            st.error("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“")
            return False

        # æ˜ç´°ãƒªã‚¹ãƒˆã®æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿®æ­£
        æ˜ç´°ãƒªã‚¹ãƒˆ = data.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
        ä¿®æ­£æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆ = []
        
        for item in æ˜ç´°ãƒªã‚¹ãƒˆ:
            ä¿®æ­£æ¸ˆã¿item = item.copy()
            
            # åˆ†é¡é …ç›®ã®å ´åˆã¯æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’0ã«çµ±ä¸€
            if item.get("åˆ†é¡", False):
                ä¿®æ­£æ¸ˆã¿item["æ•°é‡"] = 0
                ä¿®æ­£æ¸ˆã¿item["å˜ä¾¡"] = 0
                ä¿®æ­£æ¸ˆã¿item["é‡‘é¡"] = 0
            else:
                # å•†å“é …ç›®ã®å ´åˆã¯å®‰å…¨ã«æ•°å€¤å¤‰æ›
                try:
                    æ•°é‡ = item.get("æ•°é‡", 0)
                    if æ•°é‡ == "" or æ•°é‡ is None:
                        ä¿®æ­£æ¸ˆã¿item["æ•°é‡"] = 0
                    else:
                        ä¿®æ­£æ¸ˆã¿item["æ•°é‡"] = int(æ•°é‡)
                except (ValueError, TypeError):
                    ä¿®æ­£æ¸ˆã¿item["æ•°é‡"] = 0
                
                try:
                    å˜ä¾¡ = item.get("å˜ä¾¡", 0)
                    if å˜ä¾¡ == "" or å˜ä¾¡ is None:
                        ä¿®æ­£æ¸ˆã¿item["å˜ä¾¡"] = 0
                    else:
                        ä¿®æ­£æ¸ˆã¿item["å˜ä¾¡"] = float(å˜ä¾¡)
                except (ValueError, TypeError):
                    ä¿®æ­£æ¸ˆã¿item["å˜ä¾¡"] = 0
                
                try:
                    é‡‘é¡ = item.get("é‡‘é¡", 0)
                    if é‡‘é¡ == "" or é‡‘é¡ is None:
                        ä¿®æ­£æ¸ˆã¿item["é‡‘é¡"] = 0
                    else:
                        ä¿®æ­£æ¸ˆã¿item["é‡‘é¡"] = float(é‡‘é¡)
                except (ValueError, TypeError):
                    ä¿®æ­£æ¸ˆã¿item["é‡‘é¡"] = 0
            
            # ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚å®‰å…¨ã«å¤‰æ›
            ä¿®æ­£æ¸ˆã¿item["å“å"] = str(item.get("å“å", ""))
            ä¿®æ­£æ¸ˆã¿item["å˜ä½"] = str(item.get("å˜ä½", ""))
            ä¿®æ­£æ¸ˆã¿item["å‚™è€ƒ"] = str(item.get("å‚™è€ƒ", ""))
            ä¿®æ­£æ¸ˆã¿item["å£²ä¸Šå…ˆéƒ¨ç½²"] = str(item.get("å£²ä¸Šå…ˆéƒ¨ç½²", ""))
            ä¿®æ­£æ¸ˆã¿item["åˆ†é¡"] = bool(item.get("åˆ†é¡", False))
            
            ä¿®æ­£æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆ.append(ä¿®æ­£æ¸ˆã¿item)
        
        # ä¿®æ­£æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆã‚’dataã«åæ˜ 
        data["æ˜ç´°ãƒªã‚¹ãƒˆ"] = ä¿®æ­£æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆ

        # ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã¨æ­£è¦åŒ–
        valid_status = ["è¦‹ç©ä¸­", "å—æ³¨", "ç´å“æ¸ˆ", "è«‹æ±‚æ¸ˆ", "ä¸æ¡ç”¨", "å¤±æ³¨"]
        status = data.get("çŠ¶æ³", "è¦‹ç©ä¸­")
        if status not in valid_status:
            status = "è¦‹ç©ä¸­"

        valid_issuer = ISSUER_LIST
        issuer = data.get("ç™ºè¡Œè€…å", ISSUER_LIST[0])
        if issuer not in valid_issuer:
            issuer = ISSUER_LIST[0]

        # å¿…é ˆæƒ…å ±ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™»éŒ²
        st.session_state["è¦‹ç©No"] = data.get("è¦‹ç©No", "")
        st.session_state["æ¡ˆä»¶å"] = data.get("æ¡ˆä»¶å", "")
        st.session_state["ç™ºè¡Œæ—¥"] = safe_date(data, "ç™ºè¡Œæ—¥") or datetime.date.today()
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å"] = data.get("é¡§å®¢ä¼šç¤¾å", "")
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å"] = data.get("é¡§å®¢éƒ¨ç½²å", "")
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…"] = data.get("é¡§å®¢æ‹…å½“è€…", "")
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€"] = data.get("é¡§å®¢ä½æ‰€", "")
        st.session_state["ç™ºè¡Œè€…å"] = issuer
        st.session_state["æ‹…å½“éƒ¨ç½²"] = data.get("æ‹…å½“éƒ¨ç½²", "")
        st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"] = ä¿®æ­£æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆ  # ä¿®æ­£æ¸ˆã¿ã®æ˜ç´°ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
        st.session_state["å‚™è€ƒ"] = data.get("å‚™è€ƒ", "")
        st.session_state["å£²ä¸Šé¡"] = int(data.get("å£²ä¸Šé¡", 0))
        st.session_state["ä»•å…¥é¡"] = int(data.get("ä»•å…¥é¡", 0))
        st.session_state["ç²—åˆ©"] = int(data.get("ç²—åˆ©", 0))
        st.session_state["ç²—åˆ©ç‡"] = float(data.get("ç²—åˆ©ç‡", 0.0))
        st.session_state["çŠ¶æ³"] = status
        st.session_state["å—æ³¨æ—¥"] = safe_date(data, "å—æ³¨æ—¥")
        st.session_state["ç´å“æ—¥"] = safe_date(data, "ç´å“æ—¥")
        st.session_state["ãƒ¡ãƒ¢"] = data.get("ãƒ¡ãƒ¢", "")
        
        # auto_rerunãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å†å®Ÿè¡Œã‚’åˆ¶å¾¡
        if auto_rerun:
            st.rerun()
        return True
        
    except FileNotFoundError:
        st.error(f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {è¦‹ç©No}.json")
        return False
    except json.JSONDecodeError as e:
        st.error(f"JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
        return False
    except Exception as e:
        st.error(f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return False

# Excelä¿å­˜é–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
def save_to_excel(data, sheet_name, filename=EXCEL_FILENAME):
    """ãƒ‡ãƒ¼ã‚¿ã‚’Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæ”¹å–„ç‰ˆï¼‰"""
    try:
        if os.path.exists(filename):
            # æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            with pd.ExcelFile(filename, engine='openpyxl') as xls:
                # å„ã‚·ãƒ¼ãƒˆã‚’è¾æ›¸ã¨ã—ã¦ä¿å­˜
                sheets = {}
                for name in xls.sheet_names:
                    if name != sheet_name:  # æ›´æ–°å¯¾è±¡ä»¥å¤–ã®ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜
                        sheets[name] = xls.parse(name)
                
                # æ›´æ–°å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
                sheets[sheet_name] = data
            
            # ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒˆã‚’æ›¸ãæˆ»ã™
            with pd.ExcelWriter(filename, engine="openpyxl") as writer:
                for name, df in sheets.items():
                    df.to_excel(writer, sheet_name=name, index=False)
        else:
            # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
            with pd.ExcelWriter(filename, engine="openpyxl") as writer:
                data.to_excel(writer, sheet_name=sheet_name, index=False)
        return True
    except Exception as e:
        st.error(f"Excelä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        return False

# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
def count_same_date_projects_from_json(ç™ºè¡Œæ—¥_str):
    """JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åŒæ—¥æ¡ˆä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰"""
    count = 0
    if os.path.exists(DATA_FOLDER):
        try:
            json_files = [f for f in os.listdir(DATA_FOLDER) if f.endswith('.json')]
            for file in json_files:
                try:
                    ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, file)
                    with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "r", encoding="utf-8") as f:
                        data = json.load(f)
                    
                    if isinstance(data, dict):
                        # ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ç™ºè¡Œæ—¥ã‚’å–å¾—
                        file_ç™ºè¡Œæ—¥ = data.get("ç™ºè¡Œæ—¥", "")
                        
                        # æ—¥ä»˜ã®æ­£è¦åŒ–ï¼ˆç•°ãªã‚‹å½¢å¼ã«å¯¾å¿œï¼‰
                        if isinstance(file_ç™ºè¡Œæ—¥, str):
                            # "2025-03-15" å½¢å¼ã®å ´åˆ
                            if len(file_ç™ºè¡Œæ—¥) == 10 and "-" in file_ç™ºè¡Œæ—¥:
                                try:
                                    file_date = datetime.datetime.strptime(file_ç™ºè¡Œæ—¥, "%Y-%m-%d").date()
                                    file_ç™ºè¡Œæ—¥_str = file_date.strftime('%Y%m%d')
                                except:
                                    continue
                            # "20250315" å½¢å¼ã®å ´åˆ
                            elif len(file_ç™ºè¡Œæ—¥) == 8 and file_ç™ºè¡Œæ—¥.isdigit():
                                file_ç™ºè¡Œæ—¥_str = file_ç™ºè¡Œæ—¥
                            else:
                                continue
                        else:
                            continue
                        
                        # åŒã˜ç™ºè¡Œæ—¥ã‹ãƒã‚§ãƒƒã‚¯
                        if file_ç™ºè¡Œæ—¥_str == ç™ºè¡Œæ—¥_str:
                            count += 1
                            
                except Exception as e:
                    # å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ç¶™ç¶š
                    continue
        except Exception as e:
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ã‚‚ç„¡è¦–
            pass
    
    return count

def generate_estimate_no(ç™ºè¡Œæ—¥):
    """è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆï¼ˆNoneå¯¾å¿œç‰ˆï¼‰"""
    # ç™ºè¡Œæ—¥ãŒNoneã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã‚’è¿”ã™
    if ç™ºè¡Œæ—¥ is None:
        return ""
    
    ç™ºè¡Œæ—¥_str = ç™ºè¡Œæ—¥.strftime('%Y%m%d')
    
    # åŒæ—¥ã®æ—¢å­˜æ¡ˆä»¶æ•°ã‚’æ­£ç¢ºã«ã‚«ã‚¦ãƒ³ãƒˆ
    åŒæ—¥æ¡ˆä»¶æ•° = count_same_date_projects_from_json(ç™ºè¡Œæ—¥_str)
    
    # é€£ç•ªã‚’ç”Ÿæˆï¼ˆæ—¢å­˜æ¡ˆä»¶æ•° + 1ï¼‰
    é€£ç•ª = åŒæ—¥æ¡ˆä»¶æ•° + 1
    
    # è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆ
    è¦‹ç©No = f"{ç™ºè¡Œæ—¥_str}{str(é€£ç•ª).zfill(3)}"
    
    return è¦‹ç©No

def check_estimate_no_exists(è¦‹ç©No):
    """è¦‹ç©ç•ªå·ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
    ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, f"{è¦‹ç©No}.json")
    return os.path.exists(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹)

def generate_unique_estimate_no(ç™ºè¡Œæ—¥):
    """é‡è¤‡ã—ãªã„è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆï¼ˆNoneå¯¾å¿œç‰ˆï¼‰"""
    # ç™ºè¡Œæ—¥ãŒNoneã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã‚’è¿”ã™
    if ç™ºè¡Œæ—¥ is None:
        return ""
    
    ç™ºè¡Œæ—¥_str = ç™ºè¡Œæ—¥.strftime('%Y%m%d')
    
    # é€£ç•ªã‚’1ã‹ã‚‰é–‹å§‹ã—ã¦ã€é‡è¤‡ã—ãªã„ç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
    é€£ç•ª = 1
    while True:
        è¦‹ç©No = f"{ç™ºè¡Œæ—¥_str}{str(é€£ç•ª).zfill(3)}"
        
        # ã“ã®ç•ªå·ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if not check_estimate_no_exists(è¦‹ç©No):
            return è¦‹ç©No
        
        é€£ç•ª += 1
        
        # å®‰å…¨è£…ç½®ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
        if é€£ç•ª > 999:
            # 999ã‚’è¶…ãˆãŸå ´åˆã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
            import time
            timestamp = str(int(time.time()))[-3:]  # æœ«å°¾3æ¡
            return f"{ç™ºè¡Œæ—¥_str}{timestamp}"

def set_customer_selection(é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…, éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2):
    """é¡§å®¢é¸æŠã‚’è¨­å®šï¼ˆä½æ‰€ç´°åˆ†åŒ–å¯¾å¿œãƒ»ä¿®æ­£ç‰ˆï¼‰"""
    æ­£è¦åŒ–é¡§å®¢æ‹…å½“è€… = é¡§å®¢æ‹…å½“è€….replace("ã€€", " ").strip()
    
    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å"] = é¡§å®¢ä¼šç¤¾å
    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å"] = é¡§å®¢éƒ¨ç½²å
    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…"] = æ­£è¦åŒ–é¡§å®¢æ‹…å½“è€…
    st.session_state["é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
    st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€1"] = ä½æ‰€1
    st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€2"] = ä½æ‰€2
    
    # çµ±åˆä½æ‰€ã‚‚è¨­å®šï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
    çµ±åˆä½æ‰€ = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()
    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€"] = çµ±åˆä½æ‰€

def clear_customer_session():
    """é¡§å®¢ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆä½æ‰€ç´°åˆ†åŒ–å¯¾å¿œãƒ»å®Œå…¨ç‰ˆï¼‰"""
    keys_to_clear = [
        # é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±
        "é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å", "é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…",
        "é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·", "é¸æŠã•ã‚ŒãŸä½æ‰€1", "é¸æŠã•ã‚ŒãŸä½æ‰€2", "é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€",
        # å…¥åŠ›ä¸­ã®é¡§å®¢æƒ…å ±
        "å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾åé¸æŠ", "å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾å", "å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…é¸æŠ",
        "å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…", "å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å", 
        "å…¥åŠ›ä¸­_éƒµä¾¿ç•ªå·", "å…¥åŠ›ä¸­_ä½æ‰€1", "å…¥åŠ›ä¸­_ä½æ‰€2", "å…¥åŠ›ä¸­_é¡§å®¢ä½æ‰€",
        # è£œå®Œãƒ»ç·¨é›†é–¢é€£
        "ä½æ‰€è£œå®Œæ¸ˆã¿", "ç·¨é›†ä¸­é¡§å®¢"
    ]
    
    for key in keys_to_clear:
        if key in st.session_state:
            del st.session_state[key]

def clear_customer_input_session():
    """é¡§å®¢å…¥åŠ›ä¸­ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆé¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã¯ä¿æŒãƒ»å®Œå…¨ç‰ˆï¼‰"""
    input_keys_to_clear = [
        # å…¥åŠ›ä¸­ã®é¡§å®¢æƒ…å ±ã®ã¿
        "å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾åé¸æŠ", "å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾å", "å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…é¸æŠ",
        "å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…", "å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å", 
        "å…¥åŠ›ä¸­_éƒµä¾¿ç•ªå·", "å…¥åŠ›ä¸­_ä½æ‰€1", "å…¥åŠ›ä¸­_ä½æ‰€2", "å…¥åŠ›ä¸­_é¡§å®¢ä½æ‰€",
        # è£œå®Œãƒ•ãƒ©ã‚°
        "ä½æ‰€è£œå®Œæ¸ˆã¿"
    ]
    
    for key in input_keys_to_clear:
        if key in st.session_state:
            del st.session_state[key]

# ã‚¿ãƒ–1: é¡§å®¢æƒ…å ±å…¥åŠ›
def render_customer_tab(é¡§å®¢ä¸€è¦§_df):
    """é¡§å®¢æƒ…å ±å…¥åŠ›ã‚¿ãƒ–ã‚’è¡¨ç¤ºï¼ˆJSONãƒ‡ãƒ¼ã‚¿å¯¾å¿œä¿®æ­£ç‰ˆï¼‰"""
    st.header("â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›")
    
    # JSONã‹ã‚‰æœ€æ–°ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    æœ€æ–°é¡§å®¢ãƒ‡ãƒ¼ã‚¿ = load_customers_json()
    
    # DataFrameã«å¤‰æ›ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
    if æœ€æ–°é¡§å®¢ãƒ‡ãƒ¼ã‚¿:
        é¡§å®¢ä¸€è¦§ = pd.DataFrame(æœ€æ–°é¡§å®¢ãƒ‡ãƒ¼ã‚¿)
    else:
        é¡§å®¢ä¸€è¦§ = pd.DataFrame(columns=["é¡§å®¢No", "é¡§å®¢ä¼šç¤¾å", "é¡§å®¢éƒ¨ç½²å", "é¡§å®¢æ‹…å½“è€…", "é¡§å®¢ä½æ‰€", "éƒµä¾¿ç•ªå·", "ä½æ‰€1", "ä½æ‰€2"])
    
    # ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
    ç·¨é›†ä¸­é¡§å®¢ = st.session_state.get("ç·¨é›†ä¸­é¡§å®¢")
    ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ = ç·¨é›†ä¸­é¡§å®¢ is not None
    
    if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
        st.info(f"é¡§å®¢æƒ…å ±ã‚’ç·¨é›†ä¸­: {ç·¨é›†ä¸­é¡§å®¢['é¡§å®¢ä¼šç¤¾å']} - {ç·¨é›†ä¸­é¡§å®¢['é¡§å®¢æ‹…å½“è€…']}")
    
    # ç™»éŒ²æ¸ˆã¿ã®é¡§å®¢æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ï¼‰
    é¸æŠé¡§å®¢ä¼šç¤¾å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "")
    é¸æŠé¡§å®¢éƒ¨ç½²å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å", "")
    é¸æŠé¡§å®¢æ‹…å½“è€… = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…", "")
    
    if é¸æŠé¡§å®¢ä¼šç¤¾å and é¸æŠé¡§å®¢æ‹…å½“è€… and not ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
        st.success("âœ… é¡§å®¢æƒ…å ±ãŒç™»éŒ²æ¸ˆã¿ã§ã™")
        st.write(f"**ä¼šç¤¾å:** {é¸æŠé¡§å®¢ä¼šç¤¾å}")
        st.write(f"**éƒ¨ç½²å:** {é¸æŠé¡§å®¢éƒ¨ç½²å}")
        st.write(f"**æ‹…å½“è€…:** {é¸æŠé¡§å®¢æ‹…å½“è€…}")
        
        # ä½æ‰€ã®è¡¨ç¤ºï¼ˆç´°åˆ†åŒ–å¯¾å¿œï¼‰
        éƒµä¾¿ç•ªå· = st.session_state.get("é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·", "")
        ä½æ‰€1 = st.session_state.get("é¸æŠã•ã‚ŒãŸä½æ‰€1", "")
        ä½æ‰€2 = st.session_state.get("é¸æŠã•ã‚ŒãŸä½æ‰€2", "")
        çµ±åˆä½æ‰€ = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€", "")
        
        if éƒµä¾¿ç•ªå· or ä½æ‰€1 or ä½æ‰€2:
            st.write(f"**ä½æ‰€:** {éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}")
        elif çµ±åˆä½æ‰€:
            st.write(f"**ä½æ‰€:** {çµ±åˆä½æ‰€}")
        else:
            st.write("**ä½æ‰€:** æœªè¨­å®š")
        
        col1, col2 = st.columns(2)
        if col1.button("åˆ¥ã®é¡§å®¢ã‚’ç™»éŒ²", key="customer_change"):
            # é¡§å®¢æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«
            clear_customer_session()
            st.rerun()
        
        if col2.button("**æ¡ˆä»¶æƒ…å ±ã®å…¥åŠ›ã«é€²ã‚€**", type="primary", key="customer_to_project"):
            st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
            st.rerun()
        
        return
    
    # æ–°è¦å…¥åŠ›ã¾ãŸã¯ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
    st.subheader("é¡§å®¢æƒ…å ±ã®å…¥åŠ›")
    
    # ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®åˆæœŸå€¤è¨­å®šï¼ˆæ—§ä½æ‰€ã®ç§»è¡Œå¯¾å¿œï¼‰
    if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
        åˆæœŸ_é¡§å®¢ä¼šç¤¾å = ç·¨é›†ä¸­é¡§å®¢["é¡§å®¢ä¼šç¤¾å"]
        åˆæœŸ_é¡§å®¢éƒ¨ç½²å = ç·¨é›†ä¸­é¡§å®¢.get("é¡§å®¢éƒ¨ç½²å", "")
        åˆæœŸ_é¡§å®¢æ‹…å½“è€… = ç·¨é›†ä¸­é¡§å®¢["é¡§å®¢æ‹…å½“è€…"]
        
        # æ–°å½¢å¼ã®ä½æ‰€ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ—§ä½æ‰€ã‚’åˆ†å‰²
        åˆæœŸ_éƒµä¾¿ç•ªå· = ç·¨é›†ä¸­é¡§å®¢.get("éƒµä¾¿ç•ªå·", "")
        åˆæœŸ_ä½æ‰€1 = ç·¨é›†ä¸­é¡§å®¢.get("ä½æ‰€1", "")
        åˆæœŸ_ä½æ‰€2 = ç·¨é›†ä¸­é¡§å®¢.get("ä½æ‰€2", "")
        
        # æ–°å½¢å¼ã®ä½æ‰€ãŒãªãã€æ—§ä½æ‰€ãŒã‚ã‚‹å ´åˆã¯åˆ†å‰²
        if not (åˆæœŸ_éƒµä¾¿ç•ªå· or åˆæœŸ_ä½æ‰€1 or åˆæœŸ_ä½æ‰€2):
            æ—§ä½æ‰€ = ç·¨é›†ä¸­é¡§å®¢.get("é¡§å®¢ä½æ‰€", "")
            if æ—§ä½æ‰€:
                from estimate_excel_writer import parse_address
                åˆæœŸ_éƒµä¾¿ç•ªå·, åˆæœŸ_ä½æ‰€1, åˆæœŸ_ä½æ‰€2 = parse_address(æ—§ä½æ‰€)
                st.info("æ—§å½¢å¼ã®ä½æ‰€ã‚’æ–°å½¢å¼ã«å¤‰æ›ã—ã¾ã—ãŸ")
    else:
        åˆæœŸ_é¡§å®¢ä¼šç¤¾å = st.session_state.get("å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾å", "")
        åˆæœŸ_é¡§å®¢éƒ¨ç½²å = st.session_state.get("å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å", "")
        åˆæœŸ_é¡§å®¢æ‹…å½“è€… = st.session_state.get("å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…", "")
        åˆæœŸ_éƒµä¾¿ç•ªå· = st.session_state.get("å…¥åŠ›ä¸­_éƒµä¾¿ç•ªå·", "")
        åˆæœŸ_ä½æ‰€1 = st.session_state.get("å…¥åŠ›ä¸­_ä½æ‰€1", "")
        åˆæœŸ_ä½æ‰€2 = st.session_state.get("å…¥åŠ›ä¸­_ä½æ‰€2", "")
    
    # é¡§å®¢ä¼šç¤¾åã®é¸æŠï¼ˆé¡§å®¢ä¸€è¦§ã¨åŒã˜é †ç•ªã§è¡¨ç¤ºï¼‰
    if not é¡§å®¢ä¸€è¦§.empty and "é¡§å®¢ä¼šç¤¾å" in é¡§å®¢ä¸€è¦§.columns:
        # é¡§å®¢ä¸€è¦§ã¨åŒã˜é †ç•ªã§ä¼šç¤¾åã‚’å–å¾—ï¼ˆé¡§å®¢Noé †ï¼‰
        ä¼šç¤¾åãƒªã‚¹ãƒˆ = []
        
        # é¡§å®¢ä¸€è¦§ã‚’ã‚½ãƒ¼ãƒˆï¼ˆé¡§å®¢Noé †ã€ä¼šç¤¾åé †ï¼‰
        ã‚½ãƒ¼ãƒˆæ¸ˆã¿é¡§å®¢ä¸€è¦§ = é¡§å®¢ä¸€è¦§.sort_values(
            by=['é¡§å®¢No', 'é¡§å®¢ä¼šç¤¾å'], 
            na_position='last'
        ).reset_index(drop=True)
        
        # é‡è¤‡ã‚’é™¤å»ã—ã¤ã¤é †ç•ªã‚’ä¿æŒ
        seen = set()
        for _, row in ã‚½ãƒ¼ãƒˆæ¸ˆã¿é¡§å®¢ä¸€è¦§.iterrows():
            ä¼šç¤¾å = row.get('é¡§å®¢ä¼šç¤¾å', '')
            if ä¼šç¤¾å and ä¼šç¤¾å not in seen:
                ä¼šç¤¾åãƒªã‚¹ãƒˆ.append(ä¼šç¤¾å)
                seen.add(ä¼šç¤¾å)
        
        é¡§å®¢ä¼šç¤¾åé¸æŠè‚¢ = ["ï¼ˆæ–°è¦å…¥åŠ›ï¼‰"] + ä¼šç¤¾åãƒªã‚¹ãƒˆ
    else:
        é¡§å®¢ä¼šç¤¾åé¸æŠè‚¢ = ["ï¼ˆæ–°è¦å…¥åŠ›ï¼‰"]
    
    # ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯æ—¢å­˜ã®é¸æŠã‚’å¾©å…ƒ
    if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ and åˆæœŸ_é¡§å®¢ä¼šç¤¾å in é¡§å®¢ä¼šç¤¾åé¸æŠè‚¢:
        åˆæœŸindex = é¡§å®¢ä¼šç¤¾åé¸æŠè‚¢.index(åˆæœŸ_é¡§å®¢ä¼šç¤¾å)
    elif not ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
        å‰å›é¸æŠ_ä¼šç¤¾å = st.session_state.get("å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾åé¸æŠ", "ï¼ˆæ–°è¦å…¥åŠ›ï¼‰")
        if å‰å›é¸æŠ_ä¼šç¤¾å in é¡§å®¢ä¼šç¤¾åé¸æŠè‚¢:
            åˆæœŸindex = é¡§å®¢ä¼šç¤¾åé¸æŠè‚¢.index(å‰å›é¸æŠ_ä¼šç¤¾å)
        else:
            åˆæœŸindex = 0
    else:
        åˆæœŸindex = 0
    
    é¡§å®¢ä¼šç¤¾å_é¸æŠ = st.selectbox(
        "é¡§å®¢ä¼šç¤¾åã‚’é¸æŠ", 
        é¡§å®¢ä¼šç¤¾åé¸æŠè‚¢,
        index=åˆæœŸindex,
        key="é¡§å®¢ä¼šç¤¾åé¸æŠ"
    )
    st.session_state["å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾åé¸æŠ"] = é¡§å®¢ä¼šç¤¾å_é¸æŠ
    
    if é¡§å®¢ä¼šç¤¾å_é¸æŠ == "ï¼ˆæ–°è¦å…¥åŠ›ï¼‰":
        é¡§å®¢ä¼šç¤¾å = st.text_input(
            "æ–°ã—ã„é¡§å®¢ä¼šç¤¾åã‚’å…¥åŠ›", 
            value=åˆæœŸ_é¡§å®¢ä¼šç¤¾å,
            key="æ–°è¦é¡§å®¢ä¼šç¤¾å"
        )
        st.session_state["å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾å"] = é¡§å®¢ä¼šç¤¾å
    else:
        é¡§å®¢ä¼šç¤¾å = é¡§å®¢ä¼šç¤¾å_é¸æŠ
        st.session_state["å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾å"] = é¡§å®¢ä¼šç¤¾å
    
    # æ‹…å½“è€…é¸æŠè‚¢ã®å–å¾—ï¼ˆJSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰
    if not é¡§å®¢ä¸€è¦§.empty and é¡§å®¢ä¼šç¤¾å and "é¡§å®¢æ‹…å½“è€…" in é¡§å®¢ä¸€è¦§.columns:
        ä¼šç¤¾ã®é¡§å®¢ = é¡§å®¢ä¸€è¦§[é¡§å®¢ä¸€è¦§["é¡§å®¢ä¼šç¤¾å"] == é¡§å®¢ä¼šç¤¾å]
        if not ä¼šç¤¾ã®é¡§å®¢.empty:
            æ‹…å½“è€…å€™è£œ = ä¼šç¤¾ã®é¡§å®¢["é¡§å®¢æ‹…å½“è€…"].dropna().unique().tolist()
        else:
            æ‹…å½“è€…å€™è£œ = []
    else:
        æ‹…å½“è€…å€™è£œ = []
    
    æ‹…å½“è€…é¸æŠè‚¢ = ["ï¼ˆæ–°è¦å…¥åŠ›ï¼‰"] + æ‹…å½“è€…å€™è£œ
    
    # ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯æ—¢å­˜ã®é¸æŠã‚’å¾©å…ƒ
    if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ and åˆæœŸ_é¡§å®¢æ‹…å½“è€… in æ‹…å½“è€…é¸æŠè‚¢:
        æ‹…å½“è€…åˆæœŸindex = æ‹…å½“è€…é¸æŠè‚¢.index(åˆæœŸ_é¡§å®¢æ‹…å½“è€…)
    elif not ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
        å‰å›é¸æŠ_æ‹…å½“è€… = st.session_state.get("å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…é¸æŠ", "ï¼ˆæ–°è¦å…¥åŠ›ï¼‰")
        if å‰å›é¸æŠ_æ‹…å½“è€… in æ‹…å½“è€…é¸æŠè‚¢:
            æ‹…å½“è€…åˆæœŸindex = æ‹…å½“è€…é¸æŠè‚¢.index(å‰å›é¸æŠ_æ‹…å½“è€…)
        else:
            æ‹…å½“è€…åˆæœŸindex = 0
    else:
        æ‹…å½“è€…åˆæœŸindex = 0
    
    é¡§å®¢æ‹…å½“è€…_é¸æŠ = st.selectbox(
        "é¡§å®¢æ‹…å½“è€…ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›", 
        æ‹…å½“è€…é¸æŠè‚¢,
        index=æ‹…å½“è€…åˆæœŸindex,
        key="é¡§å®¢æ‹…å½“è€…é¸æŠ"
    )
    st.session_state["å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…é¸æŠ"] = é¡§å®¢æ‹…å½“è€…_é¸æŠ
    
    if é¡§å®¢æ‹…å½“è€…_é¸æŠ == "ï¼ˆæ–°è¦å…¥åŠ›ï¼‰":
        é¡§å®¢æ‹…å½“è€… = st.text_input(
            "æ–°ã—ã„é¡§å®¢æ‹…å½“è€…ã‚’å…¥åŠ›",
            value=åˆæœŸ_é¡§å®¢æ‹…å½“è€…,
            key="æ–°è¦é¡§å®¢æ‹…å½“è€…"
        )
        st.session_state["å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…"] = é¡§å®¢æ‹…å½“è€…
    else:
        é¡§å®¢æ‹…å½“è€… = é¡§å®¢æ‹…å½“è€…_é¸æŠ
        st.session_state["å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…"] = é¡§å®¢æ‹…å½“è€…
    
    # éƒ¨ç½²åã®è‡ªå‹•è£œå®Œï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆï¼‰
    if not ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
        é¡§å®¢éƒ¨ç½²è£œå®Œ = ""
        if é¡§å®¢ä¼šç¤¾å and é¡§å®¢æ‹…å½“è€… and not é¡§å®¢ä¸€è¦§.empty:
            å€™è£œè¡Œ = é¡§å®¢ä¸€è¦§[
                (é¡§å®¢ä¸€è¦§["é¡§å®¢ä¼šç¤¾å"] == é¡§å®¢ä¼šç¤¾å) & 
                (é¡§å®¢ä¸€è¦§["é¡§å®¢æ‹…å½“è€…"] == é¡§å®¢æ‹…å½“è€…)
            ]
            if not å€™è£œè¡Œ.empty:
                é¡§å®¢éƒ¨ç½²è£œå®Œ = å€™è£œè¡Œ.iloc[0].get("é¡§å®¢éƒ¨ç½²å", "")
                if é¡§å®¢éƒ¨ç½²è£œå®Œ and not st.session_state.get("å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å"):
                    st.info("éƒ¨ç½²åã‚’è‡ªå‹•è£œå®Œã—ã¾ã—ãŸ")
                    st.session_state["å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å"] = é¡§å®¢éƒ¨ç½²è£œå®Œ
        
        éƒ¨ç½²ååˆæœŸå€¤ = st.session_state.get("å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å", é¡§å®¢éƒ¨ç½²è£œå®Œ)
    else:
        éƒ¨ç½²ååˆæœŸå€¤ = åˆæœŸ_é¡§å®¢éƒ¨ç½²å
    
    é¡§å®¢éƒ¨ç½²å = st.text_input(
        "é¡§å®¢éƒ¨ç½²å", 
        value=éƒ¨ç½²ååˆæœŸå€¤,
        key="é¡§å®¢éƒ¨ç½²åå…¥åŠ›"
    )
    st.session_state["å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å"] = é¡§å®¢éƒ¨ç½²å
    
    # ä½æ‰€ã®ç´°åˆ†åŒ–å…¥åŠ›
    st.subheader("ä½æ‰€æƒ…å ±")
    
    # ä½æ‰€ã®è‡ªå‹•è£œå®Œï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ï¼‰
    if not ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
        ä½æ‰€è£œå®Œ = {"éƒµä¾¿ç•ªå·": "", "ä½æ‰€1": "", "ä½æ‰€2": ""}
        if é¡§å®¢ä¼šç¤¾å and not é¡§å®¢ä¸€è¦§.empty:
            # é¡§å®¢ä¸€è¦§ã‹ã‚‰ä½æ‰€æƒ…å ±ã‚’å–å¾—ï¼ˆæ—§ä½æ‰€ç§»è¡Œå¯¾å¿œï¼‰
            å€™è£œè¡Œ = é¡§å®¢ä¸€è¦§[é¡§å®¢ä¸€è¦§["é¡§å®¢ä¼šç¤¾å"] == é¡§å®¢ä¼šç¤¾å]
            if not å€™è£œè¡Œ.empty:
                # æ–°ã—ã„å½¢å¼ã®ä½æ‰€æƒ…å ±ã‚’å„ªå…ˆ
                ä½æ‰€è£œå®Œ["éƒµä¾¿ç•ªå·"] = å€™è£œè¡Œ.iloc[0].get("éƒµä¾¿ç•ªå·", "")
                ä½æ‰€è£œå®Œ["ä½æ‰€1"] = å€™è£œè¡Œ.iloc[0].get("ä½æ‰€1", "")
                ä½æ‰€è£œå®Œ["ä½æ‰€2"] = å€™è£œè¡Œ.iloc[0].get("ä½æ‰€2", "")
                
                # æ—§å½¢å¼ã®ä½æ‰€ãŒã‚ã‚‹å ´åˆã¯åˆ†å‰²ã‚’è©¦è¡Œ
                if not any(ä½æ‰€è£œå®Œ.values()):
                    æ—§ä½æ‰€ = å€™è£œè¡Œ.iloc[0].get("é¡§å®¢ä½æ‰€", "")
                    if æ—§ä½æ‰€:
                        from estimate_excel_writer import parse_address
                        éƒµä¾¿ç•ªå·_parsed, ä½æ‰€1_parsed, ä½æ‰€2_parsed = parse_address(æ—§ä½æ‰€)
                        ä½æ‰€è£œå®Œ["éƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·_parsed
                        ä½æ‰€è£œå®Œ["ä½æ‰€1"] = ä½æ‰€1_parsed
                        ä½æ‰€è£œå®Œ["ä½æ‰€2"] = ä½æ‰€2_parsed
                
                # è£œå®ŒãŒã‚ã‚‹å ´åˆã¯æƒ…å ±ã‚’è¡¨ç¤º
                if any(ä½æ‰€è£œå®Œ.values()):
                    # åˆå›è£œå®Œæ™‚ã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    if not st.session_state.get("ä½æ‰€è£œå®Œæ¸ˆã¿"):
                        st.info("ä½æ‰€æƒ…å ±ã‚’è‡ªå‹•è£œå®Œã—ã¾ã—ãŸ")
                        st.session_state["ä½æ‰€è£œå®Œæ¸ˆã¿"] = True
                    
                    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¸ã®è‡ªå‹•è¨­å®šï¼ˆæ—¢ã«å€¤ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„ï¼‰
                    for key, value in ä½æ‰€è£œå®Œ.items():
                        if value and not st.session_state.get(f"å…¥åŠ›ä¸­_{key}"):
                            st.session_state[f"å…¥åŠ›ä¸­_{key}"] = value
    
    col1, col2 = st.columns(2)
    
    with col1:
        éƒµä¾¿ç•ªå· = st.text_input(
            "éƒµä¾¿ç•ªå·", 
            value=st.session_state.get("å…¥åŠ›ä¸­_éƒµä¾¿ç•ªå·", åˆæœŸ_éƒµä¾¿ç•ªå·),
            placeholder="ä¾‹: 123-4567",
            key="éƒµä¾¿ç•ªå·å…¥åŠ›"
        )
        st.session_state["å…¥åŠ›ä¸­_éƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
    
    with col2:
        ä½æ‰€1 = st.text_input(
            "ä½æ‰€1ï¼ˆéƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ°ï¼‰", 
            value=st.session_state.get("å…¥åŠ›ä¸­_ä½æ‰€1", åˆæœŸ_ä½æ‰€1),
            placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒºç¥å±±ç”º9ç•ª2å·",
            key="ä½æ‰€1å…¥åŠ›"
        )
        st.session_state["å…¥åŠ›ä¸­_ä½æ‰€1"] = ä½æ‰€1
    
    ä½æ‰€2 = st.text_input(
        "ä½æ‰€2ï¼ˆå»ºç‰©åãƒ»éšæ•°ãƒ»å·å®¤ãªã©ï¼‰â€»ä»»æ„", 
        value=st.session_state.get("å…¥åŠ›ä¸­_ä½æ‰€2", åˆæœŸ_ä½æ‰€2),
        placeholder="ä¾‹: ã€‡ã€‡ãƒ“ãƒ«3éšï¼ˆå»ºç‰©åãŒãªã„å ´åˆã¯ç©ºæ¬„ã§OKï¼‰",
        key="ä½æ‰€2å…¥åŠ›"
    )
    st.session_state["å…¥åŠ›ä¸­_ä½æ‰€2"] = ä½æ‰€2
    
    # åŒä¸€ä¼šç¤¾ã®ä½æ‰€ä¸€æ‹¬æ›´æ–°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã¤æ—¢å­˜ä¼šç¤¾ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰
    åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–° = False
    if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ and not é¡§å®¢ä¸€è¦§.empty and é¡§å®¢ä¼šç¤¾å in é¡§å®¢ä¸€è¦§["é¡§å®¢ä¼šç¤¾å"].values:
        åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–° = st.checkbox(
            f"ğŸ¢ åŒä¸€ä¼šç¤¾ã€Œ{é¡§å®¢ä¼šç¤¾å}ã€ã®å…¨æ‹…å½“è€…ã®ä½æ‰€ã‚’ä¸€æ‹¬æ›´æ–°ã™ã‚‹",
            value=False,
            key="åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–°",
            help="ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€ã“ã®ä¼šç¤¾ã®å…¨æ‹…å½“è€…ã®ä½æ‰€ãŒåŒã˜ä½æ‰€ã«æ›´æ–°ã•ã‚Œã¾ã™"
        )
        
        if åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–°:
            st.warning("âš ï¸ ã“ã®ä¼šç¤¾ã®å…¨æ‹…å½“è€…ã®ä½æ‰€ãŒæ›´æ–°ã•ã‚Œã¾ã™")
    
    st.divider()
    
    # ç™»éŒ²ãƒœã‚¿ãƒ³ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
            if st.button("é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹", key="customer_update"):
                if not é¡§å®¢ä¼šç¤¾å or not é¡§å®¢æ‹…å½“è€…:
                    st.warning("é¡§å®¢ä¼šç¤¾åã¨æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                else:
                    success, message = update_customer_in_json(
                        ç·¨é›†ä¸­é¡§å®¢, é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…, 
                        éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2, åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–°
                    )
                    if success:
                        st.success(message)
                        st.session_state["ç·¨é›†ä¸­é¡§å®¢"] = None
                        clear_customer_session()
                        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¤ é¡§å®¢ä¸€è¦§"
                        st.rerun()
                    else:
                        st.error(message)
        else:
            if st.button("é¡§å®¢æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹", key="customer_register"):
                if not é¡§å®¢ä¼šç¤¾å or not é¡§å®¢æ‹…å½“è€…:
                    st.warning("é¡§å®¢ä¼šç¤¾åã¨æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                else:
                    register_customer(é¡§å®¢ä¸€è¦§, é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…, éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2)
    
    with col2:
        if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
            if st.button("ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key="customer_cancel_edit"):
                st.session_state["ç·¨é›†ä¸­é¡§å®¢"] = None
                clear_customer_session()
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¤ é¡§å®¢ä¸€è¦§"
                st.rerun()
        else:
            # é¡§å®¢æƒ…å ±ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ç™»éŒ²ãªã—ã§ã‚‚æ¬¡ã«é€²ã‚ã‚‹
            if é¡§å®¢ä¼šç¤¾å and é¡§å®¢æ‹…å½“è€…:
                if st.button("**æ¡ˆä»¶æƒ…å ±ã®å…¥åŠ›ã«é€²ã‚€**", type="primary", key="customer_to_project_direct"):
                    # ä¸€æ™‚çš„ã«é¡§å®¢æƒ…å ±ã‚’è¨­å®š
                    çµ±åˆä½æ‰€ = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()
                    
                    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å"] = é¡§å®¢ä¼šç¤¾å
                    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å"] = é¡§å®¢éƒ¨ç½²å
                    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…"] = é¡§å®¢æ‹…å½“è€…
                    st.session_state["é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
                    st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€1"] = ä½æ‰€1
                    st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€2"] = ä½æ‰€2
                    st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€"] = çµ±åˆä½æ‰€
                    
                    st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                    st.rerun()
            else:
                st.button("**æ¡ˆä»¶æƒ…å ±ã®å…¥åŠ›ã«é€²ã‚€**", disabled=True, help="é¡§å®¢ä¼šç¤¾åã¨æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", key="customer_to_project_disabled")
    
    with col3:
        if ç·¨é›†ãƒ¢ãƒ¼ãƒ‰:
            if st.button("é¡§å®¢ä¸€è¦§ã«æˆ»ã‚‹", key="back_to_customer_list"):
                st.session_state["ç·¨é›†ä¸­é¡§å®¢"] = None
                clear_customer_session()
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¤ é¡§å®¢ä¸€è¦§"
                st.rerun()

def register_customer(é¡§å®¢ä¸€è¦§_df, é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…, éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2):
    """é¡§å®¢æƒ…å ±ã‚’JSONã«ç™»éŒ²ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒç‰ˆï¼‰"""
    success, message = add_customer_to_json(é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…, éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2)
    
    if success:
        # æ–°è¦ç™»éŒ²æˆåŠŸæ™‚
        st.success(f"âœ… é¡§å®¢æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã—ãŸ")
        # é¡§å®¢æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«è¨­å®šï¼ˆçµ±åˆä½æ‰€ã‚‚å«ã‚€ï¼‰
        çµ±åˆä½æ‰€ = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()
        
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å"] = é¡§å®¢ä¼šç¤¾å
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å"] = é¡§å®¢éƒ¨ç½²å
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…"] = é¡§å®¢æ‹…å½“è€…
        st.session_state["é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
        st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€1"] = ä½æ‰€1
        st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€2"] = ä½æ‰€2
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€"] = çµ±åˆä½æ‰€
        
        # å…¥åŠ›ä¸­ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆé¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã¯ä¿æŒï¼‰
        clear_customer_input_session()
        
        # ã‚¿ãƒ–ã¯ç§»å‹•ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ç§»å‹•ï¼‰
        st.info("ğŸ’¡ ä¸‹ã®ã€Œæ¡ˆä»¶æƒ…å ±ã®å…¥åŠ›ã«é€²ã‚€ã€ãƒœã‚¿ãƒ³ã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚“ã§ãã ã•ã„ã€‚")
        # st.rerun() ã‚’å‰Šé™¤ - è‡ªå‹•rerunã‚’å›é¿
    else:
        if "æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™" in message:
            # æ—¢å­˜é¡§å®¢ã®å ´åˆ
            st.info(f"â„¹ï¸ é¡§å®¢æƒ…å ±ãŒç™»éŒ²æ¸ˆã¿ã§ã™")
            # æ—¢å­˜é¡§å®¢ã®å ´åˆã‚‚æƒ…å ±ã‚’è¨­å®šï¼ˆçµ±åˆä½æ‰€ã‚‚å«ã‚€ï¼‰
            çµ±åˆä½æ‰€ = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()
            
            st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å"] = é¡§å®¢ä¼šç¤¾å
            st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å"] = é¡§å®¢éƒ¨ç½²å
            st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…"] = é¡§å®¢æ‹…å½“è€…
            st.session_state["é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
            st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€1"] = ä½æ‰€1
            st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€2"] = ä½æ‰€2
            st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€"] = çµ±åˆä½æ‰€
            
            # å…¥åŠ›ä¸­ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆé¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã¯ä¿æŒï¼‰
            clear_customer_input_session()
            
            # ã‚¿ãƒ–ã¯ç§»å‹•ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ç§»å‹•ï¼‰
            st.info("ğŸ’¡ ä¸‹ã®ã€Œæ¡ˆä»¶æƒ…å ±ã®å…¥åŠ›ã«é€²ã‚€ã€ãƒœã‚¿ãƒ³ã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚“ã§ãã ã•ã„ã€‚")
            # st.rerun() ã‚’å‰Šé™¤ - è‡ªå‹•rerunã‚’å›é¿
        else:
            st.error(f"âŒ {message}")
    
    return é¡§å®¢ä¸€è¦§_df

def update_customer_in_json(å…ƒé¡§å®¢ãƒ‡ãƒ¼ã‚¿, é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…, éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2, åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–°=False):
    """é¡§å®¢æƒ…å ±ã‚’JSONã§æ›´æ–°ï¼ˆåŒä¸€ä¼šç¤¾ä½æ‰€ä¸€æ‹¬æ›´æ–°å¯¾å¿œï¼‰"""
    try:
        customers = load_customers_json()
        
        # å…ƒã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
        updated_count = 0
        for i, customer in enumerate(customers):
            if (customer.get("é¡§å®¢ä¼šç¤¾å") == å…ƒé¡§å®¢ãƒ‡ãƒ¼ã‚¿["é¡§å®¢ä¼šç¤¾å"] and 
                customer.get("é¡§å®¢éƒ¨ç½²å") == å…ƒé¡§å®¢ãƒ‡ãƒ¼ã‚¿.get("é¡§å®¢éƒ¨ç½²å", "") and 
                customer.get("é¡§å®¢æ‹…å½“è€…") == å…ƒé¡§å®¢ãƒ‡ãƒ¼ã‚¿["é¡§å®¢æ‹…å½“è€…"]):
                
                # é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ä»¥å¤–ï¼‰
                if é¡§å®¢ä¼šç¤¾å != å…ƒé¡§å®¢ãƒ‡ãƒ¼ã‚¿["é¡§å®¢ä¼šç¤¾å"] or é¡§å®¢æ‹…å½“è€… != å…ƒé¡§å®¢ãƒ‡ãƒ¼ã‚¿["é¡§å®¢æ‹…å½“è€…"]:
                    for j, other_customer in enumerate(customers):
                        if (i != j and 
                            other_customer.get("é¡§å®¢ä¼šç¤¾å") == é¡§å®¢ä¼šç¤¾å and 
                            other_customer.get("é¡§å®¢éƒ¨ç½²å") == é¡§å®¢éƒ¨ç½²å and 
                            other_customer.get("é¡§å®¢æ‹…å½“è€…") == é¡§å®¢æ‹…å½“è€…):
                            return False, "åŒã˜é¡§å®¢æƒ…å ±ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
                
                # ä¼šç¤¾åãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®é¡§å®¢Noå†è¨ˆç®—
                if é¡§å®¢ä¼šç¤¾å != å…ƒé¡§å®¢ãƒ‡ãƒ¼ã‚¿["é¡§å®¢ä¼šç¤¾å"]:
                    åŒä¸€ä¼šç¤¾ã®é¡§å®¢ = [c for c in customers if c.get("é¡§å®¢ä¼šç¤¾å") == é¡§å®¢ä¼šç¤¾å and customers.index(c) != i]
                    if åŒä¸€ä¼šç¤¾ã®é¡§å®¢:
                        é¡§å®¢No = åŒä¸€ä¼šç¤¾ã®é¡§å®¢[0].get("é¡§å®¢No", 1)
                    else:
                        existing_companies = list(set([c.get("é¡§å®¢ä¼šç¤¾å") for c in customers if customers.index(c) != i]))
                        é¡§å®¢No = len(existing_companies) + 1
                else:
                    é¡§å®¢No = customer.get("é¡§å®¢No", 1)
                
                # é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ï¼ˆä½æ‰€ç´°åˆ†åŒ–å¯¾å¿œï¼‰
                customers[i]["é¡§å®¢No"] = é¡§å®¢No
                customers[i]["é¡§å®¢ä¼šç¤¾å"] = é¡§å®¢ä¼šç¤¾å
                customers[i]["é¡§å®¢éƒ¨ç½²å"] = é¡§å®¢éƒ¨ç½²å
                customers[i]["é¡§å®¢æ‹…å½“è€…"] = é¡§å®¢æ‹…å½“è€…
                customers[i]["éƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
                customers[i]["ä½æ‰€1"] = ä½æ‰€1
                customers[i]["ä½æ‰€2"] = ä½æ‰€2
                customers[i]["æ›´æ–°æ—¥"] = datetime.date.today().strftime("%Y-%m-%d")
                
                # æ—§ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ–°ä½æ‰€ã§æ›´æ–°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
                çµ±åˆä½æ‰€ = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()
                customers[i]["é¡§å®¢ä½æ‰€"] = çµ±åˆä½æ‰€
                
                updated_count += 1
                break
        
        # åŒä¸€ä¼šç¤¾ä½æ‰€ä¸€æ‹¬æ›´æ–°ã®å‡¦ç†
        if åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–° and updated_count > 0:
            åŒä¸€ä¼šç¤¾é¡§å®¢æ•° = 0
            for customer in customers:
                if customer.get("é¡§å®¢ä¼šç¤¾å") == é¡§å®¢ä¼šç¤¾å:
                    customer["éƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
                    customer["ä½æ‰€1"] = ä½æ‰€1
                    customer["ä½æ‰€2"] = ä½æ‰€2
                    customer["æ›´æ–°æ—¥"] = datetime.date.today().strftime("%Y-%m-%d")
                    # æ—§ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
                    çµ±åˆä½æ‰€ = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()
                    customer["é¡§å®¢ä½æ‰€"] = çµ±åˆä½æ‰€
                    åŒä¸€ä¼šç¤¾é¡§å®¢æ•° += 1
        
        if updated_count == 0:
            return False, "æ›´æ–°å¯¾è±¡ã®é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        
        # é¡§å®¢Noã¨ä¼šç¤¾åã§è‡ªå‹•ä¸¦ã³æ›¿ãˆ
        customers.sort(key=lambda x: (x.get("é¡§å®¢No", 999), x.get("é¡§å®¢ä¼šç¤¾å", ""), x.get("é¡§å®¢æ‹…å½“è€…", "")))
        
        if save_customers_json(customers):
            if åŒä¸€ä¼šç¤¾ä½æ‰€æ›´æ–°:
                return True, f"é¡§å®¢ã€Œ{é¡§å®¢ä¼šç¤¾å}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚åŒä¸€ä¼šç¤¾{åŒä¸€ä¼šç¤¾é¡§å®¢æ•°}åã®ä½æ‰€ã‚‚ä¸€æ‹¬æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚"
            else:
                return True, f"é¡§å®¢ã€Œ{é¡§å®¢ä¼šç¤¾å}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
        else:
            return False, "é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
        
    except Exception as e:
        return False, f"æ›´æ–°å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"

# ã‚¿ãƒ–2: æ¡ˆä»¶æƒ…å ±å…¥åŠ›ï¼ˆJSONå°‚ç”¨ç‰ˆï¼‰
def search_json_projects(é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…):
    """JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ¡ˆä»¶ã‚’æ¤œç´¢ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰"""
    
    # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è©²å½“ã™ã‚‹æ¡ˆä»¶ã‚’æ¤œç´¢
    è©²å½“æ¡ˆä»¶ãƒªã‚¹ãƒˆ = []
    
    if not os.path.exists(DATA_FOLDER):
        st.info("è©²å½“ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦å…¥åŠ›ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
        return
    
    try:
        json_files = [f for f in os.listdir(DATA_FOLDER) if f.endswith('.json')]
    except Exception:
        st.info("ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–°è¦å…¥åŠ›ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
        return
    
    if not json_files:
        st.info("è©²å½“ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦å…¥åŠ›ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
        return
    
    # JSONæ¤œç´¢å‡¦ç†
    for file in json_files:
        try:
            ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, file)
            with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "r", encoding="utf-8") as f:
                data = json.load(f)
            
            if isinstance(data, dict):
                # é¡§å®¢æƒ…å ±ã®å–å¾—ã¨æ­£è¦åŒ–
                file_é¡§å®¢ä¼šç¤¾å = data.get("é¡§å®¢ä¼šç¤¾å", "").strip()
                file_é¡§å®¢æ‹…å½“è€… = data.get("é¡§å®¢æ‹…å½“è€…", "").strip()
                
                # ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦æ¯”è¼ƒ
                å…¥åŠ›_é¡§å®¢ä¼šç¤¾å_clean = é¡§å®¢ä¼šç¤¾å.replace(" ", "").replace("ã€€", "")
                å…¥åŠ›_é¡§å®¢æ‹…å½“è€…_clean = é¡§å®¢æ‹…å½“è€….replace(" ", "").replace("ã€€", "")
                file_é¡§å®¢ä¼šç¤¾å_clean = file_é¡§å®¢ä¼šç¤¾å.replace(" ", "").replace("ã€€", "")
                file_é¡§å®¢æ‹…å½“è€…_clean = file_é¡§å®¢æ‹…å½“è€….replace(" ", "").replace("ã€€", "")
                
                # ä¸€è‡´åˆ¤å®š
                ä¼šç¤¾ä¸€è‡´ = file_é¡§å®¢ä¼šç¤¾å_clean == å…¥åŠ›_é¡§å®¢ä¼šç¤¾å_clean
                æ‹…å½“è€…ä¸€è‡´ = file_é¡§å®¢æ‹…å½“è€…_clean == å…¥åŠ›_é¡§å®¢æ‹…å½“è€…_clean
                
                if ä¼šç¤¾ä¸€è‡´ and æ‹…å½“è€…ä¸€è‡´:
                    # æ˜ç´°ã‹ã‚‰åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
                    æ˜ç´°åˆè¨ˆ = sum(item.get("é‡‘é¡", 0) for item in data.get("æ˜ç´°ãƒªã‚¹ãƒˆ", []))
                    å£²ä¸Šé¡ = data.get("å£²ä¸Šé¡", 0) if data.get("å£²ä¸Šé¡", 0) > 0 else æ˜ç´°åˆè¨ˆ
                    
                    è©²å½“æ¡ˆä»¶ãƒªã‚¹ãƒˆ.append({
                        "è¦‹ç©No": data.get("è¦‹ç©No", ""),
                        "æ¡ˆä»¶å": data.get("æ¡ˆä»¶å", "æ¡ˆä»¶åæœªè¨­å®š"),
                        "ç™ºè¡Œæ—¥": data.get("ç™ºè¡Œæ—¥", ""),
                        "çŠ¶æ³": data.get("çŠ¶æ³", "è¦‹ç©ä¸­"),
                        "å£²ä¸Šé¡": å£²ä¸Šé¡
                    })
                    
        except Exception as e:
            continue
    
    # çµæœã®è¡¨ç¤º
    if not è©²å½“æ¡ˆä»¶ãƒªã‚¹ãƒˆ:
        st.info("è©²å½“ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦å…¥åŠ›ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
        return
    
    # æ¡ˆä»¶ã‚’ç™ºè¡Œæ—¥é †ã§ã‚½ãƒ¼ãƒˆ
    è©²å½“æ¡ˆä»¶ãƒªã‚¹ãƒˆ.sort(key=lambda x: x["ç™ºè¡Œæ—¥"], reverse=True)
    
    # æ¡ˆä»¶é¸æŠãƒªã‚¹ãƒˆã®ä½œæˆï¼ˆè©³ç´°æƒ…å ±ä»˜ãï¼‰
    æ¡ˆä»¶è¡¨ç¤ºãƒªã‚¹ãƒˆ = []
    æ¡ˆä»¶è¾æ›¸ = {}
    for æ¡ˆä»¶ in è©²å½“æ¡ˆä»¶ãƒªã‚¹ãƒˆ:
        # è¡¨ç¤ºå½¢å¼: æ¡ˆä»¶å (è¦‹ç©No) - Â¥é‡‘é¡ [çŠ¶æ³]
        è¡¨ç¤ºå = f"{æ¡ˆä»¶['æ¡ˆä»¶å']} ({æ¡ˆä»¶['è¦‹ç©No']}) - Â¥{æ¡ˆä»¶['å£²ä¸Šé¡']:,} [{æ¡ˆä»¶['çŠ¶æ³']}]"
        æ¡ˆä»¶è¡¨ç¤ºãƒªã‚¹ãƒˆ.append(è¡¨ç¤ºå)
        æ¡ˆä»¶è¾æ›¸[è¡¨ç¤ºå] = æ¡ˆä»¶
    
    # æ¡ˆä»¶é¸æŠ
    æ¡ˆä»¶é¸æŠ = st.selectbox("æ¡ˆä»¶ã‚’é¸æŠ", [""] + æ¡ˆä»¶è¡¨ç¤ºãƒªã‚¹ãƒˆ, key="json_project_select")

    if æ¡ˆä»¶é¸æŠ:
        é¸æŠæ¡ˆä»¶ = æ¡ˆä»¶è¾æ›¸[æ¡ˆä»¶é¸æŠ]
        è¦‹ç©Noå€™è£œ = é¸æŠæ¡ˆä»¶["è¦‹ç©No"]

        # JSONåæ˜ ãƒœã‚¿ãƒ³
        if st.button("ğŸ”„ JSONã‚’åæ˜ ã™ã‚‹"):
            æˆåŠŸ = auto_load_json_by_estimate_no(è¦‹ç©Noå€™è£œ, auto_rerun=True)
            if æˆåŠŸ:
                st.success(f"{è¦‹ç©Noå€™è£œ} ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸ")
            else:
                st.error("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")

def handle_new_project_input():
    """æ–°è¦æ¡ˆä»¶å…¥åŠ›ã®å‡¦ç†ï¼ˆNoneå¯¾å¿œç‰ˆï¼‰"""
    æ¡ˆä»¶å = st.text_input("æ¡ˆä»¶å", value=st.session_state.get("æ¡ˆä»¶å", ""))
    st.session_state["æ¡ˆä»¶å"] = æ¡ˆä»¶å
    
    # è¦‹ç©ç•ªå·ã®ç”Ÿæˆï¼ˆç™ºè¡Œæ—¥ãŒNoneã§ãªã„å ´åˆã®ã¿ï¼‰
    if not st.session_state.get("è¦‹ç©No"):
        ç™ºè¡Œæ—¥ = st.session_state.get("ç™ºè¡Œæ—¥")
        if ç™ºè¡Œæ—¥ is not None:  # Noneãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
            st.session_state["è¦‹ç©No"] = generate_estimate_no(ç™ºè¡Œæ—¥)
        # ç™ºè¡Œæ—¥ãŒNoneã®å ´åˆã¯è¦‹ç©ç•ªå·ã‚‚ç©ºã®ã¾ã¾

def render_project_tab():
    """æ¡ˆä»¶æƒ…å ±å…¥åŠ›ã‚¿ãƒ–ã‚’è¡¨ç¤ºï¼ˆJSONå°‚ç”¨ãƒ»æ¡ˆä»¶ä¸€è¦§ãªã—ãƒ»é¡§å®¢ãƒã‚§ãƒƒã‚¯ä¿®æ­£ç‰ˆï¼‰"""
    st.header("â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›")
    
    # é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
    é¡§å®¢ä¼šç¤¾å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "")
    é¡§å®¢éƒ¨ç½²å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å", "")
    é¡§å®¢æ‹…å½“è€… = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…", "")
    
    # é¡§å®¢æƒ…å ±ãƒã‚§ãƒƒã‚¯ã®æ¡ä»¶ã‚’ç·©å’Œï¼ˆä¼šç¤¾åã¨æ‹…å½“è€…ãŒã‚ã‚Œã°ååˆ†ï¼‰
    if not é¡§å®¢ä¼šç¤¾å or not é¡§å®¢æ‹…å½“è€…:
        st.warning("é¡§å®¢æƒ…å ±ãŒä¸å®Œå…¨ã§ã™ã€‚é¡§å®¢ä¼šç¤¾åã¨æ‹…å½“è€…ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
        if st.button("é¡§å®¢æƒ…å ±å…¥åŠ›ã«æˆ»ã‚‹"):
            st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
            st.rerun()
        return
    
    # é¡§å®¢æƒ…å ±ã®è¡¨ç¤ºï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
    st.success("âœ… é¡§å®¢æƒ…å ±ãŒè¨­å®šæ¸ˆã¿ã§ã™")
    
    # é¡§å®¢æƒ…å ±ã‚’è¦‹ã‚„ã™ãè¡¨ç¤º
    customer_col1, customer_col2, customer_col3 = st.columns(3)
    with customer_col1:
        st.text_input("é¡§å®¢ä¼šç¤¾å", é¡§å®¢ä¼šç¤¾å, disabled=True, key="display_company")
    with customer_col2:
        st.text_input("é¡§å®¢éƒ¨ç½²å", é¡§å®¢éƒ¨ç½²å or "ï¼ˆæœªè¨­å®šï¼‰", disabled=True, key="display_dept")
    with customer_col3:
        st.text_input("é¡§å®¢æ‹…å½“è€…", é¡§å®¢æ‹…å½“è€…, disabled=True, key="display_contact")
    
    # é¡§å®¢æƒ…å ±å¤‰æ›´ãƒœã‚¿ãƒ³
    if st.button("ğŸ”„ é¡§å®¢æƒ…å ±ã‚’å¤‰æ›´", key="change_customer"):
        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
        st.rerun()
    
    st.divider()
    
    # æ¡ˆä»¶å…¥åŠ›æ–¹æ³•ã®é¸æŠ
    æ¡ˆä»¶å…¥åŠ›æ–¹æ³• = st.radio("æ¡ˆä»¶ã®å…¥åŠ›æ–¹æ³•", ["æ–°è¦å…¥åŠ›", "æ—¢å­˜æ¡ˆä»¶ã‚’é¸æŠ"])
    
    if æ¡ˆä»¶å…¥åŠ›æ–¹æ³• == "æ—¢å­˜æ¡ˆä»¶ã‚’é¸æŠ":
        # JSONå°‚ç”¨ã®æ¡ˆä»¶æ¤œç´¢ï¼ˆæ¡ˆä»¶ä¸€è¦§ã‚’æ¸¡ã•ãªã„ï¼‰
        search_json_projects(é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…)
        
        # æ—¢å­˜æ¡ˆä»¶ã‚’é¸æŠã—ãŸå ´åˆã§ã‚‚æ¡ˆä»¶åã‚’ç·¨é›†å¯èƒ½ã«ã™ã‚‹
        st.subheader("æ¡ˆä»¶æƒ…å ±ã®ç·¨é›†")
        æ¡ˆä»¶å = st.text_input("æ¡ˆä»¶å", value=st.session_state.get("æ¡ˆä»¶å", ""), key="existing_project_name")
        st.session_state["æ¡ˆä»¶å"] = æ¡ˆä»¶å
    else:
        handle_new_project_input()
    
    # å…±é€šã®å…¥åŠ›é …ç›®ï¼ˆæ¡ˆä»¶ä¸€è¦§ã‚’æ¸¡ã•ãªã„ï¼‰
    render_common_project_inputs()

def get_max_sequence_for_date(ç™ºè¡Œæ—¥_str):
    """æŒ‡å®šæ—¥ä»˜ã®æ—¢å­˜è¦‹ç©ç•ªå·ã‹ã‚‰æœ€å¤§é€£ç•ªã‚’å–å¾—"""
    max_sequence = 0
    
    if not os.path.exists(DATA_FOLDER):
        return max_sequence
    
    try:
        json_files = [f for f in os.listdir(DATA_FOLDER) if f.endswith('.json')]
        
        for file in json_files:
            try:
                # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰è¦‹ç©ç•ªå·ã‚’æŠ½å‡ºï¼ˆæ‹¡å¼µå­ã‚’é™¤ãï¼‰
                è¦‹ç©No = file.replace('.json', '')
                
                # è¦‹ç©ç•ªå·ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆYYYYMMDDXXXï¼‰
                if len(è¦‹ç©No) == 11 and è¦‹ç©No[:8] == ç™ºè¡Œæ—¥_str and è¦‹ç©No[8:].isdigit():
                    sequence = int(è¦‹ç©No[8:])  # æœ«å°¾3æ¡ã‚’å–å¾—
                    max_sequence = max(max_sequence, sequence)
                
                # JSONãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ç™ºè¡Œæ—¥ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¨ä¸ä¸€è‡´ã®å ´åˆã«å‚™ãˆã¦ï¼‰
                ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, file)
                with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "r", encoding="utf-8") as f:
                    data = json.load(f)
                
                if isinstance(data, dict):
                    file_ç™ºè¡Œæ—¥ = data.get("ç™ºè¡Œæ—¥", "")
                    file_è¦‹ç©No = data.get("è¦‹ç©No", "")
                    
                    # ç™ºè¡Œæ—¥ã®æ­£è¦åŒ–
                    if isinstance(file_ç™ºè¡Œæ—¥, str):
                        if len(file_ç™ºè¡Œæ—¥) == 10 and "-" in file_ç™ºè¡Œæ—¥:
                            try:
                                file_date = datetime.datetime.strptime(file_ç™ºè¡Œæ—¥, "%Y-%m-%d").date()
                                file_ç™ºè¡Œæ—¥_str = file_date.strftime('%Y%m%d')
                            except:
                                continue
                        elif len(file_ç™ºè¡Œæ—¥) == 8 and file_ç™ºè¡Œæ—¥.isdigit():
                            file_ç™ºè¡Œæ—¥_str = file_ç™ºè¡Œæ—¥
                        else:
                            continue
                        
                        # åŒã˜ç™ºè¡Œæ—¥ã§è¦‹ç©ç•ªå·ãŒæ­£ã—ã„å½¢å¼ã®å ´åˆ
                        if (file_ç™ºè¡Œæ—¥_str == ç™ºè¡Œæ—¥_str and 
                            len(file_è¦‹ç©No) == 11 and 
                            file_è¦‹ç©No[:8] == ç™ºè¡Œæ—¥_str and 
                            file_è¦‹ç©No[8:].isdigit()):
                            sequence = int(file_è¦‹ç©No[8:])
                            max_sequence = max(max_sequence, sequence)
                            
            except Exception:
                continue
                
    except Exception:
        pass
    
    return max_sequence

def generate_next_estimate_no(ç™ºè¡Œæ—¥):
    """æŒ‡å®šæ—¥ä»˜ã®æ¬¡ã®è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆï¼ˆNoneå¯¾å¿œç‰ˆï¼‰"""
    # ç™ºè¡Œæ—¥ãŒNoneã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã‚’è¿”ã™
    if ç™ºè¡Œæ—¥ is None:
        return ""
    
    ç™ºè¡Œæ—¥_str = ç™ºè¡Œæ—¥.strftime('%Y%m%d')
    
    # æ—¢å­˜ã®æœ€å¤§é€£ç•ªã‚’å–å¾—
    max_sequence = get_max_sequence_for_date(ç™ºè¡Œæ—¥_str)
    
    # æ¬¡ã®é€£ç•ªã‚’ç”Ÿæˆ
    next_sequence = max_sequence + 1
    
    # è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆ
    è¦‹ç©No = f"{ç™ºè¡Œæ—¥_str}{str(next_sequence).zfill(3)}"
    
    return è¦‹ç©No

def update_estimate_number_and_overwrite(æ—§è¦‹ç©No, æ–°è¦‹ç©No):
    """è¦‹ç©ç•ªå·ã‚’æ›´æ–°ã—ã¦æ—§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"""
    try:
        æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, f"{æ—§è¦‹ç©No}.json")
        æ–°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, f"{æ–°è¦‹ç©No}.json")
        
        # æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
        if os.path.exists(æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹):
            # æ—§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            os.remove(æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹)
            return True
        return False
        
    except Exception as e:
        st.error(f"ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
        return False
        
def render_common_project_inputs():
    """å…±é€šã®æ¡ˆä»¶å…¥åŠ›é …ç›®ã‚’è¡¨ç¤ºï¼ˆè¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªå¯¾å¿œç‰ˆãƒ»ã‚¿ãƒ–çŠ¶æ…‹ä¿æŒå¼·åŒ–ï¼‰"""
    
    # åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    st.subheader("åŸºæœ¬æƒ…å ±")
    
    # è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‡¦ç†
    è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹ = st.session_state.get("è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹")
    if è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹:
        st.info("ğŸ“‹ è¦‹ç©ç•ªå·ã®è¨­å®šç¢ºèª")
        st.write(f"**ç™ºè¡Œæ—¥:** {è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹['ç™ºè¡Œæ—¥']}")
        st.write(f"**è¦‹ç©No.ã‚’ {è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']} ã«è¨­å®šã—ã¾ã™**")
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("âœ… OK", key="confirm_generate_estimate_no", type="primary"):
                # è¦‹ç©ç•ªå·ã‚’ç¢ºå®š
                st.session_state["è¦‹ç©No"] = è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']
                st.session_state["ç™ºè¡Œæ—¥"] = è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹['ç™ºè¡Œæ—¥']
                
                # ç¢ºèªçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                del st.session_state["è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹"]
                
                # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã‹ã‚‰rerun
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                st.success(f"âœ… è¦‹ç©No.ã‚’ {è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']} ã«è¨­å®šã—ã¾ã—ãŸ")
                st.rerun()
        
        with col2:
            if st.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key="cancel_generate_estimate_no"):
                # ç™ºè¡Œæ—¥ã‚’å…ƒã«æˆ»ã™
                st.session_state["ç™ºè¡Œæ—¥"] = è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹['å…ƒç™ºè¡Œæ—¥']
                
                # ç¢ºèªçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                del st.session_state["è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹"]
                
                # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã‹ã‚‰rerun
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                st.info("ç™ºè¡Œæ—¥ã‚’é¸ã³ç›´ã—ã¦ãã ã•ã„")
                st.rerun()
        
        # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ˜ç¤ºçš„ã«è¡¨ç¤º
        render_sidebar_status()
        
        # ç¢ºèªä¸­ã¯ä»–ã®å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
        st.stop()

    # ä¸Šæ›¸ãç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
    ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹ = st.session_state.get("ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹")
    if ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹:
        st.error("âš ï¸ è¦‹ç©ç•ªå·ã®å¤‰æ›´ç¢ºèª")
        st.write(f"**ç™ºè¡Œæ—¥å¤‰æ›´:** {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§ç™ºè¡Œæ—¥']} â†’ {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°ç™ºè¡Œæ—¥']}")
        st.write(f"**è¦‹ç©ç•ªå·å¤‰æ›´:** {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§è¦‹ç©No']} â†’ {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']}")
        st.warning("æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆ{0}ï¼‰ã¯å‰Šé™¤ã•ã‚Œã€æ–°ã—ã„è¦‹ç©ç•ªå·ï¼ˆ{1}ï¼‰ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚".format(
            ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§è¦‹ç©No'], ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']
        ))
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("âœ… ã¯ã„ã€ä¸Šæ›¸ãã—ã¾ã™", key="confirm_overwrite", type="primary"):
                # ä¸Šæ›¸ãå‡¦ç†ã‚’å®Ÿè¡Œ
                st.session_state["è¦‹ç©No"] = ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']
                st.session_state["ç™ºè¡Œæ—¥"] = ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°ç™ºè¡Œæ—¥']
                
                # ä¸Šæ›¸ãå‡¦ç†ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                st.session_state["ä¸Šæ›¸ãå‡¦ç†"] = {
                    "æ—§è¦‹ç©No": ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§è¦‹ç©No'],
                    "æ–°è¦‹ç©No": ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No'],
                    "å®Ÿè¡Œäºˆå®š": True
                }
                
                # ç¢ºèªçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                del st.session_state["ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹"]
                
                # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã‹ã‚‰rerun
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                st.success(f"è¦‹ç©ç•ªå·ã‚’ {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']} ã«å¤‰æ›´ã—ã¾ã—ãŸ")
                st.info("æ¬¡å›ä¿å­˜æ™‚ã«æ—§ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™")
                st.rerun()
        
        with col2:
            if st.button("âŒ ã„ã„ãˆã€å…ƒã«æˆ»ã—ã¾ã™", key="cancel_overwrite"):
                # ç™ºè¡Œæ—¥ã‚’å…ƒã«æˆ»ã™
                st.session_state["ç™ºè¡Œæ—¥"] = ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§ç™ºè¡Œæ—¥']
                
                # ç¢ºèªçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                del st.session_state["ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹"]
                
                # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã‹ã‚‰rerun
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                st.info("ç™ºè¡Œæ—¥ã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
                st.rerun()
        
        # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ˜ç¤ºçš„ã«è¡¨ç¤º
        render_sidebar_status()
        
        # ä¸Šæ›¸ãç¢ºèªä¸­ã¯ä»–ã®å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
        st.stop()

    # ä¸Šæ›¸ãç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‡¦ç†ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ç¶­æŒç‰ˆï¼‰
    ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹ = st.session_state.get("ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹")
    if ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹:
        st.error("âš ï¸ è¦‹ç©ç•ªå·ã®å¤‰æ›´ç¢ºèª")
        st.write(f"**ç™ºè¡Œæ—¥å¤‰æ›´:** {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§ç™ºè¡Œæ—¥']} â†’ {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°ç™ºè¡Œæ—¥']}")
        st.write(f"**è¦‹ç©ç•ªå·å¤‰æ›´:** {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§è¦‹ç©No']} â†’ {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']}")
        st.warning("æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆ{0}ï¼‰ã¯å‰Šé™¤ã•ã‚Œã€æ–°ã—ã„è¦‹ç©ç•ªå·ï¼ˆ{1}ï¼‰ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚".format(
            ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§è¦‹ç©No'], ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']
        ))
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("âœ… ã¯ã„ã€ä¸Šæ›¸ãã—ã¾ã™", key="confirm_overwrite", type="primary"):
                # ä¸Šæ›¸ãå‡¦ç†ã‚’å®Ÿè¡Œ
                st.session_state["è¦‹ç©No"] = ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']
                st.session_state["ç™ºè¡Œæ—¥"] = ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°ç™ºè¡Œæ—¥']
                
                # ä¸Šæ›¸ãå‡¦ç†ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                st.session_state["ä¸Šæ›¸ãå‡¦ç†"] = {
                    "æ—§è¦‹ç©No": ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§è¦‹ç©No'],
                    "æ–°è¦‹ç©No": ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No'],
                    "å®Ÿè¡Œäºˆå®š": True
                }
                
                # ç¢ºèªçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                del st.session_state["ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹"]
                
                # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã‹ã‚‰rerun
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                st.success(f"è¦‹ç©ç•ªå·ã‚’ {ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ–°è¦‹ç©No']} ã«å¤‰æ›´ã—ã¾ã—ãŸ")
                st.info("æ¬¡å›ä¿å­˜æ™‚ã«æ—§ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™")
                st.rerun()
        
        with col2:
            if st.button("âŒ ã„ã„ãˆã€å…ƒã«æˆ»ã—ã¾ã™", key="cancel_overwrite"):
                # ç™ºè¡Œæ—¥ã‚’å…ƒã«æˆ»ã™
                st.session_state["ç™ºè¡Œæ—¥"] = ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹['æ—§ç™ºè¡Œæ—¥']
                
                # ç¢ºèªçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                del st.session_state["ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹"]
                
                # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã‹ã‚‰rerun
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                st.info("ç™ºè¡Œæ—¥ã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
                st.rerun()
        
        # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ˜ç¤ºçš„ã«è¡¨ç¤ºã•ã›ã¦ã‹ã‚‰stop
        render_sidebar_status()
        
        # ä¸Šæ›¸ãç¢ºèªä¸­ã¯ä»–ã®å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
        st.stop()
    
    col1, col2 = st.columns(2)
    
    # ç™ºè¡Œæ—¥å…¥åŠ›ï¼ˆåˆæœŸå€¤ç©ºç™½å¯¾å¿œç‰ˆãƒ»ã‚¿ãƒ–çŠ¶æ…‹ä¿æŒå¼·åŒ–ï¼‰
    with col1:
        # åˆæœŸçŠ¶æ…‹ã§ã¯ç™ºè¡Œæ—¥ã‚’ç©ºã«ã™ã‚‹ï¼ˆæ–°è¦æ¡ˆä»¶ã®å ´åˆï¼‰
        è¦‹ç©No = st.session_state.get("è¦‹ç©No", "")
        if è¦‹ç©No:
            # æ—¢å­˜æ¡ˆä»¶ã®å ´åˆã¯ç¾åœ¨ã®ç™ºè¡Œæ—¥ã‚’åˆæœŸå€¤ã¨ã—ã¦ä½¿ç”¨
            ç¾åœ¨ã®ç™ºè¡Œæ—¥ = st.session_state.get("ç™ºè¡Œæ—¥", datetime.date.today())
        else:
            # æ–°è¦æ¡ˆä»¶ã®å ´åˆã¯åˆæœŸå€¤ã‚’Noneã«ã—ã¦ç©ºæ¬„è¡¨ç¤º
            ç¾åœ¨ã®ç™ºè¡Œæ—¥ = st.session_state.get("ç™ºè¡Œæ—¥", None)
        
        ç™ºè¡Œæ—¥ = st.date_input("ç™ºè¡Œæ—¥", value=ç¾åœ¨ã®ç™ºè¡Œæ—¥, key="project_issue_date")
        
        # ç™ºè¡Œæ—¥ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®å‡¦ç†ï¼ˆã‚¿ãƒ–çŠ¶æ…‹ä¿æŒå¼·åŒ–ï¼‰
        if ç™ºè¡Œæ—¥ != ç¾åœ¨ã®ç™ºè¡Œæ—¥:
            æ—§è¦‹ç©No = st.session_state.get("è¦‹ç©No", "")
            
            if æ—§è¦‹ç©No:
                # æ—¢å­˜æ¡ˆä»¶ã®å ´åˆã€ä¸Šæ›¸ãç¢ºèªã‚’è¡¨ç¤º
                æ–°è¦‹ç©No = generate_next_estimate_no(ç™ºè¡Œæ—¥)
                
                if æ–°è¦‹ç©No and æ—§è¦‹ç©No != æ–°è¦‹ç©No:  # æ–°è¦‹ç©NoãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
                    # ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹ã‚’è¨­å®š
                    st.session_state["ä¸Šæ›¸ãç¢ºèªçŠ¶æ…‹"] = {
                        "æ—§è¦‹ç©No": æ—§è¦‹ç©No,
                        "æ–°è¦‹ç©No": æ–°è¦‹ç©No,
                        "æ—§ç™ºè¡Œæ—¥": ç¾åœ¨ã®ç™ºè¡Œæ—¥,
                        "æ–°ç™ºè¡Œæ—¥": ç™ºè¡Œæ—¥
                    }
                    # ã‚¿ãƒ–çŠ¶æ…‹ã‚’æ˜ç¤ºçš„ã«ä¿æŒã—ã¦ã‹ã‚‰rerun
                    st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                    st.rerun()
                else:
                    # åŒã˜è¦‹ç©ç•ªå·ã®å ´åˆã¯ãã®ã¾ã¾æ›´æ–°
                    st.session_state["ç™ºè¡Œæ—¥"] = ç™ºè¡Œæ—¥
            else:
                # æ–°è¦ä½œæˆã®å ´åˆï¼šè¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªã‚’è¡¨ç¤º
                æ–°è¦‹ç©No = generate_next_estimate_no(ç™ºè¡Œæ—¥)
                if æ–°è¦‹ç©No:  # æ–°è¦‹ç©NoãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
                    st.session_state["è¦‹ç©ç•ªå·ç”Ÿæˆç¢ºèªçŠ¶æ…‹"] = {
                        "ç™ºè¡Œæ—¥": ç™ºè¡Œæ—¥,
                        "æ–°è¦‹ç©No": æ–°è¦‹ç©No,
                        "å…ƒç™ºè¡Œæ—¥": ç¾åœ¨ã®ç™ºè¡Œæ—¥
                    }
                    # ã‚¿ãƒ–çŠ¶æ…‹ã‚’æ˜ç¤ºçš„ã«ä¿æŒã—ã¦ã‹ã‚‰rerun
                    st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                    st.rerun()
        
        # æ–°è¦æ¡ˆä»¶ã§ç™ºè¡Œæ—¥ãŒæœªé¸æŠã®å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
        if not è¦‹ç©No and not ç™ºè¡Œæ—¥:
            st.info("ğŸ’¡ ç™ºè¡Œæ—¥ã‚’é¸æŠã™ã‚‹ã¨è¦‹ç©ç•ªå·ãŒç”Ÿæˆã•ã‚Œã¾ã™")
    
    # è¦‹ç©ç•ªå·è¡¨ç¤ºï¼ˆä¿®æ­£ç‰ˆï¼‰
    with col2:
        è¦‹ç©Noè¡¨ç¤º = st.session_state.get("è¦‹ç©No", "")
        
        if è¦‹ç©Noè¡¨ç¤º:
            # è¦‹ç©ç•ªå·è¡¨ç¤º
            st.text_input("è¦‹ç©No.", value=è¦‹ç©Noè¡¨ç¤º, disabled=True, key="project_estimate_no")
            
            # ä¸Šæ›¸ãäºˆå®šã®è¡¨ç¤º
            ä¸Šæ›¸ãå‡¦ç† = st.session_state.get("ä¸Šæ›¸ãå‡¦ç†")
            if ä¸Šæ›¸ãå‡¦ç† and ä¸Šæ›¸ãå‡¦ç†.get("å®Ÿè¡Œäºˆå®š"):
                st.warning(f"â³ ä¿å­˜æ™‚ã« {ä¸Šæ›¸ãå‡¦ç†['æ—§è¦‹ç©No']} ã‚’å‰Šé™¤äºˆå®š")
            
            # é‡è¤‡ãƒã‚§ãƒƒã‚¯è¡¨ç¤º
            if check_estimate_no_exists(è¦‹ç©Noè¡¨ç¤º):
                st.error("âš ï¸ ã“ã®è¦‹ç©ç•ªå·ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™")
                # è‡ªå‹•ã§æ¬¡ã®ç•ªå·ã‚’ææ¡ˆ
                if st.button("ğŸ”„ æ¬¡ã®ç•ªå·ã‚’è‡ªå‹•ç”Ÿæˆ", key="auto_generate_next"):
                    new_estimate_no = generate_next_estimate_no(st.session_state["ç™ºè¡Œæ—¥"])
                    st.session_state["è¦‹ç©No"] = new_estimate_no
                    st.success(f"æ–°ã—ã„è¦‹ç©ç•ªå·: {new_estimate_no}")
                    # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦rerun
                    st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                    st.rerun()
            else:
                st.success("âœ… åˆ©ç”¨å¯èƒ½ãªè¦‹ç©ç•ªå·ã§ã™")
            
            # æ‰‹å‹•å†ç”Ÿæˆãƒœã‚¿ãƒ³
            if st.button("ğŸ”„ è¦‹ç©ç•ªå·ã‚’å†ç”Ÿæˆ", key="manual_regenerate"):
                new_estimate_no = generate_next_estimate_no(st.session_state["ç™ºè¡Œæ—¥"])
                st.session_state["è¦‹ç©No"] = new_estimate_no
                st.success(f"è¦‹ç©ç•ªå·ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ: {new_estimate_no}")
                # ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒã—ã¦rerun
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                st.rerun()
        else:
            # è¦‹ç©ç•ªå·ãŒæœªç”Ÿæˆã®å ´åˆ
            st.text_input("è¦‹ç©No.", value="", disabled=True, key="project_estimate_no_empty", placeholder="ç™ºè¡Œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„")
            st.info("ğŸ’¡ ç™ºè¡Œæ—¥ã‚’é¸æŠã™ã‚‹ã¨è¦‹ç©ç•ªå·ç”Ÿæˆã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™")
    
    # ç™ºè¡Œè€…å
    ç™ºè¡Œè€…å = st.selectbox(
        "ç™ºè¡Œè€…å", 
        options=ISSUER_LIST, 
        index=ISSUER_LIST.index(st.session_state.get("ç™ºè¡Œè€…å", ISSUER_LIST[0])) 
        if st.session_state.get("ç™ºè¡Œè€…å") in ISSUER_LIST else 0,
        key="project_issuer"
    )
    st.session_state["ç™ºè¡Œè€…å"] = ç™ºè¡Œè€…å
    
    # æ‹…å½“éƒ¨ç½²
    æ‹…å½“éƒ¨ç½²é¸æŠè‚¢ = ["", "æ˜ åƒåˆ¶ä½œéƒ¨", "ç¿»è¨³åˆ¶ä½œéƒ¨", "å®Œãƒ—ãƒ­åˆ¶ä½œéƒ¨", "ç”Ÿå­—å¹•åˆ¶ä½œéƒ¨", "å­—å¹•å±•é–‹éƒ¨"]
    æ‹…å½“éƒ¨ç½²åˆæœŸindex = 0
    ç¾åœ¨ã®æ‹…å½“éƒ¨ç½² = st.session_state.get("æ‹…å½“éƒ¨ç½²", "")
    if ç¾åœ¨ã®æ‹…å½“éƒ¨ç½² in æ‹…å½“éƒ¨ç½²é¸æŠè‚¢:
        æ‹…å½“éƒ¨ç½²åˆæœŸindex = æ‹…å½“éƒ¨ç½²é¸æŠè‚¢.index(ç¾åœ¨ã®æ‹…å½“éƒ¨ç½²)
    
    æ‹…å½“éƒ¨ç½² = st.selectbox(
        "æ‹…å½“éƒ¨ç½²", 
        options=æ‹…å½“éƒ¨ç½²é¸æŠè‚¢,
        index=æ‹…å½“éƒ¨ç½²åˆæœŸindex,
        key="project_department_select",
        help="æ¡ˆä»¶å…¨ä½“ã®æ‹…å½“éƒ¨ç½²ã€‚æ˜ç´°ã§å£²ä¸Šå…ˆéƒ¨ç½²ãŒæœªè¨­å®šã®å ´åˆã€ã“ã®éƒ¨ç½²ãŒé©ç”¨ã•ã‚Œã¾ã™"
    )
    
    # æ‹…å½“éƒ¨ç½²ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
    if æ‹…å½“éƒ¨ç½² != st.session_state.get("æ‹…å½“éƒ¨ç½²", ""):
        st.session_state["æ‹…å½“éƒ¨ç½²"] = æ‹…å½“éƒ¨ç½²
    
    st.divider()
    
    # é€²æ—ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    st.subheader("é€²æ—ç®¡ç†")
    
    col1, col2, col3 = st.columns(3)
    
    # çŠ¶æ³
    with col1:
        çŠ¶æ³é¸æŠè‚¢ = ["è¦‹ç©ä¸­", "å—æ³¨", "ç´å“æ¸ˆ", "è«‹æ±‚æ¸ˆ", "ä¸æ¡ç”¨", "å¤±æ³¨"] 
        ç¾åœ¨ã®çŠ¶æ³ = st.session_state.get("çŠ¶æ³", "è¦‹ç©ä¸­")
        # çŠ¶æ³ãŒãƒªã‚¹ãƒˆã«ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        çŠ¶æ³åˆæœŸindex = 0
        if ç¾åœ¨ã®çŠ¶æ³ in çŠ¶æ³é¸æŠè‚¢:
            çŠ¶æ³åˆæœŸindex = çŠ¶æ³é¸æŠè‚¢.index(ç¾åœ¨ã®çŠ¶æ³)
        
        çŠ¶æ³ = st.selectbox(
            "çŠ¶æ³", 
            options=çŠ¶æ³é¸æŠè‚¢,
            index=çŠ¶æ³åˆæœŸindex,
            key="project_status"
        )
        st.session_state["çŠ¶æ³"] = çŠ¶æ³
    
    # å—æ³¨æ—¥ï¼ˆçŠ¶æ³ã«å¿œã˜ã¦æœ‰åŠ¹/ç„¡åŠ¹ï¼‰
    with col2:
        å—æ³¨æ—¥ç„¡åŠ¹ = çŠ¶æ³ in ["è¦‹ç©ä¸­", "å¤±æ³¨"]
        if å—æ³¨æ—¥ç„¡åŠ¹:
            st.date_input("å—æ³¨æ—¥", value=None, disabled=True, key="project_order_date_disabled")
            st.session_state["å—æ³¨æ—¥"] = None
        else:
            å—æ³¨æ—¥ = st.date_input(
                "å—æ³¨æ—¥", 
                value=st.session_state.get("å—æ³¨æ—¥"), 
                key="project_order_date"
            )
            st.session_state["å—æ³¨æ—¥"] = å—æ³¨æ—¥
    
    # ç´å“æ—¥ï¼ˆå¸¸ã«å…¥åŠ›å¯èƒ½ï¼‰
    with col3:
        ç´å“æ—¥ = st.date_input(
            "ç´å“æ—¥", 
            value=st.session_state.get("ç´å“æ—¥"), 
            key="project_delivery_date"
        )
        st.session_state["ç´å“æ—¥"] = ç´å“æ—¥
    
    st.divider()
    
    # é‡‘é¡ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    st.subheader("é‡‘é¡ç®¡ç†")
    
    # æ˜ç´°ã‹ã‚‰ã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
    æ˜ç´°åˆè¨ˆ = sum(item.get("é‡‘é¡", 0) for item in st.session_state.get("æ˜ç´°ãƒªã‚¹ãƒˆ", []) if not item.get("åˆ†é¡", False))
    
    col1, col2 = st.columns(2)
    
    with col1:
        # å£²ä¸Šé¡è‡ªå‹•æ›´æ–°ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        å£²ä¸Šé¡è‡ªå‹•æ›´æ–° = st.checkbox(
            "æ˜ç´°ã«å¿œã˜ã¦å£²ä¸Šé¡ã‚’è‡ªå‹•æ›´æ–°", 
            value=st.session_state.get("å£²ä¸Šé¡è‡ªå‹•æ›´æ–°", True), 
            key="project_auto_update"
        )
        st.session_state["å£²ä¸Šé¡è‡ªå‹•æ›´æ–°"] = å£²ä¸Šé¡è‡ªå‹•æ›´æ–°
        
        # å£²ä¸Šé¡ï¼ˆè‡ªå‹•æ›´æ–°ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›ï¼‰
        if å£²ä¸Šé¡è‡ªå‹•æ›´æ–°:
            st.number_input(
                "å£²ä¸Šé¡", 
                value=int(æ˜ç´°åˆè¨ˆ),  # int()ã§æ•´æ•°ã«å¤‰æ›
                disabled=True, 
                format="%d",
                key="project_sales_auto"
            )
            st.session_state["å£²ä¸Šé¡"] = æ˜ç´°åˆè¨ˆ
        else:
            # ç¾åœ¨ã®å£²ä¸Šé¡ã‚’å®‰å…¨ã«å–å¾—ãƒ»å¤‰æ›
            ç¾åœ¨ã®å£²ä¸Šé¡ = st.session_state.get("å£²ä¸Šé¡", æ˜ç´°åˆè¨ˆ)
            try:
                ç¾åœ¨ã®å£²ä¸Šé¡ = int(float(ç¾åœ¨ã®å£²ä¸Šé¡)) if ç¾åœ¨ã®å£²ä¸Šé¡ not in ["", None] else int(æ˜ç´°åˆè¨ˆ)
            except (ValueError, TypeError):
                ç¾åœ¨ã®å£²ä¸Šé¡ = int(æ˜ç´°åˆè¨ˆ)
            
            å£²ä¸Šé¡ = st.number_input(
                "å£²ä¸Šé¡", 
                value=ç¾åœ¨ã®å£²ä¸Šé¡, 
                min_value=0, 
                step=1000,
                format="%d",
                key="project_sales_manual"
            )
            st.session_state["å£²ä¸Šé¡"] = å£²ä¸Šé¡
    
    with col2:
        # ä»•å…¥é¡ï¼ˆå®‰å…¨ãªå¤‰æ›ï¼‰
        ç¾åœ¨ã®ä»•å…¥é¡ = st.session_state.get("ä»•å…¥é¡", 0)
        try:
            ç¾åœ¨ã®ä»•å…¥é¡ = int(float(ç¾åœ¨ã®ä»•å…¥é¡)) if ç¾åœ¨ã®ä»•å…¥é¡ not in ["", None] else 0
        except (ValueError, TypeError):
            ç¾åœ¨ã®ä»•å…¥é¡ = 0
        
        ä»•å…¥é¡ = st.number_input(
            "ä»•å…¥é¡", 
            value=ç¾åœ¨ã®ä»•å…¥é¡, 
            min_value=0, 
            step=1000,
            format="%d",
            key="project_cost"
        )
        st.session_state["ä»•å…¥é¡"] = ä»•å…¥é¡
        
        # ç²—åˆ©ã¨ç²—åˆ©ç‡ã®è‡ªå‹•è¨ˆç®—ãƒ»è¡¨ç¤º
        å£²ä¸Šé¡_å€¤ = st.session_state.get("å£²ä¸Šé¡", 0)
        try:
            å£²ä¸Šé¡_å€¤ = int(float(å£²ä¸Šé¡_å€¤)) if å£²ä¸Šé¡_å€¤ not in ["", None] else 0
        except (ValueError, TypeError):
            å£²ä¸Šé¡_å€¤ = 0
        
        ç²—åˆ© = å£²ä¸Šé¡_å€¤ - ä»•å…¥é¡
        ç²—åˆ©ç‡ = (ç²—åˆ© / å£²ä¸Šé¡_å€¤ * 100) if å£²ä¸Šé¡_å€¤ > 0 else 0
        
        st.session_state["ç²—åˆ©"] = ç²—åˆ©
        st.session_state["ç²—åˆ©ç‡"] = ç²—åˆ©ç‡
        
        # ç²—åˆ©ã®è¡¨ç¤ºï¼ˆè‰²åˆ†ã‘ï¼‰
        if ç²—åˆ© >= 0:
            st.success(f"ç²—åˆ©: Â¥{ç²—åˆ©:,}")
        else:
            st.error(f"ç²—åˆ©: Â¥{ç²—åˆ©:,}")
        
        # ç²—åˆ©ç‡ã®è¡¨ç¤º
        st.info(f"ç²—åˆ©ç‡: {ç²—åˆ©ç‡:.1f}%")
    
    st.divider()
    
    # ãƒ¡ãƒ¢ï¼ˆã‚¿ãƒ–â‘¡ç”¨ï¼‰
    st.subheader("ãƒ¡ãƒ¢")
    ãƒ¡ãƒ¢ = st.text_area("ãƒ¡ãƒ¢", value=st.session_state.get("ãƒ¡ãƒ¢", ""), key="project_memo", height=100)
    st.session_state["ãƒ¡ãƒ¢"] = ãƒ¡ãƒ¢
    
    st.divider()
    
    # æ¡ˆä»¶æƒ…å ±ä¿å­˜ãƒœã‚¿ãƒ³ã¨æ˜ç´°å…¥åŠ›ã«é€²ã‚€ãƒœã‚¿ãƒ³
    col1, col2, col3, col4 = st.columns([1, 1, 1, 1])

    with col1:
        if st.button("æ¡ˆä»¶æƒ…å ±ã‚’ä¿å­˜", key="save_project_info"):
            # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if not st.session_state.get("è¦‹ç©No"):
                st.warning("ç™ºè¡Œæ—¥ã‚’é¸æŠã—ã¦è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„")
            elif not st.session_state.get("ç´å“æ—¥"):
                st.warning("ç´å“æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            else:
                # JSONä¿å­˜ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
                ä¿å­˜ãƒ‡ãƒ¼ã‚¿ = {
                    "æ˜ç´°ãƒªã‚¹ãƒˆ": st.session_state.get("æ˜ç´°ãƒªã‚¹ãƒˆ", []),
                    "å‚™è€ƒ": st.session_state.get("å‚™è€ƒ", "")
                }
                
                if save_meisai_as_json(st.session_state["è¦‹ç©No"], ä¿å­˜ãƒ‡ãƒ¼ã‚¿):
                    st.success("ğŸ’¾ æ¡ˆä»¶æƒ…å ±ã‚’JSONã«ä¿å­˜ã—ã¾ã—ãŸ")
                else:
                    st.error("âŒ æ¡ˆä»¶æƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")

    with col3:
        if st.button("**æ˜ç´°å…¥åŠ›ã«é€²ã‚€**", type="primary", key="project_to_detail"):
            # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if not st.session_state.get("æ¡ˆä»¶å"):
                st.warning("æ¡ˆä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            elif not st.session_state.get("è¦‹ç©No"):
                st.warning("ç™ºè¡Œæ—¥ã‚’é¸æŠã—ã¦è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„")
            elif not st.session_state.get("ç´å“æ—¥"):
                st.warning("ç´å“æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            else:
                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘£ æ˜ç´°æƒ…å ±ã‚’å…¥åŠ›"
                st.rerun()

def is_language_specified(product_name):
    """å•†å“åã«è¨€èªãŒæ—¢ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤å®š"""
    import re
    
    # æ‹¬å¼§å†…ã®å†…å®¹ã‚’æŠ½å‡º
    pattern = r'ï¼ˆ(.+?)ï¼‰'
    matches = re.findall(pattern, product_name)
    
    if not matches:
        return False
    
    # è¨€èªæŒ‡å®šã¨ã—ã¦æœ‰åŠ¹ãªå†…å®¹ã‹ãƒã‚§ãƒƒã‚¯
    language_patterns = [
        # ç¿»è¨³è¨€èªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆâ—‹â—‹â†’â—‹â—‹ï¼‰
        r'.+â†’.+',
        # å˜ä¸€è¨€èªãƒ‘ã‚¿ãƒ¼ãƒ³
        r'^(è‹±èª|ä¸­å›½èª|éŸ“å›½èª|ã‚¿ã‚¤èª|ãƒ™ãƒˆãƒŠãƒ èª|ãƒ•ãƒ©ãƒ³ã‚¹èª|ãƒ‰ã‚¤ãƒ„èª|ã‚¹ãƒšã‚¤ãƒ³èª|ãƒãƒ«ãƒˆã‚¬ãƒ«èª|ã‚¤ã‚¿ãƒªã‚¢èª|ãƒ­ã‚·ã‚¢èª|ã‚¢ãƒ©ãƒ“ã‚¢èª|ãƒ’ãƒ³ãƒ‡ã‚£ãƒ¼èª|ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª|ãƒãƒ¬ãƒ¼èª|æ—¥æœ¬èª).*$'
    ]
    
    for match in matches:
        for pattern in language_patterns:
            if re.match(pattern, match):
                return True
    
    return False

def is_translation_product(product_name):
    """ç¿»è¨³é–¢é€£å•†å“ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆæ—¢ã«è¨€èªæŒ‡å®šæ¸ˆã¿ã¯é™¤å¤–ï¼‰"""
    # æ—¢ã«è¨€èªãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¯¾è±¡å¤–
    if is_language_specified(product_name):
        return False
    
    translation_keywords = [
        "å­—å¹•ç¿»è¨³", "æ–‡æ›¸ç¿»è¨³", "é€šè¨³", "åŒæ™‚é€šè¨³", "é€æ¬¡é€šè¨³"
    ]
    return any(keyword in product_name for keyword in translation_keywords)

def is_single_language_product(product_name):
    """å˜ä¸€è¨€èªæŒ‡å®šå•†å“ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆæ—¢ã«è¨€èªæŒ‡å®šæ¸ˆã¿ã¯é™¤å¤–ï¼‰"""
    # æ—¢ã«è¨€èªãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¯¾è±¡å¤–
    if is_language_specified(product_name):
        return False
    
    single_language_keywords = [
        "ç¿»è¨³æº–å‚™è²»", "è¨€èªç›£ä¿®", "ç·¨é›†è€…", "æ–‡å­—èµ·ã“ã—", "SRTä½œæˆ", 
        "ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼æ´¾é£", "ç·¨é›†è€…æ´¾é£"
    ]
    return any(keyword in product_name for keyword in single_language_keywords)

def get_language_options():
    """è¨€èªé¸æŠè‚¢ã‚’å–å¾—ï¼ˆç¿»è¨³ç”¨ï¼šâ—‹â—‹â†’â—‹â—‹å½¢å¼ï¼‰"""
    return {
        "": "è¨€èªã‚’é¸æŠ",
        "æ—¥æœ¬èªâ†’è‹±èª": "æ—¥æœ¬èªâ†’è‹±èª", 
        "æ—¥æœ¬èªâ†’ä¸­å›½èª(ç°¡ä½“å­—)": "æ—¥æœ¬èªâ†’ä¸­å›½èª(ç°¡ä½“å­—)",
        "æ—¥æœ¬èªâ†’ä¸­å›½èª(ç¹ä½“å­—)": "æ—¥æœ¬èªâ†’ä¸­å›½èª(ç¹ä½“å­—)",
        "æ—¥æœ¬èªâ†’éŸ“å›½èª": "æ—¥æœ¬èªâ†’éŸ“å›½èª",
        "æ—¥æœ¬èªâ†’ã‚¿ã‚¤èª": "æ—¥æœ¬èªâ†’ã‚¿ã‚¤èª",
        "æ—¥æœ¬èªâ†’ãƒ™ãƒˆãƒŠãƒ èª": "æ—¥æœ¬èªâ†’ãƒ™ãƒˆãƒŠãƒ èª",
        "æ—¥æœ¬èªâ†’ãƒ•ãƒ©ãƒ³ã‚¹èª": "æ—¥æœ¬èªâ†’ãƒ•ãƒ©ãƒ³ã‚¹èª",
        "æ—¥æœ¬èªâ†’ãƒ‰ã‚¤ãƒ„èª": "æ—¥æœ¬èªâ†’ãƒ‰ã‚¤ãƒ„èª",
        "æ—¥æœ¬èªâ†’ã‚¹ãƒšã‚¤ãƒ³èª": "æ—¥æœ¬èªâ†’ã‚¹ãƒšã‚¤ãƒ³èª",
        "è‹±èªâ†’æ—¥æœ¬èª": "è‹±èªâ†’æ—¥æœ¬èª",
        "ä¸­å›½èª(ç°¡ä½“å­—)â†’æ—¥æœ¬èª": "ä¸­å›½èª(ç°¡ä½“å­—)â†’æ—¥æœ¬èª",
        "ä¸­å›½èª(ç¹ä½“å­—)â†’æ—¥æœ¬èª": "ä¸­å›½èª(ç¹ä½“å­—)â†’æ—¥æœ¬èª",
        "éŸ“å›½èªâ†’æ—¥æœ¬èª": "éŸ“å›½èªâ†’æ—¥æœ¬èª",
        "ã‚¿ã‚¤èªâ†’æ—¥æœ¬èª": "ã‚¿ã‚¤èªâ†’æ—¥æœ¬èª",
        "ãƒ™ãƒˆãƒŠãƒ èªâ†’æ—¥æœ¬èª": "ãƒ™ãƒˆãƒŠãƒ èªâ†’æ—¥æœ¬èª",
        "ãƒ•ãƒ©ãƒ³ã‚¹èªâ†’æ—¥æœ¬èª": "ãƒ•ãƒ©ãƒ³ã‚¹èªâ†’æ—¥æœ¬èª",
        "ãƒ‰ã‚¤ãƒ„èªâ†’æ—¥æœ¬èª": "ãƒ‰ã‚¤ãƒ„èªâ†’æ—¥æœ¬èª",
        "ã‚¹ãƒšã‚¤ãƒ³èªâ†’æ—¥æœ¬èª": "ã‚¹ãƒšã‚¤ãƒ³èªâ†’æ—¥æœ¬èª",
        "ãã®ä»–": "ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰"
    }

def get_single_language_options():
    """å˜ä¸€è¨€èªé¸æŠè‚¢ã‚’å–å¾—"""
    return {
        "": "è¨€èªã‚’é¸æŠ",
        "è‹±èª": "è‹±èª",
        "ä¸­å›½èª(ç°¡ä½“å­—)": "ä¸­å›½èª(ç°¡ä½“å­—)",
        "ä¸­å›½èª(ç¹ä½“å­—)": "ä¸­å›½èª(ç¹ä½“å­—)",
        "éŸ“å›½èª": "éŸ“å›½èª",
        "ã‚¿ã‚¤èª": "ã‚¿ã‚¤èª",
        "ãƒ™ãƒˆãƒŠãƒ èª": "ãƒ™ãƒˆãƒŠãƒ èª",
        "ãƒ•ãƒ©ãƒ³ã‚¹èª": "ãƒ•ãƒ©ãƒ³ã‚¹èª",
        "ãƒ‰ã‚¤ãƒ„èª": "ãƒ‰ã‚¤ãƒ„èª",
        "ã‚¹ãƒšã‚¤ãƒ³èª": "ã‚¹ãƒšã‚¤ãƒ³èª",
        "ãƒãƒ«ãƒˆã‚¬ãƒ«èª": "ãƒãƒ«ãƒˆã‚¬ãƒ«èª",
        "ã‚¤ã‚¿ãƒªã‚¢èª": "ã‚¤ã‚¿ãƒªã‚¢èª",
        "ãƒ­ã‚·ã‚¢èª": "ãƒ­ã‚·ã‚¢èª",
        "ã‚¢ãƒ©ãƒ“ã‚¢èª": "ã‚¢ãƒ©ãƒ“ã‚¢èª",
        "ãƒ’ãƒ³ãƒ‡ã‚£ãƒ¼èª": "ãƒ’ãƒ³ãƒ‡ã‚£ãƒ¼èª",
        "ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª": "ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª",
        "ãƒãƒ¬ãƒ¼èª": "ãƒãƒ¬ãƒ¼èª",
        "ãã®ä»–": "ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰"
    }

def render_language_selection(base_product_name, current_language="", key_suffix=""):
    """è¨€èªé¸æŠUIã‚’è¡¨ç¤ºï¼ˆç¿»è¨³å•†å“ãƒ»å˜ä¸€è¨€èªå•†å“ä¸¡å¯¾å¿œï¼‰"""
    # ç¿»è¨³å•†å“ã®åˆ¤å®š
    if is_translation_product(base_product_name):
        st.info(f"ğŸ’¡ ã€Œ{base_product_name}ã€ã¯ç¿»è¨³é–¢é€£å•†å“ã§ã™ã€‚è¨€èªãƒšã‚¢ã‚’æŒ‡å®šã§ãã¾ã™ã€‚")
        
        language_options = get_language_options()
        language_keys = list(language_options.keys())
        
        # ç¾åœ¨ã®è¨€èªã®åˆæœŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        initial_index = 0
        if current_language and current_language in language_keys:
            initial_index = language_keys.index(current_language)
        elif current_language and current_language not in language_keys:
            # ã‚«ã‚¹ã‚¿ãƒ è¨€èªã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’é¸æŠ
            initial_index = language_keys.index("ãã®ä»–") if "ãã®ä»–" in language_keys else 0
        
        selected_language = st.selectbox(
            "è¨€èªãƒšã‚¢ã‚’é¸æŠ", 
            options=language_keys,
            format_func=lambda x: language_options[x],
            index=initial_index,
            key=f"language_select_{key_suffix}"
        )
        
        # ã‚«ã‚¹ã‚¿ãƒ è¨€èªå…¥åŠ›ï¼ˆãã®ä»–ã‚’é¸æŠæ™‚ï¼‰
        final_language = selected_language
        if selected_language == "ãã®ä»–":
            # ç¾åœ¨ã®è¨€èªãŒã‚«ã‚¹ã‚¿ãƒ è¨€èªã®å ´åˆã¯åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
            initial_custom = ""
            if current_language and current_language not in language_keys:
                initial_custom = current_language
            
            custom_language = st.text_input(
                "ã‚«ã‚¹ã‚¿ãƒ è¨€èªãƒšã‚¢ã‚’å…¥åŠ›", 
                value=initial_custom,
                placeholder="ä¾‹: ã‚¿ã‚¤èªâ†’æ—¥æœ¬èª",
                key=f"custom_language_{key_suffix}"
            )
            if custom_language:
                final_language = custom_language
            else:
                final_language = ""  # ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãŒç©ºã®å ´åˆ
        
        # å•†å“åã®æ§‹ç¯‰
        if final_language and final_language != "":
            final_product_name = f"{base_product_name}ï¼ˆ{final_language}ï¼‰"
        else:
            final_product_name = base_product_name
        
        return final_product_name, final_language
    
    # å˜ä¸€è¨€èªå•†å“ã®åˆ¤å®š
    elif is_single_language_product(base_product_name):
        st.info(f"ğŸ’¡ ã€Œ{base_product_name}ã€ã¯è¨€èªæŒ‡å®šå¯èƒ½ãªå•†å“ã§ã™ã€‚å¯¾è±¡è¨€èªã‚’æŒ‡å®šã§ãã¾ã™ã€‚")
        
        language_options = get_single_language_options()
        language_keys = list(language_options.keys())
        
        # ç¾åœ¨ã®è¨€èªã®åˆæœŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        initial_index = 0
        if current_language and current_language in language_keys:
            initial_index = language_keys.index(current_language)
        elif current_language and current_language not in language_keys:
            # ã‚«ã‚¹ã‚¿ãƒ è¨€èªã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’é¸æŠ
            initial_index = language_keys.index("ãã®ä»–") if "ãã®ä»–" in language_keys else 0
        
        selected_language = st.selectbox(
            "å¯¾è±¡è¨€èªã‚’é¸æŠ", 
            options=language_keys,
            format_func=lambda x: language_options[x],
            index=initial_index,
            key=f"single_language_select_{key_suffix}"
        )
        
        # ã‚«ã‚¹ã‚¿ãƒ è¨€èªå…¥åŠ›ï¼ˆãã®ä»–ã‚’é¸æŠæ™‚ï¼‰
        final_language = selected_language
        if selected_language == "ãã®ä»–":
            # ç¾åœ¨ã®è¨€èªãŒã‚«ã‚¹ã‚¿ãƒ è¨€èªã®å ´åˆã¯åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
            initial_custom = ""
            if current_language and current_language not in language_keys:
                initial_custom = current_language
            
            custom_language = st.text_input(
                "ã‚«ã‚¹ã‚¿ãƒ è¨€èªã‚’å…¥åŠ›", 
                value=initial_custom,
                placeholder="ä¾‹: ãƒãƒ«ãƒˆã‚¬ãƒ«èª",
                key=f"custom_single_language_{key_suffix}"
            )
            if custom_language:
                final_language = custom_language
            else:
                final_language = ""  # ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãŒç©ºã®å ´åˆ
        
        # å•†å“åã®æ§‹ç¯‰
        if final_language and final_language != "":
            final_product_name = f"{base_product_name}ï¼ˆ{final_language}ï¼‰"
        else:
            final_product_name = base_product_name
        
        return final_product_name, final_language
    
    # è¨€èªæŒ‡å®šä¸è¦ãªå•†å“
    else:
        return base_product_name, current_language

def extract_base_product_and_language(product_name):
    """å•†å“åã‹ã‚‰åŸºæœ¬å•†å“åã¨è¨€èªæƒ…å ±ã‚’åˆ†é›¢ï¼ˆç¿»è¨³ãƒ»å˜ä¸€è¨€èªä¸¡å¯¾å¿œï¼‰"""
    import re
    
    # è¨€èªãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹å ´åˆ
    pattern = r'^(.+?)ï¼ˆ(.+?)ï¼‰$'
    match = re.match(pattern, product_name)
    
    if match:
        base_name = match.group(1)
        language = match.group(2)
        
        # ç¿»è¨³è¨€èªã¨ã—ã¦æœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆâ—‹â—‹â†’â—‹â—‹å½¢å¼ï¼‰
        translation_language_options = get_language_options()
        if language in translation_language_options or "â†’" in language:
            return base_name, language
        
        # å˜ä¸€è¨€èªã¨ã—ã¦æœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
        single_language_options = get_single_language_options()
        if language in single_language_options:
            return base_name, language
        
        # ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ è¨€èª
        return base_name, language
    
    # ãƒãƒƒãƒã—ãªã„å ´åˆã¯å…¨ä½“ã‚’åŸºæœ¬å•†å“åã¨ã—ã¦æ‰±ã†
    return product_name, ""

# ã“ã®ä½ç½®ã«è¿½åŠ ï¼ˆextract_base_product_and_languageé–¢æ•°ã®ç›´å¾Œï¼‰

def is_management_fee_product(product_name):
    """ç®¡ç†è²»é–¢é€£å•†å“ã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
    management_fee_keywords = [
        "ç®¡ç†è²»", "æ‰‹æ•°æ–™", "äº‹å‹™æ‰‹æ•°æ–™", "ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ–™", "å‡¦ç†æ‰‹æ•°æ–™"
    ]
    return any(keyword in product_name for keyword in management_fee_keywords)

def get_percentage_options():
    """ï¼…é¸æŠè‚¢ã‚’å–å¾—"""
    return {
        "": "ï¼…ã‚’é¸æŠ",
        "5": "5%",
        "10": "10%", 
        "15": "15%",
        "20": "20%",
        "25": "25%",
        "30": "30%",
        "ãã®ä»–": "ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰"
    }

def render_percentage_selection(base_product_name, current_percentage="", key_suffix=""):
    """ï¼…é¸æŠUIã‚’è¡¨ç¤º"""
    if is_management_fee_product(base_product_name):
        st.info(f"ğŸ’¡ ã€Œ{base_product_name}ã€ã¯ç®¡ç†è²»é–¢é€£å•†å“ã§ã™ã€‚ï¼…æŒ‡å®šã§è‡ªå‹•è¨ˆç®—ã§ãã¾ã™ã€‚")
        
        percentage_options = get_percentage_options()
        percentage_keys = list(percentage_options.keys())
        
        # ç¾åœ¨ã®ï¼…ã®åˆæœŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        initial_index = 0
        if current_percentage and current_percentage in percentage_keys:
            initial_index = percentage_keys.index(current_percentage)
        elif current_percentage and current_percentage not in percentage_keys:
            # ã‚«ã‚¹ã‚¿ãƒ ï¼…ã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’é¸æŠ
            initial_index = percentage_keys.index("ãã®ä»–") if "ãã®ä»–" in percentage_keys else 0
        
        selected_percentage = st.selectbox(
            "ç®¡ç†è²»ï¼…ã‚’é¸æŠ", 
            options=percentage_keys,
            format_func=lambda x: percentage_options[x],
            index=initial_index,
            key=f"percentage_select_{key_suffix}"
        )
        
        # ã‚«ã‚¹ã‚¿ãƒ ï¼…å…¥åŠ›ï¼ˆãã®ä»–ã‚’é¸æŠæ™‚ï¼‰
        final_percentage = selected_percentage
        if selected_percentage == "ãã®ä»–":
            # ç¾åœ¨ã®ï¼…ãŒã‚«ã‚¹ã‚¿ãƒ ï¼…ã®å ´åˆã¯åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
            initial_custom = ""
            if current_percentage and current_percentage not in percentage_keys:
                initial_custom = current_percentage
            
            custom_percentage = st.text_input(
                "ã‚«ã‚¹ã‚¿ãƒ ï¼…ã‚’å…¥åŠ›", 
                value=initial_custom,
                placeholder="ä¾‹: 12.5",
                key=f"custom_percentage_{key_suffix}"
            )
            if custom_percentage:
                final_percentage = custom_percentage
            else:
                final_percentage = ""  # ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãŒç©ºã®å ´åˆ
        
        # å•†å“åã®æ§‹ç¯‰
        if final_percentage and final_percentage != "":
            final_product_name = f"{base_product_name}ï¼ˆ{final_percentage}%ï¼‰"
        else:
            final_product_name = base_product_name
        
        return final_product_name, final_percentage
    else:
        return base_product_name, current_percentage

def extract_base_product_and_percentage(product_name):
    """å•†å“åã‹ã‚‰åŸºæœ¬å•†å“åã¨ï¼…æƒ…å ±ã‚’åˆ†é›¢"""
    import re
    
    # ï¼…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹å ´åˆ
    pattern = r'^(.+?)ï¼ˆ(.+?)%ï¼‰$'
    match = re.match(pattern, product_name)
    
    if match:
        base_name = match.group(1)
        percentage = match.group(2)
        return base_name, percentage
    
    # ãƒãƒƒãƒã—ãªã„å ´åˆã¯å…¨ä½“ã‚’åŸºæœ¬å•†å“åã¨ã—ã¦æ‰±ã†
    return product_name, ""

def calculate_management_fee_amount(æ˜ç´°ãƒªã‚¹ãƒˆ, current_index, percentage_str):
    """ç®¡ç†è²»å•†å“ã®é‡‘é¡ã‚’è¨ˆç®—ï¼ˆä¸Šä½å•†å“ã®åˆè¨ˆÃ—ï¼…ãƒ»åˆ†é¡é …ç›®é™¤å¤–ç‰ˆï¼‰"""
    try:
        # ï¼…ã‚’æ•°å€¤ã«å¤‰æ›
        percentage = float(percentage_str)
        
        # ç¾åœ¨ã®å•†å“ã‚ˆã‚Šä¸Šã«ã‚ã‚‹å•†å“ã®åˆè¨ˆã‚’è¨ˆç®—ï¼ˆåˆ†é¡é …ç›®ã¯é™¤å¤–ï¼‰
        ä¸Šä½å•†å“åˆè¨ˆ = 0
        for i in range(current_index):
            if i < len(æ˜ç´°ãƒªã‚¹ãƒˆ):
                item = æ˜ç´°ãƒªã‚¹ãƒˆ[i]
                # åˆ†é¡é …ç›®ã§ãªã„å ´åˆã®ã¿åˆè¨ˆã«å«ã‚ã‚‹
                if not item.get("åˆ†é¡", False):
                    é‡‘é¡ = item.get("é‡‘é¡", 0)
                    if isinstance(é‡‘é¡, (int, float)):
                        ä¸Šä½å•†å“åˆè¨ˆ += é‡‘é¡
        
        # ï¼…è¨ˆç®—
        ç®¡ç†è²»é‡‘é¡ = int(ä¸Šä½å•†å“åˆè¨ˆ * percentage / 100)
        
        return ç®¡ç†è²»é‡‘é¡, ä¸Šä½å•†å“åˆè¨ˆ
        
    except (ValueError, TypeError):
        return 0, 0

# ã‚¿ãƒ–3: æ˜ç´°æƒ…å ±å…¥åŠ›ï¼ˆå“åãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½è¿½åŠ ãƒ»è‡ªå‹•è£œå®Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¿®æ­£ï¼‰
def render_detail_tab(å“åä¸€è¦§):
    """æ˜ç´°æƒ…å ±å…¥åŠ›ã‚¿ãƒ–ã‚’è¡¨ç¤ºï¼ˆä¿‚æ•°æ©Ÿèƒ½å¯¾å¿œç‰ˆï¼‰"""
    st.header("â‘£ æ˜ç´°æƒ…å ±ã‚’å…¥åŠ›")

    # æ¡ˆä»¶æƒ…å ±ãŒä¸å®Œå…¨ãªå ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤ºã—ã€ã‚¿ãƒ–â‘¡ã¸æˆ»ã™ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if not st.session_state.get("æ¡ˆä»¶å") or not st.session_state.get("è¦‹ç©No"):
        st.warning("æ¡ˆä»¶æƒ…å ±ãŒä¸å®Œå…¨ã§ã™ã€‚ã‚¿ãƒ–â‘¢ã§æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        if st.button("æ¡ˆä»¶æƒ…å ±å…¥åŠ›ã«æˆ»ã‚‹", key="detail_back_to_project"):
            st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
            st.rerun()
        st.stop()

    # ä¿‚æ•°æ©Ÿèƒ½ã®è¨­å®š
    st.subheader("ğŸ”§ è¡¨ç¤ºè¨­å®š")
    col1, col2 = st.columns([1, 3])
    
    with col1:
        ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨ = st.checkbox(
            "ä¿‚æ•°æ©Ÿèƒ½ã‚’ä½¿ç”¨", 
            value=st.session_state.get("ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨", False),
            help="ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨æ˜ç´°ã«ä¿‚æ•°åˆ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"
        )
        st.session_state["ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨"] = ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨
    
    with col2:
        if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
            st.info("ğŸ’¡ ä¿‚æ•°æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™ã€‚æ˜ç´°ã«ä¿‚æ•°åˆ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚")
        else:
            st.info("ğŸ’¡ ä¿‚æ•°æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™ã€‚é€šå¸¸ã®æ˜ç´°è¡¨ç¤ºã§ã™ã€‚")
    
    st.divider()

    # æœ€æ–°ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆJSONã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿ï¼‰
    æœ€æ–°å“åä¸€è¦§ = load_products_json()
    
    # DataFrameã«å¤‰æ›ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
    if æœ€æ–°å“åä¸€è¦§:
        æœ€æ–°å“åä¸€è¦§_df = pd.DataFrame(æœ€æ–°å“åä¸€è¦§)
    else:
        æœ€æ–°å“åä¸€è¦§_df = pd.DataFrame(columns=["å“å", "å˜ä½", "å˜ä¾¡", "å‚™è€ƒ"])

    # æ˜ç´°ä¸€è¦§ã®åˆæœŸåŒ–ãƒ»æ¤œè¨¼
    if "æ˜ç´°ãƒªã‚¹ãƒˆ" not in st.session_state:
        st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"] = []
    elif not isinstance(st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"], list):
        st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"] = []

    # æ˜ç´°ä¸€è¦§ã®ç›´æ¥ç·¨é›†è¡¨ç¤ºï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰
    render_editable_detail_list_with_coefficient(æœ€æ–°å“åä¸€è¦§_df)

    # æ–°è¦æ˜ç´°è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰
    render_new_detail_form(æœ€æ–°å“åä¸€è¦§_df)

    # å‚™è€ƒæ¬„
    st.divider()
    st.subheader("è¦‹ç©æ›¸å…¨ä½“ã®å‚™è€ƒ")
    å‚™è€ƒ = st.text_area("å‚™è€ƒ", value=st.session_state.get("å‚™è€ƒ", ""), key="estimate_remarks", height=100)
    st.session_state["å‚™è€ƒ"] = å‚™è€ƒ

    st.divider()

    # ãƒœã‚¿ãƒ³ç¾¤ï¼ˆæ˜ç´°ãŒã‚ã‚‹ã¨ãã®ã¿ï¼‰
    if st.session_state.get("æ˜ç´°ãƒªã‚¹ãƒˆ"):
        col1, col2, col3 = st.columns([1, 1, 1])
        if col1.button("æ˜ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜", type="primary", key="detail_save"):
            save_detail_data()
        if col2.button("è¦‹ç©æ›¸ã‚’å‡ºåŠ›", key="detail_export"):
            export_estimate()
        if col3.button("**æ¡ˆä»¶ä¸€è¦§ã«æˆ»ã‚‹**", key="detail_to_list"):
            st.success("è¦‹ç©ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ")
            st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘  æ¡ˆä»¶ä¸€è¦§"
            st.rerun()
    else:
        st.info("æ˜ç´°ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„")

def render_new_detail_form(å“åä¸€è¦§_df):
    """æ–°è¦æ˜ç´°è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰"""
    st.subheader("â• æ–°è¦æ˜ç´°ã‚’è¿½åŠ ")
    ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨ = st.session_state.get("ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨", False)
    
    # åˆ†é¡ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰è¿½åŠ ãƒœã‚¿ãƒ³
    col1, col2 = st.columns([3, 1])
    with col1:
        st.write("**æ˜ç´°é …ç›®ã®è¿½åŠ **")
    with col2:
        if st.button("ğŸ“ åˆ†é¡ã‚’è¿½åŠ ", key="add_category_button", help="ã€Œâ–¼æº–å‚™ãƒ»ç®¡ç†ã€ã®ã‚ˆã†ãªåˆ†é¡è¦‹å‡ºã—ã‚’è¿½åŠ "):
            st.session_state["åˆ†é¡è¿½åŠ ãƒ¢ãƒ¼ãƒ‰"] = True
            st.rerun()
    
    # åˆ†é¡è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
    if st.session_state.get("åˆ†é¡è¿½åŠ ãƒ¢ãƒ¼ãƒ‰", False):
        st.info("ğŸ“ åˆ†é¡è¦‹å‡ºã—ã‚’è¿½åŠ ")
        with st.form("åˆ†é¡è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ "):
            åˆ†é¡å = st.text_input(
                "åˆ†é¡åã‚’å…¥åŠ›", 
                placeholder="ä¾‹: â–¼æº–å‚™ãƒ»ç®¡ç†ã€â–¼æœ¬ç•ªå½“æ—¥ã€â–¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³",
                key="category_name_input"
            )
            
            col1, col2 = st.columns(2)
            with col1:
                if st.form_submit_button("âœ… åˆ†é¡ã‚’è¿½åŠ ", type="primary"):
                    if åˆ†é¡å:
                        # åˆ†é¡é …ç›®ã‚’æ˜ç´°ãƒªã‚¹ãƒˆã«è¿½åŠ 
                        åˆ†é¡æ˜ç´° = {
                            "å“å": åˆ†é¡å,
                            "æ•°é‡": 0,
                            "å˜ä½": "",
                            "ä¿‚æ•°": 1,  # ä¿‚æ•°é …ç›®ã‚’è¿½åŠ 
                            "å˜ä¾¡": 0,
                            "é‡‘é¡": 0,
                            "å‚™è€ƒ": "",
                            "å£²ä¸Šå…ˆéƒ¨ç½²": "",
                            "åˆ†é¡": True
                        }
                        
                        if not isinstance(st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"], list):
                            st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"] = []
                        st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"].append(åˆ†é¡æ˜ç´°)
                        
                        st.success(f"âœ… åˆ†é¡ã€Œ{åˆ†é¡å}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
                        st.session_state["åˆ†é¡è¿½åŠ ãƒ¢ãƒ¼ãƒ‰"] = False
                        st.rerun()
                    else:
                        st.warning("åˆ†é¡åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            
            with col2:
                if st.form_submit_button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«"):
                    st.session_state["åˆ†é¡è¿½åŠ ãƒ¢ãƒ¼ãƒ‰"] = False
                    st.rerun()
        
        st.divider()
    
    # å•†å“é¸æŠã¨åæ˜ 
    æœ€æ–°å•†å“ãƒ‡ãƒ¼ã‚¿ = load_products_json()
    å“åå€™è£œ = ["ï¼ˆæ–°è¦å…¥åŠ›ï¼‰"]
    
    if æœ€æ–°å•†å“ãƒ‡ãƒ¼ã‚¿:
        try:
            å“åãƒªã‚¹ãƒˆ = [å•†å“.get("å“å", "") for å•†å“ in æœ€æ–°å•†å“ãƒ‡ãƒ¼ã‚¿ if å•†å“.get("å“å")]
            å“åå€™è£œ.extend(å“åãƒªã‚¹ãƒˆ)
        except:
            pass

    col1, col2 = st.columns([3, 1])
    
    with col1:
        å“åé¸æŠ = st.selectbox("åŸºæœ¬å•†å“åã‚’é¸æŠ", options=å“åå€™è£œ, key="æ–°è¦å“åé¸æŠ")
    
    with col2:
        # åæ˜ ãƒœã‚¿ãƒ³
        åæ˜ å¯èƒ½ = å“åé¸æŠ != "ï¼ˆæ–°è¦å…¥åŠ›ï¼‰" and æœ€æ–°å•†å“ãƒ‡ãƒ¼ã‚¿
        if st.button("ğŸ”„ åæ˜ ", disabled=not åæ˜ å¯èƒ½, help="å“åä¸€è¦§ã®æƒ…å ±ã‚’ä¸‹è¨˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ ã—ã¾ã™", key="æ–°è¦åæ˜ ãƒœã‚¿ãƒ³"):
            try:
                è©²å½“å•†å“ = None
                for å•†å“ in æœ€æ–°å•†å“ãƒ‡ãƒ¼ã‚¿:
                    if å•†å“.get("å“å") == å“åé¸æŠ:
                        è©²å½“å•†å“ = å•†å“
                        break
                
                if è©²å½“å•†å“:
                    è£œå®Œæƒ…å ± = {}
                    
                    if è©²å½“å•†å“.get("å˜ä½"):
                        st.session_state["æ–°è¦åæ˜ _å˜ä½"] = è©²å½“å•†å“["å˜ä½"]
                        è£œå®Œæƒ…å ±["å˜ä½"] = è©²å½“å•†å“["å˜ä½"]
                    if è©²å½“å•†å“.get("å˜ä¾¡") and è©²å½“å•†å“["å˜ä¾¡"] > 0:
                        st.session_state["æ–°è¦åæ˜ _å˜ä¾¡"] = int(è©²å½“å•†å“["å˜ä¾¡"])
                        è£œå®Œæƒ…å ±["å˜ä¾¡"] = f"Â¥{int(è©²å½“å•†å“['å˜ä¾¡']):,}"
                    if è©²å½“å•†å“.get("å‚™è€ƒ"):
                        st.session_state["æ–°è¦åæ˜ _å‚™è€ƒ"] = è©²å½“å•†å“["å‚™è€ƒ"]
                        è£œå®Œæƒ…å ±["å‚™è€ƒ"] = è©²å½“å•†å“["å‚™è€ƒ"]
                    
                    if è£œå®Œæƒ…å ±:
                        è£œå®Œå†…å®¹ = " | ".join([f"{k}: {v}" for k, v in è£œå®Œæƒ…å ±.items()])
                        st.success(f"ğŸ”„ å“åä¸€è¦§ã‹ã‚‰æƒ…å ±ã‚’åæ˜ ã—ã¾ã—ãŸ: {è£œå®Œå†…å®¹}")
                        st.rerun()
                    else:
                        st.warning("ã“ã®å“åã«ã¯è¿½åŠ æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“")
                else:
                    st.error("å“åä¸€è¦§ã§è©²å½“ã™ã‚‹å“åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
            except Exception as e:
                st.error(f"æƒ…å ±ã®åæ˜ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

    # åŸºæœ¬å“åã®æ±ºå®š
    if å“åé¸æŠ == "ï¼ˆæ–°è¦å…¥åŠ›ï¼‰":
        åŸºæœ¬å“å = st.text_input("æ–°ã—ã„å“åã‚’å…¥åŠ›", key="æ–°è¦å“åå…¥åŠ›")
    else:
        åŸºæœ¬å“å = å“åé¸æŠ

    # è¨€èªé¸æŠã¨ï¼…é¸æŠã®çµ±åˆå‡¦ç†
    æœ€çµ‚å“å = åŸºæœ¬å“å
    é¸æŠè¨€èª = ""
    é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ = ""
    
    # ç¿»è¨³é–¢é€£å•†å“ã®åˆ¤å®š
    if is_translation_product(åŸºæœ¬å“å):
        æœ€çµ‚å“å, é¸æŠè¨€èª = render_language_selection(åŸºæœ¬å“å, "", "æ–°è¦")
    # å˜ä¸€è¨€èªå•†å“ã®åˆ¤å®š
    elif is_single_language_product(åŸºæœ¬å“å):
        æœ€çµ‚å“å, é¸æŠè¨€èª = render_language_selection(åŸºæœ¬å“å, "", "æ–°è¦")
    # ç®¡ç†è²»å•†å“ã®åˆ¤å®š
    elif is_management_fee_product(åŸºæœ¬å“å):
        æœ€çµ‚å“å, é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ = render_percentage_selection(åŸºæœ¬å“å, "", "æ–°è¦")

    # æ–°è¦æ˜ç´°å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰
    with st.form("æ–°è¦æ˜ç´°å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ", clear_on_submit=False):
        # æœ€çµ‚çš„ãªå“åã‚’è¡¨ç¤ºï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
        if æœ€çµ‚å“å != åŸºæœ¬å“å:
            st.text_input("æœ€çµ‚çš„ãªå“å", value=æœ€çµ‚å“å, disabled=True, key="æ–°è¦æœ€çµ‚å“åè¡¨ç¤º")

        if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
            col1, col2, col3 = st.columns(3)
        else:
            col1, col2 = st.columns(2)
        
        with col1:
            æ•°é‡ = st.number_input("æ•°é‡", min_value=0, value=1, step=1, key="æ–°è¦æ•°é‡")
            
            å˜ä½é¸æŠè‚¢ = ["å¼", "åˆ†", "æ–‡å­—", "åŠæ—¥", "æ—¥", "æ™‚é–“", "å", "æœ¬", "ä»¶", "å›", "æš", "å€‹"]
            åˆæœŸå˜ä½ = st.session_state.get("æ–°è¦åæ˜ _å˜ä½", "å¼")
            å˜ä½åˆæœŸindex = 0
            if åˆæœŸå˜ä½ in å˜ä½é¸æŠè‚¢:
                å˜ä½åˆæœŸindex = å˜ä½é¸æŠè‚¢.index(åˆæœŸå˜ä½)
            
            å˜ä½ = st.selectbox("å˜ä½", options=å˜ä½é¸æŠè‚¢, index=å˜ä½åˆæœŸindex, key="æ–°è¦å˜ä½")
        
        if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
            with col2:
                ä¿‚æ•° = st.number_input("ä¿‚æ•°", min_value=0.5, value=1.0, step=0.5, key="æ–°è¦ä¿‚æ•°")
        
        with col2 if not ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨ else col3:
            # ç®¡ç†è²»å•†å“ã®å ´åˆã¯å˜ä¾¡å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ã—ã€ï¼…è¡¨ç¤º
            if é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸:
                st.text_input("å˜ä¾¡", value=f"{é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸}%", disabled=True, key="æ–°è¦ç®¡ç†è²»å˜ä¾¡è¡¨ç¤º")
                å®Ÿéš›ã®å˜ä¾¡ = 0  # ç®¡ç†è²»ã®å ´åˆã¯å˜ä¾¡ã¯0ï¼ˆå¾Œã§ï¼…è¨ˆç®—ï¼‰
            else:
                åˆæœŸå˜ä¾¡ = st.session_state.get("æ–°è¦åæ˜ _å˜ä¾¡", 0)
                å®Ÿéš›ã®å˜ä¾¡ = st.number_input("å˜ä¾¡", value=åˆæœŸå˜ä¾¡, step=100, help="å‰²å¼•ã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", key="æ–°è¦å˜ä¾¡")
            
            å£²ä¸Šå…ˆéƒ¨ç½²é¸æŠè‚¢ = ["", "æ˜ åƒåˆ¶ä½œéƒ¨", "ç¿»è¨³åˆ¶ä½œéƒ¨", "å®Œãƒ—ãƒ­åˆ¶ä½œéƒ¨", "ç”Ÿå­—å¹•åˆ¶ä½œéƒ¨", "å­—å¹•å±•é–‹éƒ¨"]
            å£²ä¸Šå…ˆéƒ¨ç½² = st.selectbox("å£²ä¸Šå…ˆéƒ¨ç½²", options=å£²ä¸Šå…ˆéƒ¨ç½²é¸æŠè‚¢, key="æ–°è¦å£²ä¸Šå…ˆéƒ¨ç½²")

        åˆæœŸå‚™è€ƒ = st.session_state.get("æ–°è¦åæ˜ _å‚™è€ƒ", "")
        å‚™è€ƒ = st.text_input("å‚™è€ƒ", value=åˆæœŸå‚™è€ƒ, key="æ–°è¦å‚™è€ƒ")

        # é‡‘é¡è¨ˆç®—ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰
        if é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸:
            # ç®¡ç†è²»ã®å ´åˆï¼šç¾åœ¨ã®æ˜ç´°ãƒªã‚¹ãƒˆã‹ã‚‰ä¸Šä½å•†å“ã®åˆè¨ˆã‚’è¨ˆç®—
            ç¾åœ¨ã®æ˜ç´°ãƒªã‚¹ãƒˆ = st.session_state.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
            æ¬¡ã®index = len(ç¾åœ¨ã®æ˜ç´°ãƒªã‚¹ãƒˆ)  # æ–°è¦è¿½åŠ æ™‚ã¯æœ€å¾Œã®index
            ç®¡ç†è²»å˜ä¾¡, ä¸Šä½åˆè¨ˆ = calculate_management_fee_amount(ç¾åœ¨ã®æ˜ç´°ãƒªã‚¹ãƒˆ, æ¬¡ã®index, é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸)
            å®Ÿéš›ã®å˜ä¾¡ = ç®¡ç†è²»å˜ä¾¡  # è¨ˆç®—çµæœã‚’å˜ä¾¡ã¨ã—ã¦ä½¿ç”¨
            if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                é‡‘é¡ = æ•°é‡ * ä¿‚æ•° * å®Ÿéš›ã®å˜ä¾¡
            else:
                é‡‘é¡ = æ•°é‡ * å®Ÿéš›ã®å˜ä¾¡
            
            st.write(f"**ğŸ“Š ä¸Šä½å•†å“åˆè¨ˆ: Â¥{ä¸Šä½åˆè¨ˆ:,}**")
            st.write(f"**ğŸ’° è¨ˆç®—ã•ã‚ŒãŸå˜ä¾¡: Â¥{å®Ÿéš›ã®å˜ä¾¡:,} ({é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸}%)**")
            if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                st.write(f"**ğŸ’° åˆè¨ˆé‡‘é¡: Â¥{é‡‘é¡:,} (æ•°é‡{æ•°é‡} Ã— ä¿‚æ•°{ä¿‚æ•°} Ã— å˜ä¾¡Â¥{å®Ÿéš›ã®å˜ä¾¡:,})**")
            else:
                st.write(f"**ğŸ’° åˆè¨ˆé‡‘é¡: Â¥{é‡‘é¡:,} (æ•°é‡{æ•°é‡} Ã— å˜ä¾¡Â¥{å®Ÿéš›ã®å˜ä¾¡:,})**")
        else:
            # é€šå¸¸å•†å“ã®å ´åˆ
            if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                é‡‘é¡ = æ•°é‡ * ä¿‚æ•° * å®Ÿéš›ã®å˜ä¾¡
                st.write(f"**ğŸ’° åˆè¨ˆé‡‘é¡: Â¥{é‡‘é¡:,} (æ•°é‡{æ•°é‡} Ã— ä¿‚æ•°{ä¿‚æ•°} Ã— å˜ä¾¡Â¥{å®Ÿéš›ã®å˜ä¾¡:,})**")
            else:
                é‡‘é¡ = æ•°é‡ * å®Ÿéš›ã®å˜ä¾¡
                st.write(f"**ğŸ’° åˆè¨ˆé‡‘é¡: Â¥{é‡‘é¡:,} (æ•°é‡{æ•°é‡} Ã— å˜ä¾¡Â¥{å®Ÿéš›ã®å˜ä¾¡:,})**")

        # è¿½åŠ ãƒœã‚¿ãƒ³
        submitted = st.form_submit_button("âœ… æ˜ç´°ã‚’è¿½åŠ ", type="primary")
        
        if submitted:
            if not æœ€çµ‚å“å:
                st.warning("å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            else:
                æ–°æ˜ç´° = {
                    "å“å": æœ€çµ‚å“å,
                    "æ•°é‡": æ•°é‡,
                    "å˜ä½": å˜ä½,
                    "ä¿‚æ•°": ä¿‚æ•° if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨ else 1,  # ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨æ™‚ã®ã¿ä¿‚æ•°ã‚’è¨­å®š
                    "å˜ä¾¡": å®Ÿéš›ã®å˜ä¾¡,
                    "é‡‘é¡": é‡‘é¡,
                    "å‚™è€ƒ": å‚™è€ƒ,
                    "å£²ä¸Šå…ˆéƒ¨ç½²": å£²ä¸Šå…ˆéƒ¨ç½²,
                    "åˆ†é¡": False
                }
                
                # ç®¡ç†è²»å•†å“ã®å ´åˆã¯ç‰¹åˆ¥ãªæƒ…å ±ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                if é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸:
                    æ–°æ˜ç´°["ç®¡ç†è²»ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸"] = é¸æŠãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸
                    æ–°æ˜ç´°["ç®¡ç†è²»ãƒ™ãƒ¼ã‚¹é‡‘é¡"] = ä¸Šä½åˆè¨ˆ
                
                try:
                    # æ–°è¦å“åã®å ´åˆã®å•†å“ç™»éŒ²å‡¦ç†ï¼ˆåŸºæœ¬å•†å“åã®ã¿ç™»éŒ²ï¼‰
                    if å“åé¸æŠ == "ï¼ˆæ–°è¦å…¥åŠ›ï¼‰" and åŸºæœ¬å“å:
                        ç™»éŒ²å•†å“å = åŸºæœ¬å“å  # è¨€èªãƒ»ï¼…æƒ…å ±ã¯å«ã‚ãªã„
                        success, message = add_product_to_json(ç™»éŒ²å•†å“å, å˜ä½, å®Ÿéš›ã®å˜ä¾¡, å‚™è€ƒ)
                        if success:
                            if is_management_fee_product(åŸºæœ¬å“å):
                                st.info(f"âœ… åŸºæœ¬å•†å“ã€Œ{ç™»éŒ²å•†å“å}ã€ã‚’å•†å“ä¸€è¦§ã«ç™»éŒ²ã—ã¾ã—ãŸï¼ˆï¼…æƒ…å ±ã¯æ˜ç´°ã®ã¿ï¼‰")
                            elif is_translation_product(åŸºæœ¬å“å) or is_single_language_product(åŸºæœ¬å“å):
                                st.info(f"âœ… åŸºæœ¬å•†å“ã€Œ{ç™»éŒ²å•†å“å}ã€ã‚’å•†å“ä¸€è¦§ã«ç™»éŒ²ã—ã¾ã—ãŸï¼ˆè¨€èªæƒ…å ±ã¯æ˜ç´°ã®ã¿ï¼‰")
                            else:
                                st.info(message)
                    
                    # æ˜ç´°ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    if not isinstance(st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"], list):
                        st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"] = []
                    st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"].append(æ–°æ˜ç´°)
                    st.success("âœ… æ˜ç´°ã‚’è¿½åŠ ã—ã¾ã—ãŸ")

                    # åæ˜ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                    for key in ["æ–°è¦åæ˜ _å˜ä½", "æ–°è¦åæ˜ _å˜ä¾¡", "æ–°è¦åæ˜ _å‚™è€ƒ"]:
                        if key in st.session_state:
                            del st.session_state[key]
                    
                    st.rerun()

                except Exception as e:
                    st.error(f"æ˜ç´°ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

def render_detail_summary():
    """æ˜ç´°åˆè¨ˆã¨éƒ¨ç½²åˆ¥é›†è¨ˆã®è¡¨ç¤ºï¼ˆåˆ†é¡é …ç›®é™¤å¤–ç‰ˆï¼‰"""
    æ˜ç´°ãƒªã‚¹ãƒˆ = st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"]
    
    if not æ˜ç´°ãƒªã‚¹ãƒˆ:
        return
    
    # åˆ†é¡é …ç›®ã‚’é™¤å¤–ã—ã¦ã‹ã‚‰é›†è¨ˆ
    é€šå¸¸æ˜ç´°ãƒªã‚¹ãƒˆ = [row for row in æ˜ç´°ãƒªã‚¹ãƒˆ if not row.get("åˆ†é¡", False)]
    
    if not é€šå¸¸æ˜ç´°ãƒªã‚¹ãƒˆ:
        return
    
    # åˆè¨ˆé‡‘é¡ã®è¨ˆç®—
    åˆè¨ˆé‡‘é¡ = sum(row["é‡‘é¡"] for row in é€šå¸¸æ˜ç´°ãƒªã‚¹ãƒˆ if isinstance(row["é‡‘é¡"], (int, float)))
    
    # æ¡ˆä»¶ã®æ‹…å½“éƒ¨ç½²ã‚’å–å¾—
    æ¡ˆä»¶æ‹…å½“éƒ¨ç½² = st.session_state.get("æ‹…å½“éƒ¨ç½²", "")
    
    # éƒ¨ç½²åˆ¥é›†è¨ˆã®è¨ˆç®—ï¼ˆå£²ä¸Šå…ˆéƒ¨ç½²ãŒæœªè¨­å®šã®å ´åˆã¯æ‹…å½“éƒ¨ç½²ã‚’ä½¿ç”¨ï¼‰
    éƒ¨ç½²åˆ¥é›†è¨ˆ = {}
    for row in é€šå¸¸æ˜ç´°ãƒªã‚¹ãƒˆ:
        å£²ä¸Šå…ˆéƒ¨ç½² = row.get("å£²ä¸Šå…ˆéƒ¨ç½²", "")
        # å£²ä¸Šå…ˆéƒ¨ç½²ãŒæœªè¨­å®šã®å ´åˆã¯æ¡ˆä»¶ã®æ‹…å½“éƒ¨ç½²ã‚’ä½¿ç”¨
        ä½¿ç”¨éƒ¨ç½² = å£²ä¸Šå…ˆéƒ¨ç½² if å£²ä¸Šå…ˆéƒ¨ç½² else æ¡ˆä»¶æ‹…å½“éƒ¨ç½²
        
        if ä½¿ç”¨éƒ¨ç½²:  # éƒ¨ç½²ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
            é‡‘é¡ = row["é‡‘é¡"] if isinstance(row["é‡‘é¡"], (int, float)) else 0
            if ä½¿ç”¨éƒ¨ç½² in éƒ¨ç½²åˆ¥é›†è¨ˆ:
                éƒ¨ç½²åˆ¥é›†è¨ˆ[ä½¿ç”¨éƒ¨ç½²] += é‡‘é¡
            else:
                éƒ¨ç½²åˆ¥é›†è¨ˆ[ä½¿ç”¨éƒ¨ç½²] = é‡‘é¡
    
    # åˆè¨ˆé‡‘é¡ã®è¡¨ç¤º
    åˆè¨ˆè¡¨ç¤º = f"**åˆè¨ˆé‡‘é¡: Â¥{åˆè¨ˆé‡‘é¡:,}**"

    # éƒ¨ç½²åˆ¥é›†è¨ˆã‚’è¿½åŠ 
    if éƒ¨ç½²åˆ¥é›†è¨ˆ:
        éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ = []
        for éƒ¨ç½², é‡‘é¡ in sorted(éƒ¨ç½²åˆ¥é›†è¨ˆ.items()):
            éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ.append(f"{éƒ¨ç½²}: Â¥{é‡‘é¡:,}")
        
        if éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ:
            åˆè¨ˆè¡¨ç¤º += f"ã€€ã€€ï¼ˆ{' | '.join(éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ)}ï¼‰"
    
    st.markdown(åˆè¨ˆè¡¨ç¤º)

def add_to_hinmei_list(å“å, å˜ä½, å˜ä¾¡, å‚™è€ƒ):
    """æ–°ã—ã„å“åã‚’å“åä¸€è¦§ã«è¿½åŠ """
    try:
        # ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        é¡§å®¢ä¸€è¦§, æ¡ˆä»¶ä¸€è¦§, å“åä¸€è¦§ = load_excel_data(EXCEL_FILENAME)
        
        # é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if not å“åä¸€è¦§.empty and å“å in å“åä¸€è¦§["å“å"].values:
            st.info(f"å“åã€Œ{å“å}ã€ã¯æ—¢ã«å•†å“ä¸€è¦§ã«ç™»éŒ²æ¸ˆã¿ã§ã™")
            return
        
        # æ–°ã—ã„å“åã‚’è¿½åŠ 
        æ–°è¦å“å = {
            "å“å": å“å,
            "å˜ä½": å˜ä½,
            "å˜ä¾¡": å˜ä¾¡,
            "å‚™è€ƒ": å‚™è€ƒ
        }
        
        å“åä¸€è¦§ = pd.concat([å“åä¸€è¦§, pd.DataFrame([æ–°è¦å“å])], ignore_index=True)
        å“åä¸€è¦§ = å“åä¸€è¦§.drop_duplicates(subset=["å“å"], keep="last").reset_index(drop=True)
        
        if save_to_excel(å“åä¸€è¦§, "å“åä¸€è¦§"):
            st.success(f"ğŸ›ï¸ æ–°å•†å“ã€Œ{å“å}ã€ã‚’å•†å“ä¸€è¦§ã«è¿½åŠ ã—ã¾ã—ãŸ")
        else:
            st.error("å•†å“ä¸€è¦§ã¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
    except Exception as e:
        st.error(f"å•†å“ä¸€è¦§è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")

def save_detail_data():
    """æ˜ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜"""
    if not st.session_state.get("è¦‹ç©No"):
        st.error("è¦‹ç©ç•ªå·ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return False
    
    ä¿å­˜ãƒ‡ãƒ¼ã‚¿ = {
        "æ˜ç´°ãƒªã‚¹ãƒˆ": st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"],
        "å‚™è€ƒ": st.session_state.get("å‚™è€ƒ", "")
    }
    
    if save_meisai_as_json(st.session_state["è¦‹ç©No"], ä¿å­˜ãƒ‡ãƒ¼ã‚¿):
        st.success("ğŸ’¾ æ˜ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ")
        return True
    else:
        st.error("æ˜ç´°ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")
        return False

def export_estimate():
    """è¦‹ç©æ›¸ã‚’å‡ºåŠ›ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆãƒ»æ˜ç´°ç•ªå·ä¿®æ­£ç‰ˆãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰"""
    try:
        # åŸºæœ¬æƒ…å ±ã®æº–å‚™
        è¦‹ç©No = st.session_state.get("è¦‹ç©No", "")
        æ¡ˆä»¶å = st.session_state.get("æ¡ˆä»¶å", "æ¡ˆä»¶åæœªè¨­å®š")
        
        # ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨ = st.session_state.get("ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨", False)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ç”¨ã§ããªã„æ–‡å­—ã‚’ç½®æ›ï¼ˆæ‹¬å¼§ã¯ãã®ã¾ã¾ä¿æŒï¼‰
        import re
        å®‰å…¨ãªæ¡ˆä»¶å = æ¡ˆä»¶å
        
        # å±é™ºãªæ–‡å­—ã®ã¿ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«ç½®æ›ï¼ˆæ‹¬å¼§ã¯å•é¡Œãªã„ã®ã§ãã®ã¾ã¾ï¼‰
        å®‰å…¨ãªæ¡ˆä»¶å = re.sub(r'[<>:"/\\|?*]', '_', å®‰å…¨ãªæ¡ˆä»¶å)
        
        # å‰å¾Œã®ç©ºç™½ã‚’é™¤å»
        å®‰å…¨ãªæ¡ˆä»¶å = å®‰å…¨ãªæ¡ˆä»¶å.strip()
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åãŒé•·ã™ãã‚‹å ´åˆã¯çŸ­ç¸®
        if len(å®‰å…¨ãªæ¡ˆä»¶å) > 50:
            å®‰å…¨ãªæ¡ˆä»¶å = å®‰å…¨ãªæ¡ˆä»¶å[:50] + "..."
        
        ãƒ•ã‚¡ã‚¤ãƒ«å = f"{è¦‹ç©No}è¦‹ç©æ›¸_{å®‰å…¨ãªæ¡ˆä»¶å}.xlsx"
        
        # ä½æ‰€æƒ…å ±ã®å–å¾—ï¼ˆç´°åˆ†åŒ–å¯¾å¿œãƒ»å„ªå…ˆé †ä½ä¿®æ­£ç‰ˆï¼‰
        éƒµä¾¿ç•ªå· = ""
        ä½æ‰€1 = ""
        ä½æ‰€2 = ""
        
        # 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰ç´°åˆ†åŒ–ä½æ‰€ã‚’å„ªå…ˆå–å¾—
        if st.session_state.get("é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·") or st.session_state.get("é¸æŠã•ã‚ŒãŸä½æ‰€1") or st.session_state.get("é¸æŠã•ã‚ŒãŸä½æ‰€2"):
            éƒµä¾¿ç•ªå· = st.session_state.get("é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·", "")
            ä½æ‰€1 = st.session_state.get("é¸æŠã•ã‚ŒãŸä½æ‰€1", "")
            ä½æ‰€2 = st.session_state.get("é¸æŠã•ã‚ŒãŸä½æ‰€2", "")
            st.info(f"ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ç´°åˆ†åŒ–ä½æ‰€ã‚’ä½¿ç”¨: {éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}")
        
        # 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«ç´°åˆ†åŒ–ä½æ‰€ãŒãªã„å ´åˆã¯é¡§å®¢JSONã‹ã‚‰å–å¾—
        else:
            try:
                é¡§å®¢ä¸€è¦§ = load_customers_json()
                é¡§å®¢ä¼šç¤¾å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "")
                é¡§å®¢æ‹…å½“è€… = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…", "")
                
                if é¡§å®¢ä¼šç¤¾å and é¡§å®¢æ‹…å½“è€… and é¡§å®¢ä¸€è¦§:
                    for customer in é¡§å®¢ä¸€è¦§:
                        if (customer.get("é¡§å®¢ä¼šç¤¾å") == é¡§å®¢ä¼šç¤¾å and 
                            customer.get("é¡§å®¢æ‹…å½“è€…") == é¡§å®¢æ‹…å½“è€…):
                            
                            # æ–°å½¢å¼ã®ä½æ‰€ã‚’å„ªå…ˆ
                            if customer.get("éƒµä¾¿ç•ªå·") or customer.get("ä½æ‰€1") or customer.get("ä½æ‰€2"):
                                éƒµä¾¿ç•ªå· = customer.get("éƒµä¾¿ç•ªå·", "")
                                ä½æ‰€1 = customer.get("ä½æ‰€1", "")
                                ä½æ‰€2 = customer.get("ä½æ‰€2", "")
                                st.info(f"é¡§å®¢JSONã®ç´°åˆ†åŒ–ä½æ‰€ã‚’ä½¿ç”¨: {éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}")
                            
                            # æ–°å½¢å¼ãŒãªã„å ´åˆã¯æ—§ä½æ‰€ã‚’åˆ†å‰²
                            elif customer.get("é¡§å®¢ä½æ‰€"):
                                æ—§ä½æ‰€ = customer.get("é¡§å®¢ä½æ‰€", "")
                                try:
                                    from estimate_excel_writer import parse_address
                                    éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2 = parse_address(æ—§ä½æ‰€)
                                    st.info(f"æ—§ä½æ‰€ã‚’åˆ†å‰²ã—ã¦ä½¿ç”¨: {æ—§ä½æ‰€} â†’ {éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}")
                                except ImportError:
                                    st.warning("estimate_excel_writer ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                                    ä½æ‰€1 = æ—§ä½æ‰€  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                                except Exception as e:
                                    st.warning(f"ä½æ‰€åˆ†å‰²ã§ã‚¨ãƒ©ãƒ¼: {e}")
                                    ä½æ‰€1 = æ—§ä½æ‰€  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                            
                            break
                
                if not (éƒµä¾¿ç•ªå· or ä½æ‰€1 or ä½æ‰€2):
                    st.warning("é¡§å®¢JSONã«ä½æ‰€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
                    
            except Exception as e:
                st.error(f"é¡§å®¢ä½æ‰€ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        
        # 3. ãã‚Œã§ã‚‚ä½æ‰€ãŒå–å¾—ã§ããªã„å ´åˆã¯çµ±åˆä½æ‰€ã‹ã‚‰åˆ†å‰²ã‚’è©¦è¡Œ
        if not (éƒµä¾¿ç•ªå· or ä½æ‰€1 or ä½æ‰€2):
            çµ±åˆä½æ‰€ = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€", "")
            if çµ±åˆä½æ‰€:
                try:
                    from estimate_excel_writer import parse_address
                    éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2 = parse_address(çµ±åˆä½æ‰€)
                    st.info(f"çµ±åˆä½æ‰€ã‚’åˆ†å‰²ã—ã¦ä½¿ç”¨: {çµ±åˆä½æ‰€} â†’ {éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}")
                except ImportError:
                    st.warning("estimate_excel_writer ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    ä½æ‰€1 = çµ±åˆä½æ‰€  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                except Exception as e:
                    st.warning(f"çµ±åˆä½æ‰€ã®åˆ†å‰²ã§ã‚¨ãƒ©ãƒ¼: {e}")
                    ä½æ‰€1 = çµ±åˆä½æ‰€  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        
        # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
        st.write("**ä½æ‰€å–å¾—çµæœ:**")
        st.write(f"- éƒµä¾¿ç•ªå·: '{éƒµä¾¿ç•ªå·}'")
        st.write(f"- ä½æ‰€1: '{ä½æ‰€1}'")
        st.write(f"- ä½æ‰€2: '{ä½æ‰€2}'")
        
        if not (éƒµä¾¿ç•ªå· or ä½æ‰€1 or ä½æ‰€2):
            st.error("âš ï¸ ä½æ‰€ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¦‹ç©æ›¸ã®ä½æ‰€æ¬„ã¯ç©ºã«ãªã‚Šã¾ã™ã€‚")
            st.info("ğŸ’¡ é¡§å®¢æƒ…å ±ã®ä½æ‰€æ¬„ã‚’ç¢ºèªã—ã¦å†åº¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚")
        
        # æ˜ç´°ãƒªã‚¹ãƒˆã«å•†å“ç•ªå·ã‚’è¿½åŠ 
        å…ƒæ˜ç´°ãƒªã‚¹ãƒˆ = st.session_state.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
        å‡¦ç†æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆ = []
        å•†å“ç•ªå· = 0
        
        for item in å…ƒæ˜ç´°ãƒªã‚¹ãƒˆ:
            å‡¦ç†æ¸ˆã¿item = item.copy()
            
            # åˆ†é¡é …ç›®ã®å ´åˆ
            if item.get("åˆ†é¡", False):
                å‡¦ç†æ¸ˆã¿item["å•†å“ç•ªå·"] = None  # åˆ†é¡ã¯ç•ªå·ãªã—
            else:
                # å•†å“é …ç›®ã®å ´åˆ
                å•†å“ç•ªå· += 1
                å‡¦ç†æ¸ˆã¿item["å•†å“ç•ªå·"] = å•†å“ç•ªå·
            
            å‡¦ç†æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆ.append(å‡¦ç†æ¸ˆã¿item)
        
        # è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’è¾æ›¸ã¨ã—ã¦æº–å‚™ï¼ˆä¿‚æ•°æ©Ÿèƒ½ãƒ•ãƒ©ã‚°è¿½åŠ ï¼‰
        è¦‹ç©ãƒ‡ãƒ¼ã‚¿ = {
            "è¦‹ç©No": è¦‹ç©No,
            "æ¡ˆä»¶å": æ¡ˆä»¶å,
            "ç™ºè¡Œæ—¥": st.session_state.get("ç™ºè¡Œæ—¥", datetime.date.today()),
            "é¡§å®¢ä¼šç¤¾å": st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", ""),
            "é¡§å®¢éƒ¨ç½²å": st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å", ""),
            "é¡§å®¢æ‹…å½“è€…": st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…", ""),
            "éƒµä¾¿ç•ªå·": éƒµä¾¿ç•ªå·,
            "ä½æ‰€1": ä½æ‰€1,
            "ä½æ‰€2": ä½æ‰€2,
            "é¡§å®¢ä½æ‰€": f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip(),  # äº’æ›æ€§ã®ãŸã‚çµ±åˆä½æ‰€ã‚‚è¨­å®š
            "ç™ºè¡Œè€…å": st.session_state.get("ç™ºè¡Œè€…å", ""),
            "å‚™è€ƒ": st.session_state.get("å‚™è€ƒ", ""),
            "æ˜ç´°ãƒªã‚¹ãƒˆ": å‡¦ç†æ¸ˆã¿æ˜ç´°ãƒªã‚¹ãƒˆ,  # å•†å“ç•ªå·ä»˜ãã®æ˜ç´°ãƒªã‚¹ãƒˆ
            "ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨": ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨  # ä¿‚æ•°æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
        }
        
        # è¦‹ç©æ›¸ã‚’ç”Ÿæˆ
        try:
            from estimate_excel_writer import write_estimate_to_excel
            success = write_estimate_to_excel(è¦‹ç©ãƒ‡ãƒ¼ã‚¿, ãƒ•ã‚¡ã‚¤ãƒ«å)
        except ImportError:
            st.error("âŒ estimate_excel_writer ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
            st.info("è¦‹ç©æ›¸å‡ºåŠ›æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€estimate_excel_writer.py ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã§ã™ã€‚")
            return
        except Exception as e:
            st.error(f"âŒ è¦‹ç©æ›¸ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            return
        
        if success and os.path.exists(ãƒ•ã‚¡ã‚¤ãƒ«å):
            st.success(f"âœ… è¦‹ç©æ›¸ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ!")
            if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                st.info(f"ğŸ“‹ **ä¿‚æ•°å¯¾å¿œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã—ãŸ**")
            else:
                st.info(f"ğŸ“‹ **é€šå¸¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã—ãŸ**")
            st.info(f"ğŸ“ **ä¿å­˜å…ˆ:** `{os.path.abspath(ãƒ•ã‚¡ã‚¤ãƒ«å)}`")
            
            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            with open(ãƒ•ã‚¡ã‚¤ãƒ«å, "rb") as file:
                st.download_button(
                    label="ğŸ“¥ è¦‹ç©æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=file.read(),
                    file_name=ãƒ•ã‚¡ã‚¤ãƒ«å,
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    key="download_estimate"
                )
        else:
            st.error("è¦‹ç©æ›¸ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
        
    except Exception as e:
        st.error(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        st.write("**ãƒ‡ãƒãƒƒã‚°æƒ…å ±:**")
        st.write(f"- è¦‹ç©No: {st.session_state.get('è¦‹ç©No', 'æœªè¨­å®š')}")
        st.write(f"- æ˜ç´°ä»¶æ•°: {len(st.session_state.get('æ˜ç´°ãƒªã‚¹ãƒˆ', []))}")
        st.write(f"- é€šå¸¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: {'å­˜åœ¨' if os.path.exists('estimate_template.xlsx') else 'å­˜åœ¨ã—ãªã„'}")
        st.write(f"- ä¿‚æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: {'å­˜åœ¨' if os.path.exists('estimate_templat_keisuu.xlsx') else 'å­˜åœ¨ã—ãªã„'}")
        st.write("**ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:**")
        st.code(traceback.format_exc())

def render_editable_detail_list_with_coefficient(å“åä¸€è¦§_df):
    """ç·¨é›†å¯èƒ½ãªæ˜ç´°ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰"""
    st.subheader("ğŸ“‹ æ˜ç´°ä¸€è¦§ï¼ˆç›´æ¥ç·¨é›†ï¼‰")
    æ˜ç´°ãƒªã‚¹ãƒˆ = st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"]
    ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨ = st.session_state.get("ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨", False)
    
    if not æ˜ç´°ãƒªã‚¹ãƒˆ:
        st.info("æ˜ç´°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸‹è¨˜ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚")
        return
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¿‚æ•°æ©Ÿèƒ½ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
    if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
        header_col1, header_col2, header_col3, header_col4, header_col5, header_col6, header_col7, header_col8, header_col9, header_col10 = st.columns([0.5, 2, 1, 1, 1, 1.2, 1.2, 1.5, 1.5, 2])
        header_col1.write("**No**")
        header_col2.write("**å“å**")
        header_col3.write("**æ•°é‡**")
        header_col4.write("**å˜ä½**")
        header_col5.write("**ä¿‚æ•°**")
        header_col6.write("**å˜ä¾¡**")
        header_col7.write("**é‡‘é¡**")
        header_col8.write("**å£²ä¸Šå…ˆéƒ¨ç½²**")
        header_col9.write("**å‚™è€ƒ**")
        header_col10.write("**æ“ä½œ**")
    else:
        header_col1, header_col2, header_col3, header_col4, header_col5, header_col6, header_col7, header_col8, header_col9 = st.columns([0.5, 2, 1, 1, 1.2, 1.2, 1.5, 1.5, 2])
        header_col1.write("**No**")
        header_col2.write("**å“å**")
        header_col3.write("**æ•°é‡**")
        header_col4.write("**å˜ä½**")
        header_col5.write("**å˜ä¾¡**")
        header_col6.write("**é‡‘é¡**")
        header_col7.write("**å£²ä¸Šå…ˆéƒ¨ç½²**")
        header_col8.write("**å‚™è€ƒ**")
        header_col9.write("**æ“ä½œ**")
    
    # å•†å“ç•ªå·ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆåˆ†é¡ã‚’é™¤å¤–ï¼‰
    å•†å“ç•ªå· = 0
    
    # æ˜ç´°è¡Œï¼ˆç·¨é›†å¯èƒ½ãƒ»åˆ†é¡å¯¾å¿œãƒ»ä¿‚æ•°å¯¾å¿œï¼‰
    for i, row in enumerate(æ˜ç´°ãƒªã‚¹ãƒˆ):
        ç·¨é›†ä¸­ = st.session_state.get(f"ç·¨é›†ä¸­_{i}", False)
        is_category = row.get("åˆ†é¡", False)  # åˆ†é¡é …ç›®ã‹ã©ã†ã‹
        
        # å•†å“é …ç›®ã®å ´åˆã®ã¿ç•ªå·ã‚’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
        if not is_category:
            å•†å“ç•ªå· += 1
        
        if not ç·¨é›†ä¸­:
            # é€šå¸¸è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆä¿‚æ•°æ©Ÿèƒ½å¯¾å¿œï¼‰
            if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                col1, col2, col3, col4, col5, col6, col7, col8, col9, col10 = st.columns([0.5, 2, 1, 1, 1, 1.2, 1.2, 1.5, 1.5, 2])
            else:
                col1, col2, col3, col4, col5, col6, col7, col8, col9 = st.columns([0.5, 2, 1, 1, 1.2, 1.2, 1.5, 1.5, 2])
            
            # Noåˆ—ã®è¡¨ç¤ºï¼šåˆ†é¡ã®å ´åˆã¯ç©ºã€å•†å“ã®å ´åˆã¯ç•ªå·
            if is_category:
                col1.write("")  # åˆ†é¡é …ç›®ã¯ç•ªå·ãªã—
            else:
                col1.write(str(å•†å“ç•ªå·))  # å•†å“é …ç›®ã®ã¿ç•ªå·è¡¨ç¤º
            
            # åˆ†é¡é …ç›®ã®å ´åˆã¯ç‰¹åˆ¥ãªè¡¨ç¤º
            if is_category:
                col2.markdown(f"**{row['å“å']}**")  # å¤ªå­—ã§è¡¨ç¤º
                col3.write("-")
                col4.write("-")
                if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                    col5.write("-")
                    col6.write("-")
                    col7.write("-")
                    col8.write("-")
                    col9.write("-")
                else:
                    col5.write("-")
                    col6.write("-")
                    col7.write("-")
                    col8.write("-")
            else:
                # é€šå¸¸ã®æ˜ç´°é …ç›®
                col2.write(row["å“å"])
                
                # æ•°é‡ã®å®‰å…¨ãªè¡¨ç¤º
                try:
                    æ•°é‡ = row.get("æ•°é‡", 0)
                    if isinstance(æ•°é‡, (int, float)):
                        col3.write(str(int(æ•°é‡)))
                    else:
                        col3.write(str(æ•°é‡))
                except:
                    col3.write("0")
                
                col4.write(row.get("å˜ä½", ""))
                
                if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                    # ä¿‚æ•°ã®è¡¨ç¤º
                    ä¿‚æ•° = row.get("ä¿‚æ•°", 1)
                    col5.write(str(ä¿‚æ•°))
                    
                    # å˜ä¾¡ã®å®‰å…¨ãªè¡¨ç¤º
                    try:
                        å˜ä¾¡ = row.get("å˜ä¾¡", 0)
                        if isinstance(å˜ä¾¡, (int, float)):
                            col6.write(f"Â¥{å˜ä¾¡:,}")
                        else:
                            col6.write(str(å˜ä¾¡))
                    except:
                        col6.write("Â¥0")
                    
                    # é‡‘é¡ã®å®‰å…¨ãªè¡¨ç¤º
                    try:
                        é‡‘é¡ = row.get("é‡‘é¡", 0)
                        if isinstance(é‡‘é¡, (int, float)):
                            col7.write(f"Â¥{é‡‘é¡:,}")
                        else:
                            col7.write(str(é‡‘é¡))
                    except:
                        col7.write("Â¥0")
                    
                    col8.write(row.get("å£²ä¸Šå…ˆéƒ¨ç½²", ""))
                    col9.write(row.get("å‚™è€ƒ", ""))
                else:
                    # å˜ä¾¡ã®å®‰å…¨ãªè¡¨ç¤º
                    try:
                        å˜ä¾¡ = row.get("å˜ä¾¡", 0)
                        if isinstance(å˜ä¾¡, (int, float)):
                            col5.write(f"Â¥{å˜ä¾¡:,}")
                        else:
                            col5.write(str(å˜ä¾¡))
                    except:
                        col5.write("Â¥0")
                    
                    # é‡‘é¡ã®å®‰å…¨ãªè¡¨ç¤º
                    try:
                        é‡‘é¡ = row.get("é‡‘é¡", 0)
                        if isinstance(é‡‘é¡, (int, float)):
                            col6.write(f"Â¥{é‡‘é¡:,}")
                        else:
                            col6.write(str(é‡‘é¡))
                    except:
                        col6.write("Â¥0")
                    
                    col7.write(row.get("å£²ä¸Šå…ˆéƒ¨ç½²", ""))
                    col8.write(row.get("å‚™è€ƒ", ""))
            
            # æ“ä½œãƒœã‚¿ãƒ³ï¼ˆä¿‚æ•°æ©Ÿèƒ½ã«é–¢ä¿‚ãªãæœ€å¾Œã®åˆ—ï¼‰
            if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
                æ“ä½œcol = col10
            else:
                æ“ä½œcol = col9
                
            with æ“ä½œcol:
                button_col1, button_col2, button_col3, button_col4, button_col5 = st.columns(5)
                
                if button_col1.button("â†‘", key=f"up_{i}", help="ä¸Šã«ç§»å‹•", disabled=(i == 0)):
                    if i > 0:
                        æ˜ç´°ãƒªã‚¹ãƒˆ[i-1], æ˜ç´°ãƒªã‚¹ãƒˆ[i] = æ˜ç´°ãƒªã‚¹ãƒˆ[i], æ˜ç´°ãƒªã‚¹ãƒˆ[i-1]
                        st.rerun()
                
                if button_col2.button("â†“", key=f"down_{i}", help="ä¸‹ã«ç§»å‹•", disabled=(i == len(æ˜ç´°ãƒªã‚¹ãƒˆ) - 1)):
                    if i < len(æ˜ç´°ãƒªã‚¹ãƒˆ) - 1:
                        æ˜ç´°ãƒªã‚¹ãƒˆ[i+1], æ˜ç´°ãƒªã‚¹ãƒˆ[i] = æ˜ç´°ãƒªã‚¹ãƒˆ[i], æ˜ç´°ãƒªã‚¹ãƒˆ[i+1]
                        st.rerun()
                
                if button_col3.button("ğŸ“", key=f"edit_{i}", help="ç·¨é›†"):
                    # ä»–ã®ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    for j in range(len(æ˜ç´°ãƒªã‚¹ãƒˆ)):
                        st.session_state[f"ç·¨é›†ä¸­_{j}"] = False
                    st.session_state[f"ç·¨é›†ä¸­_{i}"] = True
                    st.rerun()
                
                if button_col4.button("ğŸ“‹", key=f"copy_{i}", help="è¤‡è£½"):
                    æ–°æ˜ç´° = row.copy()
                    æ˜ç´°ãƒªã‚¹ãƒˆ.insert(i + 1, æ–°æ˜ç´°)
                    st.success("æ˜ç´°ã‚’è¤‡è£½ã—ã¾ã—ãŸ")
                    st.rerun()
                
                if button_col5.button("ğŸ—‘ï¸", key=f"delete_{i}", help="å‰Šé™¤"):
                    æ˜ç´°ãƒªã‚¹ãƒˆ.pop(i)
                    st.success("æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                    st.rerun()
        
        else:
            # ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆã¯é•·ã„ãŸã‚ã€æ¬¡ã®artifactã§æä¾›ï¼‰
            render_detail_edit_mode_with_coefficient(i, row, is_category, å•†å“ç•ªå·)

    # åˆè¨ˆé‡‘é¡ã¨éƒ¨ç½²åˆ¥é›†è¨ˆã®è¡¨ç¤ºï¼ˆåˆ†é¡é …ç›®é™¤å¤–ç‰ˆï¼‰
    render_detail_summary()

def render_detail_edit_mode_with_coefficient(i, row, is_category, å•†å“ç•ªå·):
    """æ˜ç´°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰"""
    ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨ = st.session_state.get("ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨", False)
    æ˜ç´°ãƒªã‚¹ãƒˆ = st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"]
    
    # åˆ†é¡é …ç›®ã®ç·¨é›†
    if is_category:
        col1, col2 = st.columns([2, 1])
        
        with col1:
            å“å = st.text_input("åˆ†é¡å", value=row["å“å"], key=f"edit_category_name_{i}")
        
        with col2:
            edit_col1, edit_col2 = st.columns(2)
            
            if edit_col1.button("âœ… ä¿å­˜", key=f"save_category_{i}"):
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å“å"] = å“å
                st.session_state[f"ç·¨é›†ä¸­_{i}"] = False
                st.success("åˆ†é¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ")
                st.rerun()
            
            if edit_col2.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key=f"cancel_category_{i}"):
                st.session_state[f"ç·¨é›†ä¸­_{i}"] = False
                st.rerun()
        
        return

    # å•†å“é …ç›®ã®ç·¨é›†ï¼ˆä¿‚æ•°å¯¾å¿œç‰ˆï¼‰
    if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
        col1, col2, col3, col4 = st.columns(4)
    else:
        col1, col2, col3 = st.columns(3)
    
    with col1:
        # å“åã®ç·¨é›†
        å“å = st.text_input("å“å", value=row["å“å"], key=f"edit_name_{i}")
        
        # æ•°é‡ã®å®‰å…¨ãªç·¨é›†
        try:
            ç¾åœ¨ã®æ•°é‡ = row.get("æ•°é‡", 0)
            if ç¾åœ¨ã®æ•°é‡ == "" or ç¾åœ¨ã®æ•°é‡ is None:
                ç¾åœ¨ã®æ•°é‡ = 0
            else:
                ç¾åœ¨ã®æ•°é‡ = int(ç¾åœ¨ã®æ•°é‡)
        except (ValueError, TypeError):
            ç¾åœ¨ã®æ•°é‡ = 0
        
        æ•°é‡ = st.number_input("æ•°é‡", value=ç¾åœ¨ã®æ•°é‡, min_value=0, step=1, key=f"edit_qty_{i}")
        
        å˜ä½é¸æŠè‚¢ = ["å¼", "åˆ†", "æ–‡å­—", "åŠæ—¥", "æ—¥", "æ™‚é–“", "å", "æœ¬", "ä»¶", "å›", "æš", "å€‹"]
        ç¾åœ¨ã®å˜ä½ = row.get("å˜ä½", "å¼")
        å˜ä½åˆæœŸindex = 0
        if ç¾åœ¨ã®å˜ä½ in å˜ä½é¸æŠè‚¢:
            å˜ä½åˆæœŸindex = å˜ä½é¸æŠè‚¢.index(ç¾åœ¨ã®å˜ä½)
        
        å˜ä½ = st.selectbox("å˜ä½", options=å˜ä½é¸æŠè‚¢, index=å˜ä½åˆæœŸindex, key=f"edit_unit_{i}")
    
    with col2:
        if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
            # ä¿‚æ•°ã®å®‰å…¨ãªç·¨é›†
            try:
                ç¾åœ¨ã®ä¿‚æ•° = row.get("ä¿‚æ•°", 1)
                if ç¾åœ¨ã®ä¿‚æ•° == "" or ç¾åœ¨ã®ä¿‚æ•° is None:
                    ç¾åœ¨ã®ä¿‚æ•° = 1.0
                else:
                    ç¾åœ¨ã®ä¿‚æ•° = float(ç¾åœ¨ã®ä¿‚æ•°)
            except (ValueError, TypeError):
                ç¾åœ¨ã®ä¿‚æ•° = 1.0
            
            ä¿‚æ•° = st.number_input("ä¿‚æ•°", value=ç¾åœ¨ã®ä¿‚æ•°, min_value=0.5, step=0.5, key=f"edit_coeff_{i}")
        
        # å˜ä¾¡ã®å®‰å…¨ãªç·¨é›†
        try:
            ç¾åœ¨ã®å˜ä¾¡ = row.get("å˜ä¾¡", 0)
            if ç¾åœ¨ã®å˜ä¾¡ == "" or ç¾åœ¨ã®å˜ä¾¡ is None:
                ç¾åœ¨ã®å˜ä¾¡ = 0.0
            else:
                ç¾åœ¨ã®å˜ä¾¡ = float(ç¾åœ¨ã®å˜ä¾¡)
        except (ValueError, TypeError):
            ç¾åœ¨ã®å˜ä¾¡ = 0.0
        
        å˜ä¾¡ = st.number_input("å˜ä¾¡", value=ç¾åœ¨ã®å˜ä¾¡, step=100.0, help="å‰²å¼•ã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", key=f"edit_price_{i}")
        
        # é‡‘é¡è¨ˆç®—
        if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
            é‡‘é¡ = æ•°é‡ * ä¿‚æ•° * å˜ä¾¡
        else:
            é‡‘é¡ = æ•°é‡ * å˜ä¾¡
        
        st.write(f"**é‡‘é¡: Â¥{é‡‘é¡:,}**")
    
    with col3:
        å£²ä¸Šå…ˆéƒ¨ç½²é¸æŠè‚¢ = ["", "æ˜ åƒåˆ¶ä½œéƒ¨", "ç¿»è¨³åˆ¶ä½œéƒ¨", "å®Œãƒ—ãƒ­åˆ¶ä½œéƒ¨", "ç”Ÿå­—å¹•åˆ¶ä½œéƒ¨", "å­—å¹•å±•é–‹éƒ¨"]
        ç¾åœ¨ã®å£²ä¸Šå…ˆéƒ¨ç½² = row.get("å£²ä¸Šå…ˆéƒ¨ç½²", "")
        å£²ä¸Šå…ˆéƒ¨ç½²åˆæœŸindex = 0
        if ç¾åœ¨ã®å£²ä¸Šå…ˆéƒ¨ç½² in å£²ä¸Šå…ˆéƒ¨ç½²é¸æŠè‚¢:
            å£²ä¸Šå…ˆéƒ¨ç½²åˆæœŸindex = å£²ä¸Šå…ˆéƒ¨ç½²é¸æŠè‚¢.index(ç¾åœ¨ã®å£²ä¸Šå…ˆéƒ¨ç½²)
        
        å£²ä¸Šå…ˆéƒ¨ç½² = st.selectbox("å£²ä¸Šå…ˆéƒ¨ç½²", options=å£²ä¸Šå…ˆéƒ¨ç½²é¸æŠè‚¢, index=å£²ä¸Šå…ˆéƒ¨ç½²åˆæœŸindex, key=f"edit_dept_{i}")
        
        å‚™è€ƒ = st.text_input("å‚™è€ƒ", value=row.get("å‚™è€ƒ", ""), key=f"edit_remark_{i}")
    
    if ä¿‚æ•°æ©Ÿèƒ½ä½¿ç”¨:
        with col4:
            st.write("")  # é«˜ã•èª¿æ•´
            
            edit_col1, edit_col2 = st.columns(2)
            
            if edit_col1.button("âœ… ä¿å­˜", key=f"save_edit_{i}"):
                # æ˜ç´°ã‚’æ›´æ–°
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å“å"] = å“å
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["æ•°é‡"] = æ•°é‡
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å˜ä½"] = å˜ä½
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["ä¿‚æ•°"] = ä¿‚æ•°
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å˜ä¾¡"] = å˜ä¾¡
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["é‡‘é¡"] = é‡‘é¡
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å£²ä¸Šå…ˆéƒ¨ç½²"] = å£²ä¸Šå…ˆéƒ¨ç½²
                æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å‚™è€ƒ"] = å‚™è€ƒ
                
                st.session_state[f"ç·¨é›†ä¸­_{i}"] = False
                st.success("æ˜ç´°ã‚’æ›´æ–°ã—ã¾ã—ãŸ")
                st.rerun()
            
            if edit_col2.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key=f"cancel_edit_{i}"):
                st.session_state[f"ç·¨é›†ä¸­_{i}"] = False
                st.rerun()
    else:
        # ä¿‚æ•°æ©Ÿèƒ½æœªä½¿ç”¨æ™‚ã®ä¿å­˜ãƒœã‚¿ãƒ³
        edit_col1, edit_col2 = st.columns([1, 1])
        
        if edit_col1.button("âœ… ä¿å­˜", key=f"save_edit_{i}"):
            # æ˜ç´°ã‚’æ›´æ–°
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å“å"] = å“å
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["æ•°é‡"] = æ•°é‡
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å˜ä½"] = å˜ä½
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["ä¿‚æ•°"] = 1  # ä¿‚æ•°æ©Ÿèƒ½ç„¡åŠ¹æ™‚ã¯1ã§å›ºå®š
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å˜ä¾¡"] = å˜ä¾¡
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["é‡‘é¡"] = é‡‘é¡
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å£²ä¸Šå…ˆéƒ¨ç½²"] = å£²ä¸Šå…ˆéƒ¨ç½²
            æ˜ç´°ãƒªã‚¹ãƒˆ[i]["å‚™è€ƒ"] = å‚™è€ƒ
            
            st.session_state[f"ç·¨é›†ä¸­_{i}"] = False
            st.success("æ˜ç´°ã‚’æ›´æ–°ã—ã¾ã—ãŸ")
            st.rerun()
        
        if edit_col2.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key=f"cancel_edit_{i}"):
            st.session_state[f"ç·¨é›†ä¸­_{i}"] = False
            st.rerun()

def load_all_projects():
    """ã™ã¹ã¦ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆæ•°å€¤å¤‰æ›å¼·åŒ–ç‰ˆï¼‰"""
    æ¡ˆä»¶ãƒªã‚¹ãƒˆ = []
    
    if not os.path.exists(DATA_FOLDER):
        return []
    
    try:
        json_files = [f for f in os.listdir(DATA_FOLDER) if f.endswith('.json')]
        
        for file in json_files:
            try:
                ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, file)
                with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "r", encoding="utf-8") as f:
                    data = json.load(f)
                
                if isinstance(data, dict):
                    # æ˜ç´°ã‹ã‚‰åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ï¼ˆåˆ†é¡é …ç›®é™¤å¤–ãƒ»æ•°å€¤å¤‰æ›å¼·åŒ–ï¼‰
                    æ˜ç´°ãƒªã‚¹ãƒˆ = data.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
                    æ˜ç´°åˆè¨ˆ = 0
                    
                    for item in æ˜ç´°ãƒªã‚¹ãƒˆ:
                        # åˆ†é¡é …ç›®ã§ãªã„å ´åˆã®ã¿åˆè¨ˆã«å«ã‚ã‚‹
                        if not item.get("åˆ†é¡", False):
                            try:
                                é‡‘é¡ = item.get("é‡‘é¡", 0)
                                # ç©ºæ–‡å­—åˆ—ã‚„ None ã®å ´åˆã¯ 0 ã¨ã—ã¦æ‰±ã†
                                if é‡‘é¡ == "" or é‡‘é¡ is None:
                                    é‡‘é¡ = 0
                                else:
                                    é‡‘é¡ = float(é‡‘é¡)
                                æ˜ç´°åˆè¨ˆ += é‡‘é¡
                            except (ValueError, TypeError):
                                # å¤‰æ›ã§ããªã„å ´åˆã¯ 0 ã¨ã—ã¦æ‰±ã†
                                continue
                    
                    # å£²ä¸Šé¡ã®å„ªå…ˆé †ä½ï¼šæ˜ç´°åˆè¨ˆ > ä¿å­˜ã•ã‚ŒãŸå£²ä¸Šé¡
                    try:
                        ä¿å­˜å£²ä¸Šé¡ = data.get("å£²ä¸Šé¡", 0)
                        if ä¿å­˜å£²ä¸Šé¡ == "" or ä¿å­˜å£²ä¸Šé¡ is None:
                            ä¿å­˜å£²ä¸Šé¡ = 0
                        else:
                            ä¿å­˜å£²ä¸Šé¡ = float(ä¿å­˜å£²ä¸Šé¡)
                    except (ValueError, TypeError):
                        ä¿å­˜å£²ä¸Šé¡ = 0
                    
                    # æ˜ç´°ãŒã‚ã‚‹å ´åˆã¯æ˜ç´°åˆè¨ˆã‚’å„ªå…ˆã€ãªã„å ´åˆã¯ä¿å­˜ã•ã‚ŒãŸå£²ä¸Šé¡ã‚’ä½¿ç”¨
                    if æ˜ç´°åˆè¨ˆ > 0:
                        å£²ä¸Šé¡ = æ˜ç´°åˆè¨ˆ
                    else:
                        å£²ä¸Šé¡ = ä¿å­˜å£²ä¸Šé¡
                    
                    # æ—¥ä»˜ã®å‡¦ç†
                    try:
                        ç™ºè¡Œæ—¥ = pd.to_datetime(data.get("ç™ºè¡Œæ—¥", "")).date() if data.get("ç™ºè¡Œæ—¥") else None
                    except:
                        ç™ºè¡Œæ—¥ = None
                    
                    try:
                        å—æ³¨æ—¥ = pd.to_datetime(data.get("å—æ³¨æ—¥", "")).date() if data.get("å—æ³¨æ—¥") else None
                    except:
                        å—æ³¨æ—¥ = None
                    
                    try:
                        ç´å“æ—¥ = pd.to_datetime(data.get("ç´å“æ—¥", "")).date() if data.get("ç´å“æ—¥") else None
                    except:
                        ç´å“æ—¥ = None
                    
                    # æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å®‰å…¨ãªå¤‰æ›
                    try:
                        ä»•å…¥é¡ = data.get("ä»•å…¥é¡", 0)
                        if ä»•å…¥é¡ == "" or ä»•å…¥é¡ is None:
                            ä»•å…¥é¡ = 0
                        else:
                            ä»•å…¥é¡ = int(float(ä»•å…¥é¡))
                    except (ValueError, TypeError):
                        ä»•å…¥é¡ = 0
                    
                    try:
                        ç²—åˆ© = data.get("ç²—åˆ©", 0)
                        if ç²—åˆ© == "" or ç²—åˆ© is None:
                            ç²—åˆ© = 0
                        else:
                            ç²—åˆ© = int(float(ç²—åˆ©))
                    except (ValueError, TypeError):
                        ç²—åˆ© = 0
                    
                    try:
                        ç²—åˆ©ç‡ = data.get("ç²—åˆ©ç‡", 0)
                        if ç²—åˆ©ç‡ == "" or ç²—åˆ©ç‡ is None:
                            ç²—åˆ©ç‡ = 0
                        else:
                            ç²—åˆ©ç‡ = float(ç²—åˆ©ç‡)
                    except (ValueError, TypeError):
                        ç²—åˆ©ç‡ = 0
                    
                    # æ˜ç´°ä»¶æ•°ã®è¨ˆç®—ï¼ˆåˆ†é¡é …ç›®é™¤å¤–ï¼‰
                    æ˜ç´°ä»¶æ•° = len([item for item in æ˜ç´°ãƒªã‚¹ãƒˆ if not item.get("åˆ†é¡", False)])
                    
                    æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ = {
                        "è¦‹ç©No": data.get("è¦‹ç©No", ""),
                        "æ¡ˆä»¶å": data.get("æ¡ˆä»¶å", "æ¡ˆä»¶åæœªè¨­å®š"),
                        "é¡§å®¢ä¼šç¤¾å": data.get("é¡§å®¢ä¼šç¤¾å", ""),
                        "é¡§å®¢éƒ¨ç½²å": data.get("é¡§å®¢éƒ¨ç½²å", ""),
                        "é¡§å®¢æ‹…å½“è€…": data.get("é¡§å®¢æ‹…å½“è€…", ""),
                        "ç™ºè¡Œæ—¥": ç™ºè¡Œæ—¥,
                        "å—æ³¨æ—¥": å—æ³¨æ—¥,
                        "ç´å“æ—¥": ç´å“æ—¥,
                        "å£²ä¸Šé¡": int(å£²ä¸Šé¡),
                        "ä»•å…¥é¡": ä»•å…¥é¡,
                        "ç²—åˆ©": ç²—åˆ©,
                        "ç²—åˆ©ç‡": ç²—åˆ©ç‡,
                        "çŠ¶æ³": data.get("çŠ¶æ³", "è¦‹ç©ä¸­"),
                        "ç™ºè¡Œè€…å": data.get("ç™ºè¡Œè€…å", ""),
                        "ãƒ¡ãƒ¢": data.get("ãƒ¡ãƒ¢", ""),
                        "æ˜ç´°ä»¶æ•°": æ˜ç´°ä»¶æ•°,
                        "JSONãƒ•ã‚¡ã‚¤ãƒ«": file,
                        "æ‹…å½“éƒ¨ç½²": data.get("æ‹…å½“éƒ¨ç½²", ""),
                        "æ˜ç´°ãƒªã‚¹ãƒˆ": æ˜ç´°ãƒªã‚¹ãƒˆ
                    }
                    
                    æ¡ˆä»¶ãƒªã‚¹ãƒˆ.append(æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿)
                    
            except Exception as e:
                st.warning(f"ãƒ•ã‚¡ã‚¤ãƒ« {file} ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼: {e}")
                continue
                
    except Exception as e:
        st.error(f"æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼: {e}")
    
    return æ¡ˆä»¶ãƒªã‚¹ãƒˆ

def render_project_list_tab():
    """æ¡ˆä»¶ä¸€è¦§ã‚¿ãƒ–ã‚’è¡¨ç¤ºï¼ˆå¹´åº¦ãƒ»æœˆé€£å‹•ãƒ•ã‚£ãƒ«ã‚¿å¯¾å¿œç‰ˆï¼‰"""
    st.header("â‘  æ¡ˆä»¶ä¸€è¦§")
    
    # æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    æ¡ˆä»¶ãƒªã‚¹ãƒˆ = load_all_projects()
    
    if not æ¡ˆä»¶ãƒªã‚¹ãƒˆ:
        st.info("æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        if st.button("æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆ", key="create_project_no_data"):
            # ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
            reset_all_data()
            st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
            st.success("æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚")
            st.rerun()
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ»æ¤œç´¢ã€€ã€Œçµã‚Šè¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã€€ã€Œã™ã¹ã¦ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³
    header_col1, header_col2, header_col3 = st.columns([2, 1, 1])
    with header_col1:
        st.subheader("ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ»æ¤œç´¢")
    with header_col2:
        st.write("ã€€")  # é«˜ã•èª¿æ•´
        çµã‚Šè¾¼ã¿å®Ÿè¡Œ = st.button("ğŸ” çµã‚Šè¾¼ã‚€", type="primary", key="apply_filter")
    with header_col3:
        st.write("ã€€")  # é«˜ã•èª¿æ•´
        if st.button("ğŸ§¹ ã™ã¹ã¦ã‚¯ãƒªã‚¢", key="clear_all_filters", help="ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ã¨æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢"):
            # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é–¢é€£ã®ã‚­ãƒ¼ã‚’å‰Šé™¤
            keys_to_remove = []
            for key in list(st.session_state.keys()):
                if key.startswith("include_") or key.startswith("exclude_"):
                    keys_to_remove.append(key)
            
            for key in keys_to_remove:
                if key in st.session_state:
                    del st.session_state[key]
            
            # ãƒ•ã‚£ãƒ«ã‚¿å€¤ã‚’åˆæœŸåŒ–
            st.session_state["filter_å£²ä¸Šå¹´åº¦"] = "ã™ã¹ã¦"
            st.session_state["filter_å£²ä¸Šæœˆ"] = "ã™ã¹ã¦"
            st.session_state["filter_é¡§å®¢"] = "ã™ã¹ã¦"
            st.session_state["filter_ç™ºè¡Œè€…"] = "ã™ã¹ã¦"
            st.session_state["filter_æ‹…å½“éƒ¨ç½²"] = "ã™ã¹ã¦"
            st.session_state["filter_æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"] = ""
            
            st.rerun()

    # 1è¡Œç›®ï¼šæ¡ˆä»¶åã§æ¤œç´¢
    æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ = st.text_input(
        "ğŸ” æ¡ˆä»¶åã§æ¤œç´¢", 
        placeholder="æ¡ˆä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
        value=st.session_state.get("filter_æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰", ""),
        key="search_input"
    )
    st.session_state["filter_æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"] = æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    
    # 2è¡Œç›®ï¼šå£²ä¸Šå¹´åº¦ã€å£²ä¸Šæœˆã€é¡§å®¢ã€ç™ºè¡Œè€…ã€æ‹…å½“éƒ¨ç½²ï¼ˆ5ç­‰åˆ†ï¼‰
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        # å£²ä¸Šå¹´åº¦ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå¹´åº¦è¨ˆç®—ä¿®æ­£ç‰ˆï¼‰
        å£²ä¸Šå¹´åº¦ãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦"]
        å¹´åº¦ã‚»ãƒƒãƒˆ = set()
        
        # æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§å¹´åº¦ã‚’æŠ½å‡º
        æ¡ˆä»¶ãƒªã‚¹ãƒˆ = load_all_projects()
        
        # ç´å“æ—¥ã‹ã‚‰å¹´åº¦ã‚’æŠ½å‡ºï¼ˆ4æœˆ-3æœˆãƒ™ãƒ¼ã‚¹ï¼‰
        for æ¡ˆä»¶ in æ¡ˆä»¶ãƒªã‚¹ãƒˆ:
            if æ¡ˆä»¶["ç´å“æ—¥"]:
                try:
                    ç´å“æ—¥ = æ¡ˆä»¶["ç´å“æ—¥"]
                    # å¹´åº¦è¨ˆç®—ï¼ˆ4æœˆ-3æœˆï¼‰
                    if ç´å“æ—¥.month >= 4:
                        å¹´åº¦ = ç´å“æ—¥.year
                    else:
                        å¹´åº¦ = ç´å“æ—¥.year - 1
                    å¹´åº¦ã‚»ãƒƒãƒˆ.add(å¹´åº¦)
                except:
                    pass
        
        # å¹´åº¦ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ 
        if å¹´åº¦ã‚»ãƒƒãƒˆ:
            å¹´åº¦ãƒªã‚¹ãƒˆ = sorted(list(å¹´åº¦ã‚»ãƒƒãƒˆ), reverse=True)
            for å¹´åº¦ in å¹´åº¦ãƒªã‚¹ãƒˆ:
                å£²ä¸Šå¹´åº¦ãƒªã‚¹ãƒˆ.append(f"{å¹´åº¦}å¹´åº¦")
        
        # åˆæœŸå€¤ã‚’è¨­å®š
        åˆæœŸå¹´åº¦index = 0
        if st.session_state.get("filter_å£²ä¸Šå¹´åº¦") in å£²ä¸Šå¹´åº¦ãƒªã‚¹ãƒˆ:
            åˆæœŸå¹´åº¦index = å£²ä¸Šå¹´åº¦ãƒªã‚¹ãƒˆ.index(st.session_state.get("filter_å£²ä¸Šå¹´åº¦"))
        
        é¸æŠå¹´åº¦ = st.selectbox(
            "å£²ä¸Šå¹´åº¦", 
            å£²ä¸Šå¹´åº¦ãƒªã‚¹ãƒˆ,
            index=åˆæœŸå¹´åº¦index,
            key="select_å¹´åº¦"
        )
        st.session_state["filter_å£²ä¸Šå¹´åº¦"] = é¸æŠå¹´åº¦
    
    with col2:
        # å£²ä¸Šæœˆã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæœˆã®ã¿ã®é¸æŠã«å¤‰æ›´ï¼‰
        å£²ä¸Šæœˆãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦", "1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", 
                        "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"]
        
        # åˆæœŸå€¤ã‚’è¨­å®š
        åˆæœŸæœˆindex = 0
        if st.session_state.get("filter_å£²ä¸Šæœˆ") in å£²ä¸Šæœˆãƒªã‚¹ãƒˆ:
            åˆæœŸæœˆindex = å£²ä¸Šæœˆãƒªã‚¹ãƒˆ.index(st.session_state.get("filter_å£²ä¸Šæœˆ"))
        
        é¸æŠæœˆ = st.selectbox(
            "å£²ä¸Šæœˆ", 
            å£²ä¸Šæœˆãƒªã‚¹ãƒˆ,
            index=åˆæœŸæœˆindex,
            key="select_æœˆ"
        )
        st.session_state["filter_å£²ä¸Šæœˆ"] = é¸æŠæœˆ

    with col3:
        # é¡§å®¢ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé¡§å®¢Noé †ã§ä¸¦ã³æ›¿ãˆï¼‰
        try:
            # é¡§å®¢JSONã‹ã‚‰é¡§å®¢Noé †ã§ä¼šç¤¾åã‚’å–å¾—
            é¡§å®¢ä¸€è¦§ = load_customers_json()
            if é¡§å®¢ä¸€è¦§:
                # é¡§å®¢Noã§ã‚½ãƒ¼ãƒˆã—ã¦ã‹ã‚‰ä¼šç¤¾åã‚’å–å¾—
                é¡§å®¢ä¸€è¦§.sort(key=lambda x: (x.get("é¡§å®¢No", 999), x.get("é¡§å®¢ä¼šç¤¾å", "")))
                é¡§å®¢ä¼šç¤¾åãƒªã‚¹ãƒˆ = []
                for é¡§å®¢ in é¡§å®¢ä¸€è¦§:
                    ä¼šç¤¾å = é¡§å®¢.get("é¡§å®¢ä¼šç¤¾å", "")
                    if ä¼šç¤¾å and ä¼šç¤¾å not in é¡§å®¢ä¼šç¤¾åãƒªã‚¹ãƒˆ:
                        é¡§å®¢ä¼šç¤¾åãƒªã‚¹ãƒˆ.append(ä¼šç¤¾å)
                
                é¡§å®¢ãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦"] + é¡§å®¢ä¼šç¤¾åãƒªã‚¹ãƒˆ
            else:
                # é¡§å®¢JSONãŒç©ºã®å ´åˆã¯æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                é¡§å®¢ãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦"] + sorted(list(set([æ¡ˆä»¶["é¡§å®¢ä¼šç¤¾å"] for æ¡ˆä»¶ in æ¡ˆä»¶ãƒªã‚¹ãƒˆ if æ¡ˆä»¶["é¡§å®¢ä¼šç¤¾å"]])))
        except:
            # ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å¾“æ¥é€šã‚Š
            é¡§å®¢ãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦"] + sorted(list(set([æ¡ˆä»¶["é¡§å®¢ä¼šç¤¾å"] for æ¡ˆä»¶ in æ¡ˆä»¶ãƒªã‚¹ãƒˆ if æ¡ˆä»¶["é¡§å®¢ä¼šç¤¾å"]])))
        
        # åˆæœŸå€¤ã‚’è¨­å®š
        åˆæœŸé¡§å®¢index = 0
        if st.session_state.get("filter_é¡§å®¢") in é¡§å®¢ãƒªã‚¹ãƒˆ:
            åˆæœŸé¡§å®¢index = é¡§å®¢ãƒªã‚¹ãƒˆ.index(st.session_state.get("filter_é¡§å®¢"))
        
        é¸æŠé¡§å®¢ = st.selectbox(
            "é¡§å®¢", 
            é¡§å®¢ãƒªã‚¹ãƒˆ,
            index=åˆæœŸé¡§å®¢index,
            key="select_é¡§å®¢"
        )
        st.session_state["filter_é¡§å®¢"] = é¸æŠé¡§å®¢
    
    with col4:
        # ç™ºè¡Œè€…ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
        ç™ºè¡Œè€…ãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦"] + sorted(list(set([æ¡ˆä»¶["ç™ºè¡Œè€…å"] for æ¡ˆä»¶ in æ¡ˆä»¶ãƒªã‚¹ãƒˆ if æ¡ˆä»¶["ç™ºè¡Œè€…å"]])))
        
        # åˆæœŸå€¤ã‚’è¨­å®š
        åˆæœŸç™ºè¡Œè€…index = 0
        if st.session_state.get("filter_ç™ºè¡Œè€…") in ç™ºè¡Œè€…ãƒªã‚¹ãƒˆ:
            åˆæœŸç™ºè¡Œè€…index = ç™ºè¡Œè€…ãƒªã‚¹ãƒˆ.index(st.session_state.get("filter_ç™ºè¡Œè€…"))
        
        é¸æŠç™ºè¡Œè€… = st.selectbox(
            "ç™ºè¡Œè€…", 
            ç™ºè¡Œè€…ãƒªã‚¹ãƒˆ,
            index=åˆæœŸç™ºè¡Œè€…index,
            key="select_ç™ºè¡Œè€…"
        )
        st.session_state["filter_ç™ºè¡Œè€…"] = é¸æŠç™ºè¡Œè€…
    
    with col5:
        # æ‹…å½“éƒ¨ç½²ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ–°è¦è¿½åŠ ï¼‰
        æ‹…å½“éƒ¨ç½²ãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦"] + sorted(list(set([æ¡ˆä»¶["æ‹…å½“éƒ¨ç½²"] for æ¡ˆä»¶ in æ¡ˆä»¶ãƒªã‚¹ãƒˆ if æ¡ˆä»¶.get("æ‹…å½“éƒ¨ç½²")])))
        
        # åˆæœŸå€¤ã‚’è¨­å®š
        åˆæœŸæ‹…å½“éƒ¨ç½²index = 0
        if st.session_state.get("filter_æ‹…å½“éƒ¨ç½²") in æ‹…å½“éƒ¨ç½²ãƒªã‚¹ãƒˆ:
            åˆæœŸæ‹…å½“éƒ¨ç½²index = æ‹…å½“éƒ¨ç½²ãƒªã‚¹ãƒˆ.index(st.session_state.get("filter_æ‹…å½“éƒ¨ç½²"))
        
        é¸æŠæ‹…å½“éƒ¨ç½² = st.selectbox(
            "æ‹…å½“éƒ¨ç½²", 
            æ‹…å½“éƒ¨ç½²ãƒªã‚¹ãƒˆ,
            index=åˆæœŸæ‹…å½“éƒ¨ç½²index,
            key="select_æ‹…å½“éƒ¨ç½²"
        )
        st.session_state["filter_æ‹…å½“éƒ¨ç½²"] = é¸æŠæ‹…å½“éƒ¨ç½²

    # 4è¡Œç›®ï¼šçŠ¶æ³ï¼ˆå«ã‚€ï¼‰ã€çŠ¶æ³ï¼ˆé™¤ãï¼‰ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ2ç­‰åˆ†ãƒ»èƒŒæ™¯è‰²ä»˜ãï¼‰
    col1, col2 = st.columns(2)
    
    with col1:
        # çŠ¶æ³ï¼ˆå«ã‚€ï¼‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«é’ã„èƒŒæ™¯è‰²
        st.info("**çŠ¶æ³ï¼ˆå«ã‚€ï¼‰**")
    
    with col2:
        # çŠ¶æ³ï¼ˆé™¤ãï¼‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«é»„è‰²ã„èƒŒæ™¯è‰²
        st.warning("**çŠ¶æ³ï¼ˆé™¤ãï¼‰**")
    
    # 5è¡Œç›®ï¼šã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼ˆ2ç­‰åˆ†ï¼‰
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("ğŸ§¹ å«ã‚€ã‚’ã‚¯ãƒªã‚¢", key="clear_include_status", help="çŠ¶æ³ï¼ˆå«ã‚€ï¼‰ã®é¸æŠã‚’ã™ã¹ã¦è§£é™¤"):
            # å«ã‚€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
            for çŠ¶æ³ in ["è¦‹ç©ä¸­", "å—æ³¨", "ç´å“æ¸ˆ", "è«‹æ±‚æ¸ˆ", "ä¸æ¡ç”¨", "å¤±æ³¨"]:
                st.session_state[f"include_{çŠ¶æ³}"] = False
            st.rerun()
    
    with col2:
        if st.button("ğŸ§¹ é™¤ãã‚’ã‚¯ãƒªã‚¢", key="clear_exclude_status", help="çŠ¶æ³ï¼ˆé™¤ãï¼‰ã®é¸æŠã‚’ã™ã¹ã¦è§£é™¤"):
            # é™¤ããƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
            for çŠ¶æ³ in ["è¦‹ç©ä¸­", "å—æ³¨", "ç´å“æ¸ˆ", "è«‹æ±‚æ¸ˆ", "ä¸æ¡ç”¨", "å¤±æ³¨"]:
                st.session_state[f"exclude_{çŠ¶æ³}"] = False
            st.rerun()
    
    # 6è¡Œç›®ä»¥é™ï¼šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆ2ç­‰åˆ†ã€ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤ºï¼‰
    col1, col2 = st.columns(2)
    
    çŠ¶æ³é¸æŠè‚¢ = ["è¦‹ç©ä¸­", "å—æ³¨", "ç´å“æ¸ˆ", "è«‹æ±‚æ¸ˆ", "ä¸æ¡ç”¨", "å¤±æ³¨"]
    
    with col1:
        # çŠ¶æ³ï¼ˆå«ã‚€ï¼‰ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ - ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤º
        # 1æ®µç›®ï¼šè¦‹ç©ä¸­ã€å—æ³¨ã€ç´å“æ¸ˆ
        check_row1_col1, check_row1_col2, check_row1_col3 = st.columns(3)
        with check_row1_col1:
            è¦‹ç©ä¸­_checked = st.checkbox("è¦‹ç©ä¸­", key="include_è¦‹ç©ä¸­_ui", value=st.session_state.get("include_è¦‹ç©ä¸­", False))
            st.session_state["include_è¦‹ç©ä¸­"] = è¦‹ç©ä¸­_checked
        with check_row1_col2:
            å—æ³¨_checked = st.checkbox("å—æ³¨", key="include_å—æ³¨_ui", value=st.session_state.get("include_å—æ³¨", False))
            st.session_state["include_å—æ³¨"] = å—æ³¨_checked
        with check_row1_col3:
            ç´å“æ¸ˆ_checked = st.checkbox("ç´å“æ¸ˆ", key="include_ç´å“æ¸ˆ_ui", value=st.session_state.get("include_ç´å“æ¸ˆ", False))
            st.session_state["include_ç´å“æ¸ˆ"] = ç´å“æ¸ˆ_checked
        
        # 2æ®µç›®ï¼šè«‹æ±‚æ¸ˆã€ä¸æ¡ç”¨ã€å¤±æ³¨
        check_row2_col1, check_row2_col2, check_row2_col3 = st.columns(3)
        with check_row2_col1:
            è«‹æ±‚æ¸ˆ_checked = st.checkbox("è«‹æ±‚æ¸ˆ", key="include_è«‹æ±‚æ¸ˆ_ui", value=st.session_state.get("include_è«‹æ±‚æ¸ˆ", False))
            st.session_state["include_è«‹æ±‚æ¸ˆ"] = è«‹æ±‚æ¸ˆ_checked
        with check_row2_col2:
            ä¸æ¡ç”¨_checked = st.checkbox("ä¸æ¡ç”¨", key="include_ä¸æ¡ç”¨_ui", value=st.session_state.get("include_ä¸æ¡ç”¨", False))
            st.session_state["include_ä¸æ¡ç”¨"] = ä¸æ¡ç”¨_checked
        with check_row2_col3:
            å¤±æ³¨_checked = st.checkbox("å¤±æ³¨", key="include_å¤±æ³¨_ui", value=st.session_state.get("include_å¤±æ³¨", False))
            st.session_state["include_å¤±æ³¨"] = å¤±æ³¨_checked
    
    with col2:
        # çŠ¶æ³ï¼ˆé™¤ãï¼‰ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ - ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤º
        # 1æ®µç›®ï¼šè¦‹ç©ä¸­ã€å—æ³¨ã€ç´å“æ¸ˆ
        exclude_row1_col1, exclude_row1_col2, exclude_row1_col3 = st.columns(3)
        with exclude_row1_col1:
            è¦‹ç©ä¸­_excluded = st.checkbox("è¦‹ç©ä¸­", key="exclude_è¦‹ç©ä¸­_ui", value=st.session_state.get("exclude_è¦‹ç©ä¸­", False))
            st.session_state["exclude_è¦‹ç©ä¸­"] = è¦‹ç©ä¸­_excluded
        with exclude_row1_col2:
            å—æ³¨_excluded = st.checkbox("å—æ³¨", key="exclude_å—æ³¨_ui", value=st.session_state.get("exclude_å—æ³¨", False))
            st.session_state["exclude_å—æ³¨"] = å—æ³¨_excluded
        with exclude_row1_col3:
            ç´å“æ¸ˆ_excluded = st.checkbox("ç´å“æ¸ˆ", key="exclude_ç´å“æ¸ˆ_ui", value=st.session_state.get("exclude_ç´å“æ¸ˆ", False))
            st.session_state["exclude_ç´å“æ¸ˆ"] = ç´å“æ¸ˆ_excluded
        
        # 2æ®µç›®ï¼šè«‹æ±‚æ¸ˆã€ä¸æ¡ç”¨ã€å¤±æ³¨
        exclude_row2_col1, exclude_row2_col2, exclude_row2_col3 = st.columns(3)
        with exclude_row2_col1:
            è«‹æ±‚æ¸ˆ_excluded = st.checkbox("è«‹æ±‚æ¸ˆ", key="exclude_è«‹æ±‚æ¸ˆ_ui", value=st.session_state.get("exclude_è«‹æ±‚æ¸ˆ", False))
            st.session_state["exclude_è«‹æ±‚æ¸ˆ"] = è«‹æ±‚æ¸ˆ_excluded
        with exclude_row2_col2:
            ä¸æ¡ç”¨_excluded = st.checkbox("ä¸æ¡ç”¨", key="exclude_ä¸æ¡ç”¨_ui", value=st.session_state.get("exclude_ä¸æ¡ç”¨", False))
            st.session_state["exclude_ä¸æ¡ç”¨"] = ä¸æ¡ç”¨_excluded
        with exclude_row2_col3:
            å¤±æ³¨_excluded = st.checkbox("å¤±æ³¨", key="exclude_å¤±æ³¨_ui", value=st.session_state.get("exclude_å¤±æ³¨", False))
            st.session_state["exclude_å¤±æ³¨"] = å¤±æ³¨_excluded

    # çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
    if çµã‚Šè¾¼ã¿å®Ÿè¡Œ:
        é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦ = st.session_state.get("filter_å£²ä¸Šå¹´åº¦", "ã™ã¹ã¦")
        é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ = st.session_state.get("filter_å£²ä¸Šæœˆ", "ã™ã¹ã¦")
        é¸æŠã•ã‚ŒãŸé¡§å®¢ = st.session_state.get("filter_é¡§å®¢", "ã™ã¹ã¦")
        é¸æŠã•ã‚ŒãŸç™ºè¡Œè€… = st.session_state.get("filter_ç™ºè¡Œè€…", "ã™ã¹ã¦")
        é¸æŠã•ã‚ŒãŸæ‹…å½“éƒ¨ç½² = st.session_state.get("filter_æ‹…å½“éƒ¨ç½²", "ã™ã¹ã¦")
        æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ = st.session_state.get("filter_æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰", "")
        
        # çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ã‚’å–å¾—ï¼ˆä¿®æ­£ã•ã‚ŒãŸçŠ¶æ³ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ï¼‰
        é¸æŠã•ã‚ŒãŸçŠ¶æ³å«ã‚€ = []
        é¸æŠã•ã‚ŒãŸçŠ¶æ³é™¤ã = []
        for çŠ¶æ³ in ["è¦‹ç©ä¸­", "å—æ³¨", "ç´å“æ¸ˆ", "è«‹æ±‚æ¸ˆ", "ä¸æ¡ç”¨", "å¤±æ³¨"]:
            if st.session_state.get(f"include_{çŠ¶æ³}", False):
                é¸æŠã•ã‚ŒãŸçŠ¶æ³å«ã‚€.append(çŠ¶æ³)
            if st.session_state.get(f"exclude_{çŠ¶æ³}", False):
                é¸æŠã•ã‚ŒãŸçŠ¶æ³é™¤ã.append(çŠ¶æ³)
    else:
        # çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨ä»¶è¡¨ç¤º
        é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦ = "ã™ã¹ã¦"
        é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ = "ã™ã¹ã¦"
        é¸æŠã•ã‚ŒãŸé¡§å®¢ = "ã™ã¹ã¦"
        é¸æŠã•ã‚ŒãŸç™ºè¡Œè€… = "ã™ã¹ã¦"
        é¸æŠã•ã‚ŒãŸæ‹…å½“éƒ¨ç½² = "ã™ã¹ã¦"
        æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ = ""
        é¸æŠã•ã‚ŒãŸçŠ¶æ³å«ã‚€ = []
        é¸æŠã•ã‚ŒãŸçŠ¶æ³é™¤ã = []

    # ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å‡¦ç†ï¼ˆå¹´åº¦ãƒ»æœˆé€£å‹•å¯¾å¿œç‰ˆï¼‰
    ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = æ¡ˆä»¶ãƒªã‚¹ãƒˆ.copy()
    
    # å¹´åº¦ãƒ»æœˆã®é€£å‹•ãƒ•ã‚£ãƒ«ã‚¿
    if é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦ != "ã™ã¹ã¦" or é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ != "ã™ã¹ã¦":
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = []
        for æ¡ˆä»¶ in æ¡ˆä»¶ãƒªã‚¹ãƒˆ:
            if not æ¡ˆä»¶["ç´å“æ—¥"]:
                continue
            
            ç´å“æ—¥ = æ¡ˆä»¶["ç´å“æ—¥"]
            
            # å¹´åº¦ã®è¨ˆç®—ï¼ˆ4æœˆ-3æœˆãƒ™ãƒ¼ã‚¹ï¼‰
            if ç´å“æ—¥.month >= 4:
                æ¡ˆä»¶å¹´åº¦ = ç´å“æ—¥.year
            else:
                æ¡ˆä»¶å¹´åº¦ = ç´å“æ—¥.year - 1
            
            # å¹´åº¦ãƒ•ã‚£ãƒ«ã‚¿ã®ãƒã‚§ãƒƒã‚¯
            å¹´åº¦ä¸€è‡´ = True
            if é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦ != "ã™ã¹ã¦":
                æŒ‡å®šå¹´åº¦ = int(é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦.replace("å¹´åº¦", ""))
                å¹´åº¦ä¸€è‡´ = (æ¡ˆä»¶å¹´åº¦ == æŒ‡å®šå¹´åº¦)
            
            # æœˆãƒ•ã‚£ãƒ«ã‚¿ã®ãƒã‚§ãƒƒã‚¯
            æœˆä¸€è‡´ = True
            if é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ != "ã™ã¹ã¦":
                æŒ‡å®šæœˆ = int(é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ.replace("æœˆ", ""))
                æœˆä¸€è‡´ = (ç´å“æ—¥.month == æŒ‡å®šæœˆ)
            
            # ä¸¡æ–¹ã®æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã®ã¿è¿½åŠ 
            if å¹´åº¦ä¸€è‡´ and æœˆä¸€è‡´:
                ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶.append(æ¡ˆä»¶)
    
    if é¸æŠã•ã‚ŒãŸç™ºè¡Œè€… != "ã™ã¹ã¦":
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = [æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¡ˆä»¶["ç™ºè¡Œè€…å"] == é¸æŠã•ã‚ŒãŸç™ºè¡Œè€…]
    
    if é¸æŠã•ã‚ŒãŸé¡§å®¢ != "ã™ã¹ã¦":
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = [æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¡ˆä»¶["é¡§å®¢ä¼šç¤¾å"] == é¸æŠã•ã‚ŒãŸé¡§å®¢]
    
    # æ‹…å½“éƒ¨ç½²ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ–°è¦è¿½åŠ ï¼‰
    if é¸æŠã•ã‚ŒãŸæ‹…å½“éƒ¨ç½² != "ã™ã¹ã¦":
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = [æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¡ˆä»¶.get("æ‹…å½“éƒ¨ç½²") == é¸æŠã•ã‚ŒãŸæ‹…å½“éƒ¨ç½²]
    
    # çŠ¶æ³ï¼ˆå«ã‚€ï¼‰ãƒ•ã‚£ãƒ«ã‚¿ - è¤‡æ•°é¸æŠå¯¾å¿œ
    if é¸æŠã•ã‚ŒãŸçŠ¶æ³å«ã‚€:  # ãƒªã‚¹ãƒˆãŒç©ºã§ãªã„å ´åˆã®ã¿é©ç”¨
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = [æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¡ˆä»¶["çŠ¶æ³"] in é¸æŠã•ã‚ŒãŸçŠ¶æ³å«ã‚€]
    
    # çŠ¶æ³ï¼ˆé™¤ãï¼‰ãƒ•ã‚£ãƒ«ã‚¿ - è¤‡æ•°é¸æŠå¯¾å¿œ
    if é¸æŠã•ã‚ŒãŸçŠ¶æ³é™¤ã:  # ãƒªã‚¹ãƒˆãŒç©ºã§ãªã„å ´åˆã®ã¿é©ç”¨
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = [æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¡ˆä»¶["çŠ¶æ³"] not in é¸æŠã•ã‚ŒãŸçŠ¶æ³é™¤ã]
    
    if æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ = [æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ in æ¡ˆä»¶["æ¡ˆä»¶å"]]
    
    # çµ±è¨ˆæƒ…å ±
    st.subheader("ğŸ“Š çµ±è¨ˆæƒ…å ±")
    
    # ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ã§ã®çµ±è¨ˆè¨ˆç®—
    ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ä»¶æ•° = len(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶)
    
    # å£²ä¸Šè¦‹è¾¼ã¿ï¼ˆå—æ³¨ï½è«‹æ±‚æ¸ˆã¿ï¼‰
    å£²ä¸Šè¦‹è¾¼ã¿çŠ¶æ³ = ["å—æ³¨", "ç´å“æ¸ˆ", "è«‹æ±‚æ¸ˆ"]
    å£²ä¸Šè¦‹è¾¼ã¿ = sum([
        æ¡ˆä»¶["å£²ä¸Šé¡"] for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ 
        if æ¡ˆä»¶["çŠ¶æ³"] in å£²ä¸Šè¦‹è¾¼ã¿çŠ¶æ³
    ])
    
    # å£²ä¸Šåˆè¨ˆï¼ˆè«‹æ±‚æ¸ˆã¿ã®ã¿ï¼‰
    å£²ä¸Šåˆè¨ˆ = sum([
        æ¡ˆä»¶["å£²ä¸Šé¡"] for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ 
        if æ¡ˆä»¶["çŠ¶æ³"] == "è«‹æ±‚æ¸ˆ"
    ])
    
    # è¦‹ç©ä¸­ä»¶æ•°
    è¦‹ç©ä¸­ä»¶æ•° = len([æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¡ˆä»¶["çŠ¶æ³"] == "è¦‹ç©ä¸­"])
    
    # è«‹æ±‚æ¸ˆã¿ä»¶æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
    è«‹æ±‚æ¸ˆã¿ä»¶æ•° = len([æ¡ˆä»¶ for æ¡ˆä»¶ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ if æ¡ˆä»¶["çŠ¶æ³"] == "è«‹æ±‚æ¸ˆ"])
    
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        st.metric("æ¡ˆä»¶æ•°", ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ä»¶æ•°)
    
    with col2:
        st.metric("è¦‹ç©ä¸­", è¦‹ç©ä¸­ä»¶æ•°)
    
    with col3:
        st.metric("è«‹æ±‚æ¸ˆã¿", è«‹æ±‚æ¸ˆã¿ä»¶æ•°)
    
    with col4:
        st.metric("å£²ä¸Šè¦‹è¾¼ã¿", f"Â¥{å£²ä¸Šè¦‹è¾¼ã¿:,}")
    
    with col5:
        st.metric("å£²ä¸Šåˆè¨ˆ", f"Â¥{å£²ä¸Šåˆè¨ˆ:,}")
    
    # é¸æŠã•ã‚ŒãŸæ¡ä»¶ã®è¡¨ç¤ºï¼ˆå¹´åº¦ãƒ»æœˆé€£å‹•å¯¾å¿œï¼‰
    è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ = []
    if é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦ != "ã™ã¹ã¦" and é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ != "ã™ã¹ã¦":
        # å¹´åº¦ã¨æœˆãŒä¸¡æ–¹é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
        å¹´åº¦ = int(é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦.replace("å¹´åº¦", ""))
        æœˆ = int(é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ.replace("æœˆ", ""))
        
        # å¹´åº¦ã«åŸºã¥ã„ã¦å®Ÿéš›ã®å¹´ã‚’è¨ˆç®—
        if æœˆ >= 4:
            å®Ÿå¹´ = å¹´åº¦
        else:
            å®Ÿå¹´ = å¹´åº¦ + 1
        
        è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸.append(f"ğŸ“… {å®Ÿå¹´}å¹´{æœˆ}æœˆï¼ˆ{é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦}ï¼‰")
    
    elif é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦ != "ã™ã¹ã¦":
        è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸.append(f"ğŸ“… {é¸æŠã•ã‚ŒãŸå£²ä¸Šå¹´åº¦}")
    elif é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ != "ã™ã¹ã¦":
        è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸.append(f"ğŸ“… {é¸æŠã•ã‚ŒãŸå£²ä¸Šæœˆ}")
    
    if é¸æŠã•ã‚ŒãŸçŠ¶æ³å«ã‚€:
        è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸.append(f"ğŸ¯ å«ã‚€: {', '.join(é¸æŠã•ã‚ŒãŸçŠ¶æ³å«ã‚€)}")
    if é¸æŠã•ã‚ŒãŸçŠ¶æ³é™¤ã:
        è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸.append(f"âŒ é™¤ã: {', '.join(é¸æŠã•ã‚ŒãŸçŠ¶æ³é™¤ã)}")
    
    if è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:
        st.info(" | ".join(è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) + " ã®æ¡ä»¶ã§è¡¨ç¤ºä¸­")
    
    st.divider()
    
    # æ¡ˆä»¶ä¸€è¦§ã®è¡¨ç¤ºï¼ˆè¡¨ç¤ºæ”¹å–„ç‰ˆï¼‰
    st.subheader(f"ğŸ“‹ æ¡ˆä»¶ä¸€è¦§ ({len(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶)}ä»¶)")

    if not ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶:
        st.info("æ¡ä»¶ã«åˆè‡´ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return

    # æ¡ˆä»¶ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆæ–‡å­—ã‚µã‚¤ã‚ºæ‹¡å¤§ãƒ»éƒ¨ç½²åˆ¥é›†è¨ˆæ”¹å–„ï¼‰
    for i, æ¡ˆä»¶ in enumerate(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶):
        # éƒ¨ç½²åˆ¥é›†è¨ˆã‚’è¨ˆç®—ï¼ˆæ”¹å–„ç‰ˆï¼‰
        éƒ¨ç½²åˆ¥é›†è¨ˆè¡¨ç¤º = ""
        ç·é¡ = æ¡ˆä»¶.get("å£²ä¸Šé¡", 0)
        
        try:
            æ˜ç´°ãƒªã‚¹ãƒˆ = æ¡ˆä»¶.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
            æ¡ˆä»¶æ‹…å½“éƒ¨ç½² = æ¡ˆä»¶.get("æ‹…å½“éƒ¨ç½²", "")
            
            if æ˜ç´°ãƒªã‚¹ãƒˆ:
                éƒ¨ç½²åˆ¥é›†è¨ˆ = {}
                æ˜ç´°åˆè¨ˆ = 0
                
                for row in æ˜ç´°ãƒªã‚¹ãƒˆ:
                    é‡‘é¡ = row.get("é‡‘é¡", 0)
                    æ˜ç´°åˆè¨ˆ += é‡‘é¡
                    
                    å£²ä¸Šå…ˆéƒ¨ç½² = row.get("å£²ä¸Šå…ˆéƒ¨ç½²", "")
                    ä½¿ç”¨éƒ¨ç½² = å£²ä¸Šå…ˆéƒ¨ç½² if å£²ä¸Šå…ˆéƒ¨ç½² else æ¡ˆä»¶æ‹…å½“éƒ¨ç½²
                    
                    if ä½¿ç”¨éƒ¨ç½²:
                        if ä½¿ç”¨éƒ¨ç½² in éƒ¨ç½²åˆ¥é›†è¨ˆ:
                            éƒ¨ç½²åˆ¥é›†è¨ˆ[ä½¿ç”¨éƒ¨ç½²] += é‡‘é¡
                        else:
                            éƒ¨ç½²åˆ¥é›†è¨ˆ[ä½¿ç”¨éƒ¨ç½²] = é‡‘é¡
                
                # éƒ¨ç½²åˆ¥é›†è¨ˆã®è¡¨ç¤ºå½¢å¼ã‚’æ”¹å–„
                if éƒ¨ç½²åˆ¥é›†è¨ˆ:
                    éƒ¨ç½²æ•° = len(éƒ¨ç½²åˆ¥é›†è¨ˆ)
                    if éƒ¨ç½²æ•° > 1:
                        # è¤‡æ•°éƒ¨ç½²ã®å ´åˆï¼šç·é¡ã‚’å…ˆé ­ã«è¡¨ç¤º
                        éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ = [f"ç·é¡:Â¥{ç·é¡:,}"]
                        for éƒ¨ç½², é‡‘é¡ in sorted(éƒ¨ç½²åˆ¥é›†è¨ˆ.items()):
                            éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ.append(f"{éƒ¨ç½²}:Â¥{é‡‘é¡:,}")
                        éƒ¨ç½²åˆ¥é›†è¨ˆè¡¨ç¤º = f" ({' | '.join(éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ)})"
                    else:
                        # å˜ä¸€éƒ¨ç½²ã®å ´åˆï¼šå¾“æ¥é€šã‚Š
                        éƒ¨ç½², é‡‘é¡ = list(éƒ¨ç½²åˆ¥é›†è¨ˆ.items())[0]
                        éƒ¨ç½²åˆ¥é›†è¨ˆè¡¨ç¤º = f" ({éƒ¨ç½²}:Â¥{é‡‘é¡:,})"
        except:
            pass

        # æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«ã«éƒ¨ç½²åˆ¥é›†è¨ˆã‚’å«ã‚ã‚‹ï¼ˆæ–‡å­—ã‚µã‚¤ã‚ºæ‹¡å¤§ï¼‰
        ã‚¿ã‚¤ãƒˆãƒ« = f"ğŸ“„ {æ¡ˆä»¶['è¦‹ç©No']} - {æ¡ˆä»¶['æ¡ˆä»¶å']} ({æ¡ˆä»¶['çŠ¶æ³']}){éƒ¨ç½²åˆ¥é›†è¨ˆè¡¨ç¤º}"

        # Markdownã§æ–‡å­—ã‚µã‚¤ã‚ºã‚’æ‹¡å¤§
        with st.expander(ã‚¿ã‚¤ãƒˆãƒ«):
            # expanderã®ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã‚’å¤§ããè¡¨ç¤ºã™ã‚‹ãŸã‚ã®CSSé©ç”¨
            st.markdown(f"""
            <style>
            .streamlit-expanderHeader {{
                font-size: 18px !important;
                font-weight: bold !important;
            }}
            </style>
            """, unsafe_allow_html=True)
            
            # åŸºæœ¬æƒ…å ±
            col1, col2 = st.columns(2)
            
            with col1:
                st.write(f"**è¦‹ç©No:** {æ¡ˆä»¶['è¦‹ç©No']}")
                st.write(f"**æ¡ˆä»¶å:** {æ¡ˆä»¶['æ¡ˆä»¶å']}")
                st.write(f"**é¡§å®¢ä¼šç¤¾å:** {æ¡ˆä»¶['é¡§å®¢ä¼šç¤¾å']}")
                st.write(f"**é¡§å®¢æ‹…å½“è€…:** {æ¡ˆä»¶['é¡§å®¢æ‹…å½“è€…']}")
                st.write(f"**ç™ºè¡Œè€…:** {æ¡ˆä»¶['ç™ºè¡Œè€…å']}")
            
            with col2:
                st.write(f"**çŠ¶æ³:** {æ¡ˆä»¶['çŠ¶æ³']}")
                st.write(f"**ç™ºè¡Œæ—¥:** {æ¡ˆä»¶['ç™ºè¡Œæ—¥'] or 'æœªè¨­å®š'}")
                st.write(f"**å—æ³¨æ—¥:** {æ¡ˆä»¶['å—æ³¨æ—¥'] or 'æœªè¨­å®š'}")
                st.write(f"**ç´å“æ—¥:** {æ¡ˆä»¶['ç´å“æ—¥'] or 'æœªè¨­å®š'}")
            
            # é‡‘é¡æƒ…å ±
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("å£²ä¸Šé¡", f"Â¥{æ¡ˆä»¶['å£²ä¸Šé¡']:,}")
            with col2:
                st.metric("ä»•å…¥é¡", f"Â¥{æ¡ˆä»¶['ä»•å…¥é¡']:,}")
            with col3:
                if æ¡ˆä»¶['ç²—åˆ©'] >= 0:
                    st.metric("ç²—åˆ©", f"Â¥{æ¡ˆä»¶['ç²—åˆ©']:,}")
                else:
                    st.metric("ç²—åˆ©", f"Â¥{æ¡ˆä»¶['ç²—åˆ©']:,}", delta_color="inverse")
            with col4:
                st.metric("ç²—åˆ©ç‡", f"{æ¡ˆä»¶['ç²—åˆ©ç‡']:.1f}%")
            
            # ãƒ¡ãƒ¢
            if æ¡ˆä»¶['ãƒ¡ãƒ¢']:
                st.write(f"**ãƒ¡ãƒ¢:** {æ¡ˆä»¶['ãƒ¡ãƒ¢']}")
            
            # æ˜ç´°ã®éƒ¨ç½²åˆ¥é›†è¨ˆã‚’è¡¨ç¤º
            try:
                ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, æ¡ˆä»¶['JSONãƒ•ã‚¡ã‚¤ãƒ«'])
                with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "r", encoding="utf-8") as f:
                    è©³ç´°ãƒ‡ãƒ¼ã‚¿ = json.load(f)
                
                if isinstance(è©³ç´°ãƒ‡ãƒ¼ã‚¿, dict):
                    æ˜ç´°ãƒªã‚¹ãƒˆ = è©³ç´°ãƒ‡ãƒ¼ã‚¿.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
                    æ¡ˆä»¶æ‹…å½“éƒ¨ç½² = è©³ç´°ãƒ‡ãƒ¼ã‚¿.get("æ‹…å½“éƒ¨ç½²", "")
                    
                    if æ˜ç´°ãƒªã‚¹ãƒˆ:
                        # éƒ¨ç½²åˆ¥é›†è¨ˆã®è¨ˆç®—
                        éƒ¨ç½²åˆ¥é›†è¨ˆ = {}
                        æ˜ç´°åˆè¨ˆ = 0
                        
                        for row in æ˜ç´°ãƒªã‚¹ãƒˆ:
                            é‡‘é¡ = row.get("é‡‘é¡", 0)
                            æ˜ç´°åˆè¨ˆ += é‡‘é¡
                            
                            å£²ä¸Šå…ˆéƒ¨ç½² = row.get("å£²ä¸Šå…ˆéƒ¨ç½²", "")
                            # å£²ä¸Šå…ˆéƒ¨ç½²ãŒæœªè¨­å®šã®å ´åˆã¯æ¡ˆä»¶ã®æ‹…å½“éƒ¨ç½²ã‚’ä½¿ç”¨
                            ä½¿ç”¨éƒ¨ç½² = å£²ä¸Šå…ˆéƒ¨ç½² if å£²ä¸Šå…ˆéƒ¨ç½² else æ¡ˆä»¶æ‹…å½“éƒ¨ç½²
                            
                            if ä½¿ç”¨éƒ¨ç½²:
                                if ä½¿ç”¨éƒ¨ç½² in éƒ¨ç½²åˆ¥é›†è¨ˆ:
                                    éƒ¨ç½²åˆ¥é›†è¨ˆ[ä½¿ç”¨éƒ¨ç½²] += é‡‘é¡
                                else:
                                    éƒ¨ç½²åˆ¥é›†è¨ˆ[ä½¿ç”¨éƒ¨ç½²] = é‡‘é¡
                        
                        # æ˜ç´°åˆè¨ˆã®è¡¨ç¤º
                        st.write(f"**æ˜ç´°åˆè¨ˆ:** Â¥{æ˜ç´°åˆè¨ˆ:,}")
                        
                        # éƒ¨ç½²åˆ¥é›†è¨ˆã®è¡¨ç¤º
                        if éƒ¨ç½²åˆ¥é›†è¨ˆ:
                            éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ = []
                            for éƒ¨ç½², é‡‘é¡ in sorted(éƒ¨ç½²åˆ¥é›†è¨ˆ.items()):
                                éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ.append(f"{éƒ¨ç½²}: Â¥{é‡‘é¡:,}")
                            
                            if éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ:
                                st.write(f"**éƒ¨ç½²åˆ¥å†…è¨³:** {' | '.join(éƒ¨ç½²åˆ¥è¡¨ç¤ºãƒªã‚¹ãƒˆ)}")
                        
                        st.write(f"**æ˜ç´°ä»¶æ•°:** {len(æ˜ç´°ãƒªã‚¹ãƒˆ)}ä»¶")
            except Exception as e:
                pass  # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚æ¡ˆä»¶è¡¨ç¤ºã¯ç¶™ç¶š
            
            # æ“ä½œãƒœã‚¿ãƒ³
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                if st.button("ğŸ“ ç·¨é›†", key=f"edit_{æ¡ˆä»¶['è¦‹ç©No']}"):
                    # æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ï¼ˆã‚¿ãƒ–â‘¢ã«ç§»å‹•ï¼‰
                    if auto_load_json_by_estimate_no(æ¡ˆä»¶['è¦‹ç©No'], auto_rerun=False):
                        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                        st.success(f"æ¡ˆä»¶ {æ¡ˆä»¶['è¦‹ç©No']} ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ãã¾ã—ãŸ")
                        st.rerun()
                    else:
                        st.error("æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
            with col2:
                if st.button("ğŸ“‹ æ˜ç´°è¡¨ç¤º", key=f"detail_{æ¡ˆä»¶['è¦‹ç©No']}"):
                    # æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§æ˜ç´°è¡¨ç¤ºï¼ˆã‚¿ãƒ–â‘£ã«ç§»å‹•ï¼‰
                    if auto_load_json_by_estimate_no(æ¡ˆä»¶['è¦‹ç©No'], auto_rerun=False):
                        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘£ æ˜ç´°æƒ…å ±ã‚’å…¥åŠ›"
                        st.success(f"æ¡ˆä»¶ {æ¡ˆä»¶['è¦‹ç©No']} ã®æ˜ç´°ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ")
                        st.rerun()
                    else:
                        st.error("æ˜ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
            with col3:
                if st.button("ğŸ“„ ã‚³ãƒ”ãƒ¼", key=f"copy_{æ¡ˆä»¶['è¦‹ç©No']}"):
                    # æ¡ˆä»¶ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦æ¡ˆä»¶ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«
                    if copy_project_data(æ¡ˆä»¶['è¦‹ç©No']):
                        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                        st.success(f"æ¡ˆä»¶ {æ¡ˆä»¶['è¦‹ç©No']} ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚æ—¥ä»˜ã‚’æ›´æ–°ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚")
                        st.rerun()
                    else:
                        st.error("æ¡ˆä»¶ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
            with col4:
                # å‰Šé™¤ç¢ºèªçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                å‰Šé™¤ç¢ºèªä¸­ = st.session_state.get(f"å‰Šé™¤ç¢ºèª_{æ¡ˆä»¶['è¦‹ç©No']}", False)
                
                if not å‰Šé™¤ç¢ºèªä¸­:
                    # é€šå¸¸ã®å‰Šé™¤ãƒœã‚¿ãƒ³
                    if st.button("ğŸ—‘ï¸ å‰Šé™¤", key=f"delete_{æ¡ˆä»¶['è¦‹ç©No']}"):
                        st.session_state[f"å‰Šé™¤ç¢ºèª_{æ¡ˆä»¶['è¦‹ç©No']}"] = True
                        st.rerun()
                else:
                    # å‰Šé™¤ç¢ºèªä¸­ã®è¡¨ç¤º
                    st.warning("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")
            
            # å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆå‰Šé™¤ç¢ºèªä¸­ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰
            if st.session_state.get(f"å‰Šé™¤ç¢ºèª_{æ¡ˆä»¶['è¦‹ç©No']}", False):
                col1, col2 = st.columns(2)
                
                with col1:
                    if st.button("âœ… ã¯ã„ã€å‰Šé™¤ã—ã¾ã™", key=f"confirm_delete_{æ¡ˆä»¶['è¦‹ç©No']}", type="primary"):
                        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                        try:
                            ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, æ¡ˆä»¶['JSONãƒ•ã‚¡ã‚¤ãƒ«'])
                            if os.path.exists(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹):
                                os.remove(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹)
                                st.success(f"æ¡ˆä»¶ {æ¡ˆä»¶['è¦‹ç©No']} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                                # å‰Šé™¤ç¢ºèªãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
                                del st.session_state[f"å‰Šé™¤ç¢ºèª_{æ¡ˆä»¶['è¦‹ç©No']}"]
                                st.rerun()
                            else:
                                st.error("å‰Šé™¤å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                                # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¢ºèªãƒ•ãƒ©ã‚°ã¯ã‚¯ãƒªã‚¢
                                del st.session_state[f"å‰Šé™¤ç¢ºèª_{æ¡ˆä»¶['è¦‹ç©No']}"]
                        except Exception as e:
                            st.error(f"å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
                            # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¢ºèªãƒ•ãƒ©ã‚°ã¯ã‚¯ãƒªã‚¢
                            del st.session_state[f"å‰Šé™¤ç¢ºèª_{æ¡ˆä»¶['è¦‹ç©No']}"]
                
                with col2:
                    if st.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key=f"cancel_delete_{æ¡ˆä»¶['è¦‹ç©No']}"):
                        # å‰Šé™¤ç¢ºèªãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
                        del st.session_state[f"å‰Šé™¤ç¢ºèª_{æ¡ˆä»¶['è¦‹ç©No']}"]
                        st.rerun()

    # æ–°è¦æ¡ˆä»¶ä½œæˆãƒœã‚¿ãƒ³
    st.divider()
    if st.button("â• æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆ", type="primary", key="create_new_project"):
        # ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
        reset_all_data()
        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
        st.success("æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚")
        st.rerun()

# ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
def copy_project_data(å…ƒè¦‹ç©No):
    """æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦æ¡ˆä»¶ã¨ã—ã¦è¨­å®šï¼ˆä½æ‰€å¼•ãç¶™ãå¼·åŒ–ç‰ˆãƒ»ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼‰"""
    try:
        ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ = os.path.join(DATA_FOLDER, f"{å…ƒè¦‹ç©No}.json")
        
        if not os.path.exists(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹):
            return False

        with open(ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹, "r", encoding="utf-8") as f:
            data = json.load(f)
        
        if not isinstance(data, dict):
            return False

        # æ–°ã—ã„è¦‹ç©ç•ªå·ã‚’ç”Ÿæˆ
        ä»Šæ—¥ = datetime.date.today()
        æ–°è¦‹ç©No = generate_estimate_no(ä»Šæ—¥)
        
        # å…ƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¡§å®¢ä½æ‰€ã‚’ç¢ºå®Ÿã«å–å¾—
        å…ƒé¡§å®¢ä½æ‰€ = data.get("é¡§å®¢ä½æ‰€", "")
        å…ƒéƒµä¾¿ç•ªå· = data.get("éƒµä¾¿ç•ªå·", "")
        å…ƒä½æ‰€1 = data.get("ä½æ‰€1", "")
        å…ƒä½æ‰€2 = data.get("ä½æ‰€2", "")
        
        # ç´°åˆ†åŒ–ä½æ‰€ã®å„ªå…ˆå–å¾—
        if å…ƒéƒµä¾¿ç•ªå· or å…ƒä½æ‰€1 or å…ƒä½æ‰€2:
            # æ–°å½¢å¼ã®ä½æ‰€ãŒã‚ã‚‹å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            pass
        elif å…ƒé¡§å®¢ä½æ‰€ and str(å…ƒé¡§å®¢ä½æ‰€) != "nan":
            # æ—§å½¢å¼ã®ä½æ‰€ã®ã¿ã‚ã‚‹å ´åˆã¯åˆ†å‰²ã‚’è©¦è¡Œ
            try:
                from estimate_excel_writer import parse_address
                å…ƒéƒµä¾¿ç•ªå·, å…ƒä½æ‰€1, å…ƒä½æ‰€2 = parse_address(å…ƒé¡§å®¢ä½æ‰€)
            except ImportError:
                st.warning("estimate_excel_writer ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                å…ƒä½æ‰€1 = å…ƒé¡§å®¢ä½æ‰€  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            except Exception:
                å…ƒä½æ‰€1 = å…ƒé¡§å®¢ä½æ‰€  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        else:
            # JSONã«ä½æ‰€ãŒãªã„å ´åˆã¯é¡§å®¢ä¸€è¦§ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
            try:
                é¡§å®¢ä¸€è¦§ = load_customers_json()
                å…ƒé¡§å®¢ä¼šç¤¾å = data.get("é¡§å®¢ä¼šç¤¾å", "")
                å…ƒé¡§å®¢æ‹…å½“è€… = data.get("é¡§å®¢æ‹…å½“è€…", "")
                
                if å…ƒé¡§å®¢ä¼šç¤¾å and å…ƒé¡§å®¢æ‹…å½“è€… and é¡§å®¢ä¸€è¦§:
                    for customer in é¡§å®¢ä¸€è¦§:
                        if (customer.get("é¡§å®¢ä¼šç¤¾å") == å…ƒé¡§å®¢ä¼šç¤¾å and 
                            customer.get("é¡§å®¢æ‹…å½“è€…") == å…ƒé¡§å®¢æ‹…å½“è€…):
                            # æ–°å½¢å¼å„ªå…ˆ
                            if customer.get("éƒµä¾¿ç•ªå·") or customer.get("ä½æ‰€1") or customer.get("ä½æ‰€2"):
                                å…ƒéƒµä¾¿ç•ªå· = customer.get("éƒµä¾¿ç•ªå·", "")
                                å…ƒä½æ‰€1 = customer.get("ä½æ‰€1", "")
                                å…ƒä½æ‰€2 = customer.get("ä½æ‰€2", "")
                            else:
                                å…ƒé¡§å®¢ä½æ‰€ = customer.get("é¡§å®¢ä½æ‰€", "")
                                if å…ƒé¡§å®¢ä½æ‰€:
                                    try:
                                        from estimate_excel_writer import parse_address
                                        å…ƒéƒµä¾¿ç•ªå·, å…ƒä½æ‰€1, å…ƒä½æ‰€2 = parse_address(å…ƒé¡§å®¢ä½æ‰€)
                                    except ImportError:
                                        å…ƒä½æ‰€1 = å…ƒé¡§å®¢ä½æ‰€
                                    except Exception:
                                        å…ƒä½æ‰€1 = å…ƒé¡§å®¢ä½æ‰€
                            break
            except Exception:
                pass
        
        # ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«ã‚³ãƒ”ãƒ¼ï¼ˆæ—¥ä»˜ã¯ä»Šæ—¥ã«è¨­å®šï¼‰
        st.session_state["è¦‹ç©No"] = æ–°è¦‹ç©No
        st.session_state["æ¡ˆä»¶å"] = data.get("æ¡ˆä»¶å", "") + "ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰"
        st.session_state["ç™ºè¡Œæ—¥"] = ä»Šæ—¥  # ä»Šæ—¥ã®æ—¥ä»˜ã«å¤‰æ›´
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å"] = data.get("é¡§å®¢ä¼šç¤¾å", "")
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å"] = data.get("é¡§å®¢éƒ¨ç½²å", "")
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…"] = data.get("é¡§å®¢æ‹…å½“è€…", "")
        
        # ä½æ‰€æƒ…å ±ã®è¨­å®šï¼ˆç´°åˆ†åŒ–å¯¾å¿œï¼‰
        st.session_state["é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·"] = å…ƒéƒµä¾¿ç•ªå·
        st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€1"] = å…ƒä½æ‰€1
        st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€2"] = å…ƒä½æ‰€2
        çµ±åˆä½æ‰€ = f"{å…ƒéƒµä¾¿ç•ªå·} {å…ƒä½æ‰€1} {å…ƒä½æ‰€2}".strip()
        st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€"] = çµ±åˆä½æ‰€ if çµ±åˆä½æ‰€ else å…ƒé¡§å®¢ä½æ‰€
        
        st.session_state["ç™ºè¡Œè€…å"] = data.get("ç™ºè¡Œè€…å", ISSUER_LIST[0])
        st.session_state["æ‹…å½“éƒ¨ç½²"] = data.get("æ‹…å½“éƒ¨ç½²", "")
        st.session_state["æ˜ç´°ãƒªã‚¹ãƒˆ"] = data.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
        st.session_state["å‚™è€ƒ"] = data.get("å‚™è€ƒ", "")
        st.session_state["å£²ä¸Šé¡"] = int(data.get("å£²ä¸Šé¡", 0))
        st.session_state["ä»•å…¥é¡"] = int(data.get("ä»•å…¥é¡", 0))
        st.session_state["ç²—åˆ©"] = int(data.get("ç²—åˆ©", 0))
        st.session_state["ç²—åˆ©ç‡"] = float(data.get("ç²—åˆ©ç‡", 0.0))
        st.session_state["çŠ¶æ³"] = "è¦‹ç©ä¸­"  # æ–°è¦æ¡ˆä»¶ãªã®ã§è¦‹ç©ä¸­ã«è¨­å®š
        st.session_state["å—æ³¨æ—¥"] = None    # æ—¥ä»˜ã¯ç©ºã«è¨­å®š
        st.session_state["ç´å“æ—¥"] = None    # æ—¥ä»˜ã¯ç©ºã«è¨­å®š
        st.session_state["ãƒ¡ãƒ¢"] = data.get("ãƒ¡ãƒ¢", "")
        
        # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        if çµ±åˆä½æ‰€ or å…ƒé¡§å®¢ä½æ‰€:
            st.info(f"ä½æ‰€æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: {çµ±åˆä½æ‰€ or å…ƒé¡§å®¢ä½æ‰€}")
        else:
            st.warning("å…ƒæ¡ˆä»¶ã«ä½æ‰€æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é¡§å®¢æƒ…å ±ã§ä½æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        
        return True
        
    except Exception as e:
        st.error(f"ã‚³ãƒ”ãƒ¼å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return False

# ä»¥ä¸‹ã®é–¢æ•°ã‚’æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã«è¿½åŠ ã—ã¦ãã ã•ã„

def move_single_product(products_list, index, direction):
    """å˜ä¸€å•†å“ã®ä½ç½®ã‚’ç§»å‹•ï¼ˆJSONã«ä¿å­˜ï¼‰"""
    try:
        if direction == "up" and index > 0:
            # ä¸Šã«ç§»å‹•
            products_list[index-1], products_list[index] = products_list[index], products_list[index-1]
        elif direction == "down" and index < len(products_list) - 1:
            # ä¸‹ã«ç§»å‹•
            products_list[index+1], products_list[index] = products_list[index], products_list[index+1]
        
        # JSONã«ä¿å­˜
        if save_products_json(products_list):
            st.success(f"å•†å“ã®ä¸¦ã³é †ã‚’å¤‰æ›´ã—ã¾ã—ãŸ")
        else:
            st.error("ä¸¦ã³é †ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
    except Exception as e:
        st.error(f"ä¸¦ã³æ›¿ãˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

def move_selected_products(products_list, direction):
    """é¸æŠã•ã‚ŒãŸå•†å“ã‚’ä¸€æ‹¬ç§»å‹•ï¼ˆJSONã«ä¿å­˜ï¼‰"""
    try:
        selected_names = st.session_state.get("selected_products", set())
        if not selected_names:
            st.warning("ç§»å‹•ã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„")
            return
        
        # é¸æŠã•ã‚ŒãŸå•†å“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        selected_indices = []
        for i, product in enumerate(products_list):
            if product.get("å“å") in selected_names:
                selected_indices.append(i)
        
        if not selected_indices:
            st.warning("é¸æŠã•ã‚ŒãŸå•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            return
        
        # ç§»å‹•å‡¦ç†
        if direction == "up":
            # ä¸Šã«ç§»å‹•ï¼ˆå‰ã‹ã‚‰å‡¦ç†ï¼‰
            selected_indices.sort()
            for i in selected_indices:
                if i > 0:
                    # ç§»å‹•å…ˆãŒé¸æŠæ¸ˆã¿å•†å“ã§ãªã„å ´åˆã®ã¿ç§»å‹•
                    target_index = i - 1
                    if target_index not in selected_indices:
                        products_list[target_index], products_list[i] = products_list[i], products_list[target_index]
                        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                        selected_indices = [idx-1 if idx == i else idx for idx in selected_indices]
        
        elif direction == "down":
            # ä¸‹ã«ç§»å‹•ï¼ˆå¾Œã‚ã‹ã‚‰å‡¦ç†ï¼‰
            selected_indices.sort(reverse=True)
            for i in selected_indices:
                if i < len(products_list) - 1:
                    # ç§»å‹•å…ˆãŒé¸æŠæ¸ˆã¿å•†å“ã§ãªã„å ´åˆã®ã¿ç§»å‹•
                    target_index = i + 1
                    if target_index not in selected_indices:
                        products_list[target_index], products_list[i] = products_list[i], products_list[target_index]
                        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                        selected_indices = [idx+1 if idx == i else idx for idx in selected_indices]
        
        # JSONã«ä¿å­˜
        if save_products_json(products_list):
            st.success(f"é¸æŠã—ãŸ{len(selected_names)}ä»¶ã®å•†å“ã‚’{direction}ã«ç§»å‹•ã—ã¾ã—ãŸ")
        else:
            st.error("ä¸¦ã³é †ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
    except Exception as e:
        st.error(f"ä¸€æ‹¬ç§»å‹•ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# load_excel_dataé–¢æ•°ã‚‚å¿…è¦ã§ã™ãŒã€ä½¿ç”¨ã—ã¦ã„ãªã„ã‚ˆã†ãªã®ã§å‰Šé™¤ã™ã‚‹ã‹ã€ä»¥ä¸‹ã®ãƒ€ãƒŸãƒ¼é–¢æ•°ã‚’è¿½åŠ 
def load_excel_data(filename):
    """Excelãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ€ãƒŸãƒ¼é–¢æ•°ï¼‰"""
    # JSONã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ç©ºã®DataFrameã‚’è¿”ã™
    import pandas as pd
    é¡§å®¢ä¸€è¦§ = pd.DataFrame(columns=["é¡§å®¢No", "é¡§å®¢ä¼šç¤¾å", "é¡§å®¢éƒ¨ç½²å", "é¡§å®¢æ‹…å½“è€…", "é¡§å®¢ä½æ‰€"])
    æ¡ˆä»¶ä¸€è¦§ = pd.DataFrame(columns=["è¦‹ç©No", "æ¡ˆä»¶å", "é¡§å®¢ä¼šç¤¾å", "é¡§å®¢éƒ¨ç½²å", "é¡§å®¢æ‹…å½“è€…", "ç™ºè¡Œæ—¥", "å—æ³¨æ—¥", "ç´å“æ—¥", "å£²ä¸Šé¡", "ä»•å…¥é¡", "ç²—åˆ©", "ç²—åˆ©ç‡", "çŠ¶æ³", "ç™ºè¡Œè€…å", "ãƒ¡ãƒ¢"])
    å“åä¸€è¦§ = pd.DataFrame(columns=["å“å", "å˜ä½", "å˜ä¾¡", "å‚™è€ƒ"])
    return é¡§å®¢ä¸€è¦§, æ¡ˆä»¶ä¸€è¦§, å“åä¸€è¦§

def render_product_list_tab():
    """å•†å“ä¸€è¦§ã‚¿ãƒ–ã‚’è¡¨ç¤ºï¼ˆä¸€æ‹¬å‰Šé™¤ãƒ»è¨€èªçµ±åˆå¯¾å¿œç‰ˆï¼‰"""
    st.header("â‘¥ å•†å“ä¸€è¦§")

    # æ–°è¦å•†å“è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ã«é…ç½®ï¼‰
    if st.button("â• æ–°ã—ã„å•†å“ã‚’è¿½åŠ ", type="primary", key="add_product_header"):
        st.session_state["å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ‰"] = True
        st.rerun()

    # å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    products = load_products_json()

    if not products:
        st.info("å•†å“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return

    # å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
    if st.session_state.get("å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ‰", False):
        st.subheader("â• æ–°è¦å•†å“è¿½åŠ ")
        
        with st.form("å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ "):
            col1, col2 = st.columns(2)
            
            with col1:
                å“å = st.text_input("å“å *", placeholder="ä¾‹: åŒæ™‚é€šè¨³è€…æ´¾é£")
                å˜ä½ = st.selectbox("å˜ä½", ["å¼", "å", "æ–‡å­—", "ãƒ¯ãƒ¼ãƒ‰", "åˆ†", "åŠæ—¥", "æ—¥", "æ™‚é–“"])
            
            with col2:
                # min_valueã‚’å‰Šé™¤ã—ã¦è² ã®å€¤ã‚‚å…¥åŠ›å¯èƒ½ã«
                å˜ä¾¡ = st.number_input("å˜ä¾¡", step=100, help="å€¤å¼•ãã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                å‚™è€ƒ = st.text_input("å‚™è€ƒ", placeholder="ä¾‹: è‹±èªã€ä¸­å›½èªã€éŸ“å›½èªã‚‚åŒæ–™é‡‘")
            
            # è¨€èªçµ±åˆã®ãƒ’ãƒ³ãƒˆ
            st.info("ğŸ’¡ **è¨€èªçµ±åˆã®ã‚³ãƒ„:** åŒã˜ã‚µãƒ¼ãƒ“ã‚¹ã§è¨€èªãŒç•°ãªã‚‹å ´åˆã¯ã€å“åã‚’çµ±ä¸€ã—ã€Œå‚™è€ƒã€æ¬„ã«å¯¾å¿œè¨€èªã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨ã§å•†å“æ•°ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚æ˜ç´°å…¥åŠ›æ™‚ã«å…·ä½“çš„ãªè¨€èªã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚")
            
            col1, col2 = st.columns(2)
            
            with col1:
                if st.form_submit_button("âœ… å•†å“ã‚’è¿½åŠ ", type="primary"):
                    if not å“å:
                        st.error("å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                    else:
                        success, message = add_product_to_json(å“å, å˜ä½, å˜ä¾¡, å‚™è€ƒ)
                        if success:
                            st.success(message)
                            st.session_state["å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ‰"] = False
                            st.rerun()
                        else:
                            st.error(message)
            
            with col2:
                if st.form_submit_button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«"):
                    st.session_state["å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ‰"] = False
                    st.rerun()

    # å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    if st.session_state.get("å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰", False):
        ç·¨é›†ä¸­å•†å“ = st.session_state.get("ç·¨é›†ä¸­å•†å“")
        if ç·¨é›†ä¸­å•†å“:
            st.subheader(f"ğŸ“ å•†å“ç·¨é›†: {ç·¨é›†ä¸­å•†å“['å“å']}")
            
            with st.form("å•†å“ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ "):
                col1, col2 = st.columns(2)
                
                with col1:
                    å“å = st.text_input("å“å *", value=ç·¨é›†ä¸­å•†å“.get("å“å", ""))
                    å˜ä½é¸æŠè‚¢ = ["å¼", "å", "æ–‡å­—", "ãƒ¯ãƒ¼ãƒ‰", "åˆ†", "åŠæ—¥", "æ—¥", "æ™‚é–“"]
                    ç¾åœ¨ã®å˜ä½ = ç·¨é›†ä¸­å•†å“.get("å˜ä½", "å¼")
                    å˜ä½åˆæœŸindex = å˜ä½é¸æŠè‚¢.index(ç¾åœ¨ã®å˜ä½) if ç¾åœ¨ã®å˜ä½ in å˜ä½é¸æŠè‚¢ else 0
                    å˜ä½ = st.selectbox("å˜ä½", å˜ä½é¸æŠè‚¢, index=å˜ä½åˆæœŸindex)
                
                with col2:
                    # å˜ä¾¡ã®å®‰å…¨ãªå‡¦ç†ï¼ˆè² ã®å€¤ã‚‚è¨±å¯ï¼‰
                    try:
                        ç¾åœ¨ã®å˜ä¾¡ = ç·¨é›†ä¸­å•†å“.get("å˜ä¾¡", 0)
                        # æ•°å€¤ã§ãªã„å ´åˆã¯0ã«è¨­å®šã€è² ã®å€¤ã¯è¨±å¯
                        if not isinstance(ç¾åœ¨ã®å˜ä¾¡, (int, float)):
                            ç¾åœ¨ã®å˜ä¾¡ = 0
                        else:
                            ç¾åœ¨ã®å˜ä¾¡ = int(ç¾åœ¨ã®å˜ä¾¡)
                    except (ValueError, TypeError):
                        ç¾åœ¨ã®å˜ä¾¡ = 0
                    
                    # min_valueã‚’å‰Šé™¤ã—ã¦è² ã®å€¤ã‚‚å…¥åŠ›å¯èƒ½ã«
                    å˜ä¾¡ = st.number_input("å˜ä¾¡", step=100, value=ç¾åœ¨ã®å˜ä¾¡, help="å€¤å¼•ãã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                    å‚™è€ƒ = st.text_input("å‚™è€ƒ", value=ç·¨é›†ä¸­å•†å“.get("å‚™è€ƒ", ""))
                
                col1, col2 = st.columns(2)
                
                with col1:
                    if st.form_submit_button("âœ… å•†å“ã‚’æ›´æ–°", type="primary"):
                        if not å“å:
                            st.error("å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
                        else:
                            success, message = update_product_in_json(ç·¨é›†ä¸­å•†å“, å“å, å˜ä½, å˜ä¾¡, å‚™è€ƒ)
                            if success:
                                st.success(message)
                                st.session_state["å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰"] = False
                                st.session_state["ç·¨é›†ä¸­å•†å“"] = None
                                st.rerun()
                            else:
                                st.error(message)
                
                with col2:
                    if st.form_submit_button("âŒ ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«"):
                        st.session_state["å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰"] = False
                        st.session_state["ç·¨é›†ä¸­å•†å“"] = None
                        st.rerun()

    # ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼ˆå†…éƒ¨å‡¦ç†ã®ã¿ã€UIè¡¨ç¤ºãªã—ï¼‰
    ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“ = products.copy()

    st.divider()

    # ä¸¦ã³æ›¿ãˆæ“ä½œãƒ‘ãƒãƒ«ï¼ˆå˜ä¸€é¸æŠå¯¾å¿œç‰ˆï¼‰
    st.subheader("ğŸ”„ ä¸¦ã³æ›¿ãˆãƒ»æ“ä½œ")

    # è¤‡æ•°é¸æŠãƒ»ç§»å‹•ãƒ»å‰Šé™¤æ©Ÿèƒ½
    col1, col2, col3, col4, col5 = st.columns(5)

    with col1:
        if st.button("ğŸ’¾ ä¸¦ã³é †ã‚’ä¿å­˜", key="save_order", help="ç¾åœ¨ã®ä¸¦ã³é †ã§JSONã‚’ä¿å­˜"):
            if save_products_json(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“):
                st.success("âœ… ä¸¦ã³é †ã‚’ä¿å­˜ã—ã¾ã—ãŸ")
                st.rerun()
            else:
                st.error("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")

    with col2:
        # é¸æŠã—ãŸå•†å“ã‚’ä¸Šã«ç§»å‹•ï¼ˆ1å€‹ä»¥ä¸Šé¸æŠã•ã‚Œã¦ã„ã‚Œã°æœ‰åŠ¹ï¼‰
        é¸æŠå•†å“æ•° = len(st.session_state.get("selected_products", set()))
        if é¸æŠå•†å“æ•° >= 1:
            if st.button("â« é¸æŠå•†å“ã‚’ä¸Šã¸", key="move_selected_up", help=f"é¸æŠã—ãŸ{é¸æŠå•†å“æ•°}ä»¶ã®å•†å“ã‚’ä¸Šã«ç§»å‹•"):
                move_selected_products(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“, "up")
                st.rerun()
        else:
            st.button("â« é¸æŠå•†å“ã‚’ä¸Šã¸", disabled=True, help="å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„")

    with col3:
        # é¸æŠã—ãŸå•†å“ã‚’ä¸‹ã«ç§»å‹•ï¼ˆ1å€‹ä»¥ä¸Šé¸æŠã•ã‚Œã¦ã„ã‚Œã°æœ‰åŠ¹ï¼‰
        if é¸æŠå•†å“æ•° >= 1:
            if st.button("â¬ é¸æŠå•†å“ã‚’ä¸‹ã¸", key="move_selected_down", help=f"é¸æŠã—ãŸ{é¸æŠå•†å“æ•°}ä»¶ã®å•†å“ã‚’ä¸‹ã«ç§»å‹•"):
                move_selected_products(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“, "down")
                st.rerun()
        else:
            st.button("â¬ é¸æŠå•†å“ã‚’ä¸‹ã¸", disabled=True, help="å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„")

    with col4:
        # é¸æŠã—ãŸå•†å“ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆ1å€‹ä»¥ä¸Šé¸æŠã•ã‚Œã¦ã„ã‚Œã°æœ‰åŠ¹ï¼‰
        if é¸æŠå•†å“æ•° >= 1:
            if st.button(f"ğŸ—‘ï¸ é¸æŠå•†å“ã‚’å‰Šé™¤ ({é¸æŠå•†å“æ•°}ä»¶)", key="delete_selected", help=f"é¸æŠã—ãŸ{é¸æŠå•†å“æ•°}ä»¶ã®å•†å“ã‚’ä¸€æ‹¬å‰Šé™¤"):
                st.session_state["ä¸€æ‹¬å‰Šé™¤ç¢ºèª"] = True
                st.rerun()
        else:
            st.button("ğŸ—‘ï¸ é¸æŠå•†å“ã‚’å‰Šé™¤", disabled=True, help="å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„")

    with col5:
        # é¸æŠè§£é™¤
        if st.button("ğŸ”„ é¸æŠè§£é™¤", key="clear_selection"):
            st.session_state["selected_products"] = set()
            st.rerun()

    # ä¸€æ‹¬å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    if st.session_state.get("ä¸€æ‹¬å‰Šé™¤ç¢ºèª", False):
        é¸æŠå•†å“å = st.session_state.get("selected_products", set())
        st.error(f"âš ï¸ é¸æŠã—ãŸ{len(é¸æŠå•†å“å)}ä»¶ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")
        st.write("**å‰Šé™¤å¯¾è±¡:**")
        for å•†å“å in sorted(é¸æŠå•†å“å):
            st.write(f"- {å•†å“å}")
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("âœ… ã¯ã„ã€ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™", key="confirm_batch_delete", type="primary"):
                # ä¸€æ‹¬å‰Šé™¤å‡¦ç†ï¼ˆç›´æ¥å®Ÿè¡Œï¼‰
                try:
                    å…ƒãƒªã‚¹ãƒˆ = load_products_json()
                    é¸æŠå•†å“å = st.session_state.get("selected_products", set())
                    
                    if é¸æŠå•†å“å:
                        # é¸æŠã•ã‚ŒãŸå•†å“ã‚’é™¤å¤–
                        æ›´æ–°ãƒªã‚¹ãƒˆ = [p for p in å…ƒãƒªã‚¹ãƒˆ if p.get("å“å") not in é¸æŠå•†å“å]
                        å‰Šé™¤ä»¶æ•° = len(å…ƒãƒªã‚¹ãƒˆ) - len(æ›´æ–°ãƒªã‚¹ãƒˆ)
                        
                        if save_products_json(æ›´æ–°ãƒªã‚¹ãƒˆ):
                            st.success(f"âœ… {å‰Šé™¤ä»¶æ•°}ä»¶ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                        else:
                            st.error("âŒ ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ")
                    else:
                        st.warning("å‰Šé™¤å¯¾è±¡ã®å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“")
                        
                except Exception as e:
                    st.error(f"ä¸€æ‹¬å‰Šé™¤å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼: {e}")
                
                st.session_state["ä¸€æ‹¬å‰Šé™¤ç¢ºèª"] = False
                st.session_state["selected_products"] = set()
                st.rerun()
        with col2:
            if st.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key="cancel_batch_delete"):
                st.session_state["ä¸€æ‹¬å‰Šé™¤ç¢ºèª"] = False
                st.rerun()

    st.divider()

    if not ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“:
        st.info("å•†å“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return

    # CSSã§ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º
    st.markdown("""
    <style>
    .compact-table {
        font-size: 14px;
        line-height: 1.2;
    }
    .compact-table .stCheckbox {
        margin: 0;
        padding: 0;
    }
    </style>
    """, unsafe_allow_html=True)

    # é¸æŠçŠ¶æ…‹ã®åˆæœŸåŒ–
    if "selected_products" not in st.session_state:
        st.session_state["selected_products"] = set()

    # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆå›ºå®šï¼‰
    header_container = st.container()
    with header_container:
        header_col1, header_col2, header_col3, header_col4, header_col5, header_col6, header_col7 = st.columns([0.5, 0.5, 2.5, 0.8, 1.2, 1.5, 1.5])
        header_col1.write("**â˜‘ï¸**")
        header_col2.write("**No**")
        header_col3.write("**å“å**")
        header_col4.write("**å˜ä½**")
        header_col5.write("**å˜ä¾¡**")
        header_col6.write("**å‚™è€ƒ**")
        header_col7.write("**æ“ä½œ**")

    # å•†å“ä¸€è¦§ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è¡¨ç¤º
    for i, å•†å“ in enumerate(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“):
        with st.container():
            col1, col2, col3, col4, col5, col6, col7 = st.columns([0.5, 0.5, 2.5, 0.8, 1.2, 1.5, 1.5])
            
            # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            with col1:
                å•†å“ã‚­ãƒ¼ = å•†å“.get("å“å", f"å•†å“{i}")
                checked = st.checkbox("", 
                                    key=f"select_product_{i}",
                                    value=å•†å“ã‚­ãƒ¼ in st.session_state["selected_products"],
                                    label_visibility="collapsed")
                if checked:
                    st.session_state["selected_products"].add(å•†å“ã‚­ãƒ¼)
                else:
                    st.session_state["selected_products"].discard(å•†å“ã‚­ãƒ¼)
            
            # å•†å“æƒ…å ±è¡¨ç¤ºï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰
            col2.write(f"**{i + 1}**")
            col3.write(f"**{å•†å“.get('å“å', '')}**")
            col4.write(å•†å“.get("å˜ä½", ""))
            col5.write(f"Â¥{å•†å“.get('å˜ä¾¡', 0):,}")
            
            # å‚™è€ƒã®å®‰å…¨ãªè¡¨ç¤ºï¼ˆçŸ­ç¸®ç‰ˆï¼‰
            å‚™è€ƒ = å•†å“.get("å‚™è€ƒ", "")
            if å‚™è€ƒ and isinstance(å‚™è€ƒ, str):
                è¡¨ç¤ºå‚™è€ƒ = å‚™è€ƒ[:15] + "..." if len(å‚™è€ƒ) > 15 else å‚™è€ƒ
            else:
                è¡¨ç¤ºå‚™è€ƒ = str(å‚™è€ƒ)[:15] if å‚™è€ƒ else ""
            col6.write(è¡¨ç¤ºå‚™è€ƒ)
            
            # æ“ä½œãƒœã‚¿ãƒ³ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰
            with col7:
                op_col1, op_col2, op_col3, op_col4, op_col5 = st.columns(5)
                
                with op_col1:
                    if st.button("â†‘", key=f"up_{i}", help="ä¸Šã«ç§»å‹•"):
                        if i > 0:
                            move_single_product(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“, i, "up")
                            st.rerun()
                
                with op_col2:
                    if st.button("â†“", key=f"down_{i}", help="ä¸‹ã«ç§»å‹•"):
                        if i < len(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“) - 1:
                            move_single_product(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿å•†å“, i, "down")
                            st.rerun()
                
                with op_col3:
                    if st.button("ğŸ“", key=f"edit_{i}", help="ç·¨é›†"):
                        st.session_state["ç·¨é›†ä¸­å•†å“"] = å•†å“
                        st.session_state["å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰"] = True
                        # ç·¨é›†ç”»é¢ã«ç§»å‹•ï¼ˆãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
                        st.success(f"å•†å“ã€Œ{å•†å“['å“å']}ã€ã®ç·¨é›†ç”»é¢ã«ç§»å‹•ã—ã¾ã—ãŸ")
                        st.rerun()
                
                with op_col4:
                    if st.button("ğŸ“‹", key=f"add_{i}", help="æ˜ç´°è¿½åŠ "):
                        st.session_state["åæ˜ _å“å"] = å•†å“["å“å"]
                        st.session_state["åæ˜ _å˜ä½"] = å•†å“.get("å˜ä½", "å¼")
                        st.session_state["åæ˜ _å˜ä¾¡"] = int(å•†å“.get("å˜ä¾¡", 0))
                        st.session_state["åæ˜ _å‚™è€ƒ"] = å•†å“.get("å‚™è€ƒ", "")
                        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘£ æ˜ç´°æƒ…å ±ã‚’å…¥åŠ›"
                        st.success(f"å•†å“ã€Œ{å•†å“['å“å']}ã€ã‚’æ˜ç´°å…¥åŠ›ã«åæ˜ ã—ã¾ã—ãŸ")
                        st.rerun()
                
                with op_col5:
                    if st.button("ğŸ—‘ï¸", key=f"del_{i}", help="å‰Šé™¤"):
                        st.session_state[f"del_confirm_{i}"] = True
                        st.rerun()
            
            # å‰Šé™¤ç¢ºèªï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰
            if st.session_state.get(f"del_confirm_{i}", False):
                st.warning(f"ã€Œ{å•†å“['å“å']}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")
                conf_col1, conf_col2 = st.columns(2)
                with conf_col1:
                    if st.button("å‰Šé™¤", key=f"conf_del_{i}"):
                        # å•†å“ã‚’å‰Šé™¤
                        å…ƒãƒªã‚¹ãƒˆ = load_products_json()
                        å…ƒãƒªã‚¹ãƒˆ = [p for p in å…ƒãƒªã‚¹ãƒˆ if p.get("å“å") != å•†å“["å“å"]]
                        if save_products_json(å…ƒãƒªã‚¹ãƒˆ):
                            st.success(f"å•†å“ã€Œ{å•†å“['å“å']}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                            st.session_state[f"del_confirm_{i}"] = False
                            st.rerun()
                        else:
                            st.error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ")
                with conf_col2:
                    if st.button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key=f"cancel_del_{i}"):
                        st.session_state[f"del_confirm_{i}"] = False
                        st.rerun()

def load_customers_json():
    """é¡§å®¢JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€"""
    try:
        customers_json_file = os.path.join(DATA_FOLDER, "customers.json")
        if os.path.exists(customers_json_file):
            with open(customers_json_file, "r", encoding="utf-8") as f:
                data = json.load(f)
            return data if isinstance(data, list) else []
        else:
            return []
    except Exception as e:
        st.error(f"é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
        return []

def save_customers_json(customers_list):
    """é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
    try:
        os.makedirs(DATA_FOLDER, exist_ok=True)
        customers_json_file = os.path.join(DATA_FOLDER, "customers.json")
        with open(customers_json_file, "w", encoding="utf-8") as f:
            json.dump(customers_list, f, ensure_ascii=False, indent=2)
        return True
    except Exception as e:
        st.error(f"é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        return False

def add_customer_to_json(é¡§å®¢ä¼šç¤¾å, é¡§å®¢éƒ¨ç½²å, é¡§å®¢æ‹…å½“è€…, éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2):
    """æ–°è¦é¡§å®¢ã‚’JSONã«è¿½åŠ ï¼ˆä½æ‰€ç´°åˆ†åŒ–å¯¾å¿œãƒ»ä¿®æ­£ç‰ˆï¼‰"""
    customers = load_customers_json()

    # é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆä¼šç¤¾åã€éƒ¨ç½²åã€æ‹…å½“è€…ã®çµ„ã¿åˆã‚ã›ï¼‰
    for customer in customers:
        if (customer.get("é¡§å®¢ä¼šç¤¾å") == é¡§å®¢ä¼šç¤¾å and 
            customer.get("é¡§å®¢éƒ¨ç½²å") == é¡§å®¢éƒ¨ç½²å and 
            customer.get("é¡§å®¢æ‹…å½“è€…") == é¡§å®¢æ‹…å½“è€…):
            return False, "åŒã˜é¡§å®¢æƒ…å ±ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"

    # é¡§å®¢Noã®ç”Ÿæˆï¼ˆä¼šç¤¾åãƒ™ãƒ¼ã‚¹ï¼‰
    é¡§å®¢No = 1
    if customers:
        # åŒã˜ä¼šç¤¾åã®é¡§å®¢ã‚’æ¤œç´¢
        åŒä¸€ä¼šç¤¾ã®é¡§å®¢ = [c for c in customers if c.get("é¡§å®¢ä¼šç¤¾å") == é¡§å®¢ä¼šç¤¾å]
        if åŒä¸€ä¼šç¤¾ã®é¡§å®¢:
            # åŒä¸€ä¼šç¤¾ã®å ´åˆã¯æ—¢å­˜ã®é¡§å®¢Noã‚’ä½¿ç”¨
            é¡§å®¢No = åŒä¸€ä¼šç¤¾ã®é¡§å®¢[0].get("é¡§å®¢No", 1)
        else:
            # æ–°ã—ã„ä¼šç¤¾ã®å ´åˆã¯æœ€å¤§é¡§å®¢No + 1
            existing_companies = list(set([c.get("é¡§å®¢ä¼šç¤¾å") for c in customers]))
            é¡§å®¢No = len(existing_companies) + 1

    # çµ±åˆä½æ‰€ã®ç”Ÿæˆï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
    çµ±åˆä½æ‰€ = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()

    # æ–°è¦é¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼ˆä½æ‰€ç´°åˆ†åŒ–å¯¾å¿œãƒ»çµ±åˆä½æ‰€è¿½åŠ ï¼‰
    new_customer = {
        "é¡§å®¢No": é¡§å®¢No,
        "é¡§å®¢ä¼šç¤¾å": é¡§å®¢ä¼šç¤¾å,
        "é¡§å®¢éƒ¨ç½²å": é¡§å®¢éƒ¨ç½²å,
        "é¡§å®¢æ‹…å½“è€…": é¡§å®¢æ‹…å½“è€…,
        "éƒµä¾¿ç•ªå·": éƒµä¾¿ç•ªå·,
        "ä½æ‰€1": ä½æ‰€1,
        "ä½æ‰€2": ä½æ‰€2,
        "é¡§å®¢ä½æ‰€": çµ±åˆä½æ‰€,  # çµ±åˆä½æ‰€ã‚‚ä¿å­˜ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
        "ç™»éŒ²æ—¥": datetime.date.today().strftime("%Y-%m-%d")
    }

    customers.append(new_customer)
    
    # é¡§å®¢Noã¨ä¼šç¤¾åã§è‡ªå‹•ä¸¦ã³æ›¿ãˆ
    customers.sort(key=lambda x: (x.get("é¡§å®¢No", 999), x.get("é¡§å®¢ä¼šç¤¾å", ""), x.get("é¡§å®¢æ‹…å½“è€…", "")))

    if save_customers_json(customers):
        return True, f"é¡§å®¢ã€Œ{é¡§å®¢ä¼šç¤¾å}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸ"
    else:
        return False, "é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"

def render_customer_list_tab():
    """é¡§å®¢ä¸€è¦§ã‚¿ãƒ–ã‚’è¡¨ç¤ºï¼ˆä½æ‰€è¡¨ç¤ºä¿®æ­£ç‰ˆï¼‰"""
    st.header("â‘¤ é¡§å®¢ä¸€è¦§")

    # é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    customers = load_customers_json()

    if not customers:
        st.info("é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        
        st.divider()
        if st.button("æ–°ã—ã„é¡§å®¢ã‚’æ‰‹å‹•è¿½åŠ "):
            st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
            st.rerun()
        return

    # æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
    st.subheader("ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿")

    col1, col2 = st.columns(2)

    with col1:
        æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ = st.text_input("ğŸ” é¡§å®¢åã§æ¤œç´¢", placeholder="ä¼šç¤¾åãƒ»éƒ¨ç½²åãƒ»æ‹…å½“è€…åã‚’å…¥åŠ›", key="customer_search")

    with col2:
        # ä¼šç¤¾ã§ãƒ•ã‚£ãƒ«ã‚¿
        ä¼šç¤¾ãƒªã‚¹ãƒˆ = ["ã™ã¹ã¦"] + sorted(list(set([c["é¡§å®¢ä¼šç¤¾å"] for c in customers if c["é¡§å®¢ä¼šç¤¾å"]])))
        é¸æŠã•ã‚ŒãŸä¼šç¤¾ = st.selectbox("ä¼šç¤¾ã§çµã‚Šè¾¼ã¿", ä¼šç¤¾ãƒªã‚¹ãƒˆ, key="customer_company_filter")

    # ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢ = customers.copy()

    if é¸æŠã•ã‚ŒãŸä¼šç¤¾ != "ã™ã¹ã¦":
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢ = [c for c in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢ if c["é¡§å®¢ä¼šç¤¾å"] == é¸æŠã•ã‚ŒãŸä¼šç¤¾]

    if æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:
        ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢ = [
            c for c in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢ 
            if (æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ in c.get("é¡§å®¢ä¼šç¤¾å", "") or 
                æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ in c.get("é¡§å®¢éƒ¨ç½²å", "") or 
                æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ in c.get("é¡§å®¢æ‹…å½“è€…", ""))
        ]

    # é¡§å®¢Noã§ã‚½ãƒ¼ãƒˆï¼ˆä¼šç¤¾åã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ãŸã‚ï¼‰
    ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢.sort(key=lambda x: (x.get("é¡§å®¢No", 999), x.get("é¡§å®¢ä¼šç¤¾å", ""), x.get("é¡§å®¢æ‹…å½“è€…", "")))

    # ä¼šç¤¾åã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    ä¼šç¤¾åˆ¥é¡§å®¢ = {}
    for é¡§å®¢ in ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢:
        ä¼šç¤¾å = é¡§å®¢["é¡§å®¢ä¼šç¤¾å"]
        if ä¼šç¤¾å not in ä¼šç¤¾åˆ¥é¡§å®¢:
            ä¼šç¤¾åˆ¥é¡§å®¢[ä¼šç¤¾å] = []
        ä¼šç¤¾åˆ¥é¡§å®¢[ä¼šç¤¾å].append(é¡§å®¢)

    # çµ±è¨ˆæƒ…å ±
    st.subheader("ğŸ“Š çµ±è¨ˆæƒ…å ±")

    col1, col2, col3 = st.columns(3)

    with col1:
        st.metric("ç·é¡§å®¢æ•°", len(customers))

    with col2:
        ä¼šç¤¾æ•° = len(set([c["é¡§å®¢ä¼šç¤¾å"] for c in customers]))
        st.metric("ç™»éŒ²ä¼šç¤¾æ•°", ä¼šç¤¾æ•°)

    with col3:
        st.metric("è¡¨ç¤ºä»¶æ•°", len(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢))

    st.divider()

    # é¡§å®¢ä¸€è¦§ã®è¡¨ç¤ºï¼ˆä½æ‰€è¡¨ç¤ºä¿®æ­£ç‰ˆï¼‰
    st.subheader(f"ğŸ‘¥ é¡§å®¢ä¸€è¦§ ({len(ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢)}ä»¶)")

    if not ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é¡§å®¢:
        st.info("æ¡ä»¶ã«åˆè‡´ã™ã‚‹é¡§å®¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return

    # ä¼šç¤¾åˆ¥ã«è¡¨ç¤º
    å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿ = 0  # ä¸€æ„ã®ã‚­ãƒ¼ç”Ÿæˆç”¨
    
    for ä¼šç¤¾å, ä¼šç¤¾ã®é¡§å®¢ãƒªã‚¹ãƒˆ in ä¼šç¤¾åˆ¥é¡§å®¢.items():
        # ä¼šç¤¾åã‚’è¡¨ç¤º
        ä»£è¡¨é¡§å®¢ = ä¼šç¤¾ã®é¡§å®¢ãƒªã‚¹ãƒˆ[0]
        é¡§å®¢No = ä»£è¡¨é¡§å®¢.get("é¡§å®¢No", "æœªè¨­å®š")
        æ‹…å½“è€…æ•° = len(ä¼šç¤¾ã®é¡§å®¢ãƒªã‚¹ãƒˆ)
        
        # ä¼šç¤¾æƒ…å ±ã‚’expanderã§è¡¨ç¤º
        with st.expander(f"ğŸ¢ [{é¡§å®¢No}] {ä¼šç¤¾å} ({æ‹…å½“è€…æ•°}å)", expanded=False):
            
            # ä¼šç¤¾ã®ä½æ‰€æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆæ–°å½¢å¼å„ªå…ˆã€æ—§å½¢å¼ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            éƒµä¾¿ç•ªå· = ä»£è¡¨é¡§å®¢.get("éƒµä¾¿ç•ªå·", "")
            ä½æ‰€1 = ä»£è¡¨é¡§å®¢.get("ä½æ‰€1", "")
            ä½æ‰€2 = ä»£è¡¨é¡§å®¢.get("ä½æ‰€2", "")
            æ—§ä½æ‰€ = ä»£è¡¨é¡§å®¢.get("é¡§å®¢ä½æ‰€", "")
            
            # æ–°å½¢å¼ã®ä½æ‰€ãŒã‚ã‚Œã°è¡¨ç¤º
            if éƒµä¾¿ç•ªå· or ä½æ‰€1 or ä½æ‰€2:
                ä½æ‰€è¡¨ç¤º = f"{éƒµä¾¿ç•ªå·} {ä½æ‰€1} {ä½æ‰€2}".strip()
                st.info(f"ğŸ“ ä½æ‰€: {ä½æ‰€è¡¨ç¤º}")
            elif æ—§ä½æ‰€:
                # æ—§å½¢å¼ã®ä½æ‰€ã®ã¿ã‚ã‚‹å ´åˆ
                st.info(f"ğŸ“ ä½æ‰€: {æ—§ä½æ‰€} ï¼ˆæ—§å½¢å¼ï¼‰")
                st.warning("ğŸ’¡ ç·¨é›†ã—ã¦æ–°å½¢å¼ã«ç§»è¡Œã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™")
            else:
                st.warning("ğŸ“ ä½æ‰€ãŒæœªè¨­å®šã§ã™")
            
            # æ‹…å½“è€…ä¸€è¦§ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            st.write("**ğŸ‘¤ æ‹…å½“è€…ä¸€è¦§**")
            
            for i, é¡§å®¢ in enumerate(ä¼šç¤¾ã®é¡§å®¢ãƒªã‚¹ãƒˆ):
                å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿ += 1
                
                # æ‹…å½“è€…æƒ…å ±ã‚’ã‚³ãƒ³ãƒ†ãƒŠã§åŒºåˆ‡ã£ã¦è¡¨ç¤º
                with st.container():
                    st.write(f"**{i+1}. {é¡§å®¢['é¡§å®¢æ‹…å½“è€…']}** ({é¡§å®¢.get('é¡§å®¢éƒ¨ç½²å', 'éƒ¨ç½²æœªè¨­å®š')})")
                    
                    # è©³ç´°æƒ…å ±ã‚’æŠ˜ã‚ŠãŸãŸã¿å½¢å¼ã§è¡¨ç¤ºï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä½¿ç”¨ï¼‰
                    è©³ç´°è¡¨ç¤ºã‚­ãƒ¼ = f"é¡§å®¢è©³ç´°_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"
                    è©³ç´°è¡¨ç¤ºçŠ¶æ…‹ = st.session_state.get(è©³ç´°è¡¨ç¤ºã‚­ãƒ¼, False)
                    
                    col1, col2 = st.columns([1, 6])
                    with col1:
                        if st.button("ğŸ“‹ è©³ç´°", key=f"show_detail_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"):
                            st.session_state[è©³ç´°è¡¨ç¤ºã‚­ãƒ¼] = not è©³ç´°è¡¨ç¤ºçŠ¶æ…‹
                            st.rerun()
                    
                    with col2:
                        # æ“ä½œãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã§é…ç½®
                        btn_col1, btn_col2, btn_col3 = st.columns(3)
                        
                        with btn_col1:
                            if st.button("ğŸ“ ç·¨é›†", key=f"edit_customer_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"):
                                st.session_state["ç·¨é›†ä¸­é¡§å®¢"] = é¡§å®¢
                                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
                                st.rerun()
                        
                        with btn_col2:
                            if st.button("ğŸ“‹ æ¡ˆä»¶ä½œæˆ", key=f"create_project_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"):
                                # é¡§å®¢æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¨­å®šï¼ˆä½æ‰€ç§»è¡Œå¯¾å¿œï¼‰
                                éƒµä¾¿ç•ªå· = é¡§å®¢.get("éƒµä¾¿ç•ªå·", "")
                                ä½æ‰€1 = é¡§å®¢.get("ä½æ‰€1", "")
                                ä½æ‰€2 = é¡§å®¢.get("ä½æ‰€2", "")
                                
                                # æ–°å½¢å¼ã®ä½æ‰€ãŒãªã„å ´åˆã¯æ—§ä½æ‰€ã‚’åˆ†å‰²
                                if not (éƒµä¾¿ç•ªå· or ä½æ‰€1 or ä½æ‰€2):
                                    æ—§ä½æ‰€ = é¡§å®¢.get("é¡§å®¢ä½æ‰€", "")
                                    if æ—§ä½æ‰€:
                                        from estimate_excel_writer import parse_address
                                        éƒµä¾¿ç•ªå·, ä½æ‰€1, ä½æ‰€2 = parse_address(æ—§ä½æ‰€)
                                
                                st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å"] = é¡§å®¢["é¡§å®¢ä¼šç¤¾å"]
                                st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å"] = é¡§å®¢.get("é¡§å®¢éƒ¨ç½²å", "")
                                st.session_state["é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…"] = é¡§å®¢["é¡§å®¢æ‹…å½“è€…"]
                                st.session_state["é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·"] = éƒµä¾¿ç•ªå·
                                st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€1"] = ä½æ‰€1
                                st.session_state["é¸æŠã•ã‚ŒãŸä½æ‰€2"] = ä½æ‰€2
                                st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›"
                                st.success(f"é¡§å®¢ã€Œ{é¡§å®¢['é¡§å®¢ä¼šç¤¾å']} - {é¡§å®¢['é¡§å®¢æ‹…å½“è€…']}ã€ã§æ¡ˆä»¶ä½œæˆã‚’é–‹å§‹ã—ã¾ã™")
                                st.rerun()
                        
                        with btn_col3:
                            if st.button("ğŸ—‘ï¸ å‰Šé™¤", key=f"delete_customer_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"):
                                st.session_state[f"å‰Šé™¤ç¢ºèª_é¡§å®¢_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"] = True
                                st.rerun()
                    
                    # è©³ç´°æƒ…å ±ã®è¡¨ç¤ºï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã§åˆ¶å¾¡ã€ä½æ‰€è¡¨ç¤ºä¿®æ­£ï¼‰
                    if st.session_state.get(è©³ç´°è¡¨ç¤ºã‚­ãƒ¼, False):
                        detail_col1, detail_col2 = st.columns(2)
                        
                        with detail_col1:
                            st.write(f"**é¡§å®¢No:** {é¡§å®¢.get('é¡§å®¢No', 'æœªè¨­å®š')}")
                            st.write(f"**ä¼šç¤¾å:** {é¡§å®¢['é¡§å®¢ä¼šç¤¾å']}")
                            st.write(f"**éƒ¨ç½²å:** {é¡§å®¢.get('é¡§å®¢éƒ¨ç½²å', 'æœªè¨­å®š')}")
                        
                        with detail_col2:
                            # ä½æ‰€ã®è©³ç´°è¡¨ç¤ºï¼ˆæ–°å½¢å¼å„ªå…ˆï¼‰
                            å€‹åˆ¥éƒµä¾¿ç•ªå· = é¡§å®¢.get("éƒµä¾¿ç•ªå·", "")
                            å€‹åˆ¥ä½æ‰€1 = é¡§å®¢.get("ä½æ‰€1", "")
                            å€‹åˆ¥ä½æ‰€2 = é¡§å®¢.get("ä½æ‰€2", "")
                            å€‹åˆ¥æ—§ä½æ‰€ = é¡§å®¢.get("é¡§å®¢ä½æ‰€", "")
                            
                            if å€‹åˆ¥éƒµä¾¿ç•ªå· or å€‹åˆ¥ä½æ‰€1 or å€‹åˆ¥ä½æ‰€2:
                                å€‹åˆ¥ä½æ‰€è¡¨ç¤º = f"{å€‹åˆ¥éƒµä¾¿ç•ªå·} {å€‹åˆ¥ä½æ‰€1} {å€‹åˆ¥ä½æ‰€2}".strip()
                                st.write(f"**ä½æ‰€:** {å€‹åˆ¥ä½æ‰€è¡¨ç¤º}")
                            elif å€‹åˆ¥æ—§ä½æ‰€:
                                st.write(f"**ä½æ‰€:** {å€‹åˆ¥æ—§ä½æ‰€} ï¼ˆæ—§å½¢å¼ï¼‰")
                            else:
                                st.write("**ä½æ‰€:** æœªè¨­å®š")
                            
                            st.write(f"**ç™»éŒ²æ—¥:** {é¡§å®¢.get('ç™»éŒ²æ—¥', 'æœªè¨­å®š')}")
                            if é¡§å®¢.get("æ›´æ–°æ—¥"):
                                st.write(f"**æ›´æ–°æ—¥:** {é¡§å®¢['æ›´æ–°æ—¥']}")
                    
                    # å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                    if st.session_state.get(f"å‰Šé™¤ç¢ºèª_é¡§å®¢_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}", False):
                        st.warning(f"é¡§å®¢ã€Œ{é¡§å®¢['é¡§å®¢ä¼šç¤¾å']} - {é¡§å®¢['é¡§å®¢æ‹…å½“è€…']}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")
                        confirm_col1, confirm_col2 = st.columns(2)
                        
                        with confirm_col1:
                            if st.button("ã¯ã„ã€å‰Šé™¤ã—ã¾ã™", key=f"confirm_delete_customer_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"):
                                # é¡§å®¢ã‚’å‰Šé™¤
                                customers_updated = load_customers_json()  # æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                                å‰Šé™¤å¯¾è±¡ = None
                                for customer in customers_updated:
                                    if (customer.get("é¡§å®¢ä¼šç¤¾å") == é¡§å®¢["é¡§å®¢ä¼šç¤¾å"] and 
                                        customer.get("é¡§å®¢éƒ¨ç½²å") == é¡§å®¢.get("é¡§å®¢éƒ¨ç½²å", "") and 
                                        customer.get("é¡§å®¢æ‹…å½“è€…") == é¡§å®¢["é¡§å®¢æ‹…å½“è€…"]):
                                        å‰Šé™¤å¯¾è±¡ = customer
                                        break
                                
                                if å‰Šé™¤å¯¾è±¡:
                                    customers_updated.remove(å‰Šé™¤å¯¾è±¡)
                                    if save_customers_json(customers_updated):
                                        st.success(f"é¡§å®¢ã€Œ{é¡§å®¢['é¡§å®¢ä¼šç¤¾å']} - {é¡§å®¢['é¡§å®¢æ‹…å½“è€…']}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                                        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                                        keys_to_clean = [key for key in st.session_state.keys() 
                                                    if key.startswith(f"å‰Šé™¤ç¢ºèª_é¡§å®¢_")]
                                        for key in keys_to_clean:
                                            if key in st.session_state:
                                                del st.session_state[key]
                                        st.rerun()
                                    else:
                                        st.error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ")
                                else:
                                    st.error("å‰Šé™¤å¯¾è±¡ã®é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
                        
                        with confirm_col2:
                            if st.button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key=f"cancel_delete_customer_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"):
                                st.session_state[f"å‰Šé™¤ç¢ºèª_é¡§å®¢_{å…¨ä½“ã‚«ã‚¦ãƒ³ã‚¿}"] = False
                                st.rerun()
                    
                    # åŒºåˆ‡ã‚Šç·š
                    if i < len(ä¼šç¤¾ã®é¡§å®¢ãƒªã‚¹ãƒˆ) - 1:
                        st.write("---")

    # æ–°è¦é¡§å®¢è¿½åŠ ãƒœã‚¿ãƒ³
    st.divider()
    if st.button("â• æ–°ã—ã„é¡§å®¢ã‚’è¿½åŠ ", type="primary"):
        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
        st.rerun()

# å•†å“ãƒ‡ãƒ¼ã‚¿ã®JSONç®¡ç†é–¢æ•°
def load_products_json():
    """å•†å“JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€"""
    try:
        products_json_file = os.path.join(DATA_FOLDER, "products.json")
        if os.path.exists(products_json_file):
            with open(products_json_file, "r", encoding="utf-8") as f:
                data = json.load(f)
            return data if isinstance(data, list) else []
        else:
            return []
    except Exception as e:
        st.error(f"å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
        return []

def save_products_json(products_list):
    """å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
    try:
        os.makedirs(DATA_FOLDER, exist_ok=True)
        products_json_file = os.path.join(DATA_FOLDER, "products.json")
        with open(products_json_file, "w", encoding="utf-8") as f:
            json.dump(products_list, f, ensure_ascii=False, indent=2)
        return True
    except Exception as e:
        st.error(f"å•†å“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        return False

def add_product_to_json(å“å, å˜ä½, å˜ä¾¡, å‚™è€ƒ):
    """æ–°è¦å•†å“ã‚’JSONã«è¿½åŠ ï¼ˆç§»è¡Œå…ƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤ç‰ˆï¼‰"""
    products = load_products_json()

    # é‡è¤‡ãƒã‚§ãƒƒã‚¯
    for product in products:
        if product.get("å“å") == å“å:
            return False, "åŒã˜å•†å“åãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"

    # æ–°è¦å•†å“ãƒ‡ãƒ¼ã‚¿ï¼ˆç§»è¡Œå…ƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ï¼‰
    new_product = {
        "å“å": å“å,
        "å˜ä½": å˜ä½,
        "å˜ä¾¡": float(å˜ä¾¡),
        "å‚™è€ƒ": å‚™è€ƒ,
        "ç™»éŒ²æ—¥": datetime.date.today().strftime("%Y-%m-%d")
    }

    products.append(new_product)

    if save_products_json(products):
        return True, f"å•†å“ã€Œ{å“å}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸ"
    else:
        return False, "å•†å“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"

def update_product_in_json(å…ƒå•†å“ãƒ‡ãƒ¼ã‚¿, å“å, å˜ä½, å˜ä¾¡, å‚™è€ƒ):
    """å•†å“æƒ…å ±ã‚’JSONã§æ›´æ–°"""
    try:
        products = load_products_json()
        
        # å…ƒã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
        for i, product in enumerate(products):
            if product.get("å“å") == å…ƒå•†å“ãƒ‡ãƒ¼ã‚¿["å“å"]:
                
                # é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ä»¥å¤–ã§åŒã˜å•†å“åï¼‰
                if å“å != å…ƒå•†å“ãƒ‡ãƒ¼ã‚¿["å“å"]:  # å•†å“åãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
                    for j, other_product in enumerate(products):
                        if i != j and other_product.get("å“å") == å“å:
                            return False, "åŒã˜å•†å“åãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
                
                # å•†å“æƒ…å ±ã‚’æ›´æ–°
                products[i]["å“å"] = å“å
                products[i]["å˜ä½"] = å˜ä½
                products[i]["å˜ä¾¡"] = float(å˜ä¾¡)
                products[i]["å‚™è€ƒ"] = å‚™è€ƒ
                products[i]["æ›´æ–°æ—¥"] = datetime.date.today().strftime("%Y-%m-%d")
                
                if save_products_json(products):
                    return True, f"å•†å“ã€Œ{å“å}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
                else:
                    return False, "å•†å“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
        
        return False, "æ›´æ–°å¯¾è±¡ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        
    except Exception as e:
        return False, f"æ›´æ–°å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒœã‚¿ãƒ³ä¿®æ­£ç‰ˆï¼ˆæ–°è¦æ¡ˆä»¶ä½œæˆãƒœã‚¿ãƒ³ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ç§»å‹•ï¼‰
def render_sidebar_status():
    """ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºï¼ˆåˆ†é¡é …ç›®é™¤å¤–ç‰ˆï¼‰"""
    with st.sidebar:
        st.header("ç¾åœ¨ã®çŠ¶æ…‹")
    
        # é¡§å®¢æƒ…å ±
        st.subheader("é¡§å®¢æƒ…å ±")
        é¡§å®¢ä¼šç¤¾å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "æœªé¸æŠ")
        é¡§å®¢éƒ¨ç½²å = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å", "æœªé¸æŠ")
        é¡§å®¢æ‹…å½“è€… = st.session_state.get("é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…", "æœªé¸æŠ")
        
        st.write(f"**ä¼šç¤¾å:** {é¡§å®¢ä¼šç¤¾å}")
        st.write(f"**éƒ¨ç½²å:** {é¡§å®¢éƒ¨ç½²å}")
        st.write(f"**æ‹…å½“è€…:** {é¡§å®¢æ‹…å½“è€…}")
        
        # æ¡ˆä»¶æƒ…å ±
        st.subheader("æ¡ˆä»¶æƒ…å ±")
        æ¡ˆä»¶å = st.session_state.get("æ¡ˆä»¶å", "æœªå…¥åŠ›")
        è¦‹ç©No = st.session_state.get("è¦‹ç©No", "æœªç”Ÿæˆ")
        ç™ºè¡Œæ—¥ = st.session_state.get("ç™ºè¡Œæ—¥", "æœªè¨­å®š")
        
        st.write(f"**æ¡ˆä»¶å:** {æ¡ˆä»¶å}")
        st.write(f"**è¦‹ç©No:** {è¦‹ç©No}")
        st.write(f"**ç™ºè¡Œæ—¥:** {ç™ºè¡Œæ—¥}")
        
        # æ˜ç´°æƒ…å ±ï¼ˆåˆ†é¡é …ç›®ã‚’é™¤å¤–ã—ã¦è¨ˆç®—ï¼‰
        st.subheader("æ˜ç´°æƒ…å ±")
        å…¨æ˜ç´°ãƒªã‚¹ãƒˆ = st.session_state.get("æ˜ç´°ãƒªã‚¹ãƒˆ", [])
        é€šå¸¸æ˜ç´°ãƒªã‚¹ãƒˆ = [item for item in å…¨æ˜ç´°ãƒªã‚¹ãƒˆ if not item.get("åˆ†é¡", False)]
        
        æ˜ç´°æ•° = len(é€šå¸¸æ˜ç´°ãƒªã‚¹ãƒˆ)
        åˆè¨ˆé‡‘é¡ = 0
        for item in é€šå¸¸æ˜ç´°ãƒªã‚¹ãƒˆ:
            é‡‘é¡ = item.get("é‡‘é¡", 0)
            if isinstance(é‡‘é¡, (int, float)):
                åˆè¨ˆé‡‘é¡ += é‡‘é¡
        
        st.write(f"**æ˜ç´°æ•°:** {æ˜ç´°æ•°}ä»¶")
        st.write(f"**åˆè¨ˆé‡‘é¡:** Â¥{åˆè¨ˆé‡‘é¡:,}")

        # æ“ä½œãƒœã‚¿ãƒ³
        st.subheader("æ“ä½œ")
        if st.button("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ", key="reset_button"):
            st.session_state["ãƒªã‚»ãƒƒãƒˆç¢ºèªä¸­"] = True

        # æ–°è¦æ¡ˆä»¶ä½œæˆãƒœã‚¿ãƒ³ã‚’ã“ã“ã«ç§»å‹•
        if st.button("â• æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆ", type="primary", key="create_new_project_sidebar"):
            # ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
            reset_all_data()
            st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›"
            st.success("æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚")
            st.rerun()

        # ç¢ºèªUIã®è¡¨ç¤ºåˆ¶å¾¡
        if st.session_state.get("ãƒªã‚»ãƒƒãƒˆç¢ºèªä¸­", False):
            st.warning("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")
            col1, col2 = st.columns([1, 1])
            with col1:
                if st.button("ã¯ã„", key="confirm_reset"):
                    reset_all_data()
                    st.session_state["ãƒªã‚»ãƒƒãƒˆç¢ºèªä¸­"] = False
                    st.rerun()
            with col2:
                if st.button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«", key="cancel_reset"):
                    st.session_state["ãƒªã‚»ãƒƒãƒˆç¢ºèªä¸­"] = False
        
        if æ˜ç´°æ•° > 0 and st.button("è¦‹ç©æ›¸ã‚’å‡ºåŠ›"):
            export_estimate()

def reset_all_data():
    """ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç™ºè¡Œæ—¥è¿½åŠ ç‰ˆï¼‰"""
    keys_to_reset = [
        "æ˜ç´°ãƒªã‚¹ãƒˆ", "ç·¨é›†å¯¾è±¡", "æ¡ˆä»¶å", "è¦‹ç©No", "ç™ºè¡Œæ—¥",  # â† ç™ºè¡Œæ—¥ã‚’è¿½åŠ 
        "é¸æŠã•ã‚ŒãŸé¡§å®¢ä¼šç¤¾å", "é¸æŠã•ã‚ŒãŸé¡§å®¢éƒ¨ç½²å", "é¸æŠã•ã‚ŒãŸé¡§å®¢æ‹…å½“è€…", "é¸æŠã•ã‚ŒãŸé¡§å®¢ä½æ‰€",
        "é¸æŠã•ã‚ŒãŸéƒµä¾¿ç•ªå·", "é¸æŠã•ã‚ŒãŸä½æ‰€1", "é¸æŠã•ã‚ŒãŸä½æ‰€2",
        "ç™ºè¡Œè€…å", "å‚™è€ƒ", "ãƒ¡ãƒ¢", "çŠ¶æ³", "å—æ³¨æ—¥", "ç´å“æ—¥",
        "å£²ä¸Šé¡", "ä»•å…¥é¡", "ç²—åˆ©", "ç²—åˆ©ç‡", "å£²ä¸Šé¡è‡ªå‹•æ›´æ–°", "æ‹…å½“éƒ¨ç½²"
    ]

    # å…¥åŠ›ä¸­ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢ï¼ˆä½æ‰€é–¢é€£ã‚‚è¿½åŠ ï¼‰
    input_keys_to_clear = [
        "å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾åé¸æŠ", "å…¥åŠ›ä¸­_é¡§å®¢ä¼šç¤¾å", "å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…é¸æŠ",
        "å…¥åŠ›ä¸­_é¡§å®¢æ‹…å½“è€…", "å…¥åŠ›ä¸­_é¡§å®¢éƒ¨ç½²å", "å…¥åŠ›ä¸­_é¡§å®¢ä½æ‰€",
        "å…¥åŠ›ä¸­_éƒµä¾¿ç•ªå·", "å…¥åŠ›ä¸­_ä½æ‰€1", "å…¥åŠ›ä¸­_ä½æ‰€2",  # ä½æ‰€ç´°åˆ†åŒ–å…¥åŠ›ä¸­ãƒ‡ãƒ¼ã‚¿ã‚‚è¿½åŠ 
        "å…¥åŠ›ä¸­_å“å", "å…¥åŠ›ä¸­_æ•°é‡", "å…¥åŠ›ä¸­_å˜ä½", "å…¥åŠ›ä¸­_å˜ä¾¡", "å…¥åŠ›ä¸­_å‚™è€ƒ",
        "å‰å›é¸æŠå“å", "ãƒªã‚»ãƒƒãƒˆç¢ºèªä¸­", "ç·¨é›†ä¸­é¡§å®¢", "ä½æ‰€è£œå®Œæ¸ˆã¿"  # ä½æ‰€è£œå®Œãƒ•ãƒ©ã‚°ã‚‚è¿½åŠ 
    ]

    # å‰Šé™¤ç¢ºèªãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢
    å‰Šé™¤ç¢ºèªKeys = [key for key in st.session_state.keys() if key.startswith("å‰Šé™¤ç¢ºèª_")]

    for key in keys_to_reset:
        if key == "æ˜ç´°ãƒªã‚¹ãƒˆ":
            st.session_state[key] = []
        elif key == "ç™ºè¡Œæ—¥":
            st.session_state[key] = None  # â† ã“ã“ã‚’ä¿®æ­£ï¼ˆdatetime.date.today() ã‹ã‚‰ None ã«å¤‰æ›´ï¼‰
        elif key == "ç™ºè¡Œè€…å":
            st.session_state[key] = ISSUER_LIST[0]
        elif key == "å£²ä¸Šé¡è‡ªå‹•æ›´æ–°":
            st.session_state[key] = True
        elif key == "çŠ¶æ³":
            st.session_state[key] = "è¦‹ç©ä¸­"
        elif key in ["å—æ³¨æ—¥", "ç´å“æ—¥"]:
            st.session_state[key] = None
        elif key in ["å£²ä¸Šé¡", "ä»•å…¥é¡", "ç²—åˆ©"]:
            st.session_state[key] = 0
        elif key == "ç²—åˆ©ç‡":
            st.session_state[key] = 0
        else:
            st.session_state[key] = ""

    # å…¥åŠ›ä¸­ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    for key in input_keys_to_clear:
        if key in st.session_state:
            del st.session_state[key]

    # å‰Šé™¤ç¢ºèªãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤
    for key in å‰Šé™¤ç¢ºèªKeys:
        if key in st.session_state:
            del st.session_state[key]

    # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã‚’ç¢ºå®Ÿã«è¨­å®š
    st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = "â‘  æ¡ˆä»¶ä¸€è¦§"
    st.success("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ")

def apply_custom_css():
    """ã‚«ã‚¹ã‚¿ãƒ CSSã‚’é©ç”¨ã—ã¦è¡¨ç¤ºã‚’æ”¹å–„"""
    st.markdown("""
    <style>
    /* expanderãƒ˜ãƒƒãƒ€ãƒ¼ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’æ‹¡å¤§ */
    .streamlit-expanderHeader {
        font-size: 16px !important;
        font-weight: bold !important;
        line-height: 1.4 !important;
    }
    
    /* expanderãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
    .streamlit-expanderHeader p {
        font-size: 16px !important;
        margin: 0 !important;
    }
    
    /* expanderã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
    .streamlit-expanderHeader svg {
        width: 20px !important;
        height: 20px !important;
    }
    
    /* ä¸€èˆ¬çš„ãªãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ãã */
    .stMarkdown p {
        font-size: 15px !important;
    }
    
    /* ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºã®æ”¹å–„ */
    .metric-container {
        background-color: #f0f2f6;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 0.5rem 0;
    }
    </style>
    """, unsafe_allow_html=True)

# ãƒ¡ã‚¤ãƒ³é–¢æ•°ã®ã‚¿ãƒ–é¸æŠè‚¢ã‚’æ›´æ–°
def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å®‰å®šåŒ–ç‰ˆï¼‰"""
    # ã‚«ã‚¹ã‚¿ãƒ CSSã®é©ç”¨
    apply_custom_css()
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
    init_session_state()

    # ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆJSONã‹ã‚‰ï¼‰
    é¡§å®¢ä¸€è¦§, _, å“åä¸€è¦§ = load_data()
        
    # ã‚¿ãƒ–ã®é¸æŠ
    ã‚¿ãƒ–é¸æŠè‚¢ = ["â‘  æ¡ˆä»¶ä¸€è¦§", "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›", "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›", "â‘£ æ˜ç´°æƒ…å ±ã‚’å…¥åŠ›", "â‘¤ é¡§å®¢ä¸€è¦§", "â‘¥ å•†å“ä¸€è¦§"]

    # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ãŒé¸æŠè‚¢ã«ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
    ç¾åœ¨ã®ã‚¿ãƒ– = st.session_state.get("ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–", "â‘  æ¡ˆä»¶ä¸€è¦§")
    if ç¾åœ¨ã®ã‚¿ãƒ– not in ã‚¿ãƒ–é¸æŠè‚¢:
        ç¾åœ¨ã®ã‚¿ãƒ– = "â‘  æ¡ˆä»¶ä¸€è¦§"
        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = ç¾åœ¨ã®ã‚¿ãƒ–

    # ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¨åŒæœŸ
    ã‚¿ãƒ– = st.radio(
        "æ‰‹é †ã‚’é¸æŠã—ã¦ãã ã•ã„",
        ã‚¿ãƒ–é¸æŠè‚¢,
        index=ã‚¿ãƒ–é¸æŠè‚¢.index(ç¾åœ¨ã®ã‚¿ãƒ–),
        key="main_tab_radio"
    )

    # ã‚¿ãƒ–ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
    if ã‚¿ãƒ– != st.session_state.get("ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"):
        st.session_state["ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–"] = ã‚¿ãƒ–

    # å„ã‚¿ãƒ–ã®å‡¦ç†
    if ã‚¿ãƒ– == "â‘  æ¡ˆä»¶ä¸€è¦§":
        render_project_list_tab()
    elif ã‚¿ãƒ– == "â‘¡ é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›":
        render_customer_tab(é¡§å®¢ä¸€è¦§)
    elif ã‚¿ãƒ– == "â‘¢ æ¡ˆä»¶æƒ…å ±ã‚’å…¥åŠ›":
        render_project_tab()
    elif ã‚¿ãƒ– == "â‘£ æ˜ç´°æƒ…å ±ã‚’å…¥åŠ›":
        render_detail_tab(å“åä¸€è¦§)
    elif ã‚¿ãƒ– == "â‘¤ é¡§å®¢ä¸€è¦§":
        render_customer_list_tab()
    elif ã‚¿ãƒ– == "â‘¥ å•†å“ä¸€è¦§":
        render_product_list_tab()

    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    render_sidebar_status()

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
if __name__ == "__main__":
    main()

# --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªå‡¦ç† ---
def main_app():
    st.success(f"ã‚ˆã†ã“ãã€{st.session_state['username']} ã•ã‚“ï¼")

    if st.button("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"):
        st.session_state["logged_in"] = False
        st.session_state["username"] = ""
        st.experimental_rerun()
    
    # ã“ã“ã«æ—¢å­˜ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆinit_session_state()ã€œä»¥é™ï¼‰ã‚’ç¶šã‘ã¦è¨˜è¿°
    init_session_state()
    é¡§å®¢ä¸€è¦§, æ¡ˆä»¶ä¸€è¦§, å“åä¸€è¦§ = load_data()

    # ä»¥é™ã®æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ã“ã®é–¢æ•°å†…ã«å…¥ã‚Œã¦ã„ã

# --- å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ ---
if st.session_state["logged_in"]:
    main_app()
else:
    login()